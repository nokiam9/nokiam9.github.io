<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha256-CTSx/A06dm1B063156EVh15m6Y67pAjZZaQc89LLSrU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"nokiam9.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.18.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.json","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="长期以来 Apple 公司有两条数据安全的技术演进路线，iPhone 和 iPad 等智能终端设备使用称为数据保护（Data Protection）的文件加密方法，基于Intel的Mac设备通过文件保险箱（FileVault）的宗卷加密技术。  MacOS 和 iOS 都是基于 FreeBSD 发展而来，基础架构是一个多用户的操作系统，但 iPhone 等作为个人化（无需支持多用户）的终端设备，存">
<meta property="og:type" content="article">
<meta property="og:title" content="Apple数据保护技术专题之一：基础架构">
<meta property="og:url" content="https://nokiam9.github.io/2022/11/13/Apple%E6%95%B0%E6%8D%AE%E4%BF%9D%E6%8A%A4%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98%E4%B9%8B%E4%B8%80%EF%BC%9A%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84/index.html">
<meta property="og:site_name" content="Alex的技术博客">
<meta property="og:description" content="长期以来 Apple 公司有两条数据安全的技术演进路线，iPhone 和 iPad 等智能终端设备使用称为数据保护（Data Protection）的文件加密方法，基于Intel的Mac设备通过文件保险箱（FileVault）的宗卷加密技术。  MacOS 和 iOS 都是基于 FreeBSD 发展而来，基础架构是一个多用户的操作系统，但 iPhone 等作为个人化（无需支持多用户）的终端设备，存">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://nokiam9.github.io/2022/11/13/Apple%E6%95%B0%E6%8D%AE%E4%BF%9D%E6%8A%A4%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98%E4%B9%8B%E4%B8%80%EF%BC%9A%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84/KEY-ARCH.jpg">
<meta property="og:image" content="https://nokiam9.github.io/2022/11/13/Apple%E6%95%B0%E6%8D%AE%E4%BF%9D%E6%8A%A4%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98%E4%B9%8B%E4%B8%80%EF%BC%9A%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84/daemon.png">
<meta property="og:image" content="https://nokiam9.github.io/2022/11/13/Apple%E6%95%B0%E6%8D%AE%E4%BF%9D%E6%8A%A4%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98%E4%B9%8B%E4%B8%80%EF%BC%9A%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84/filevault-on.png">
<meta property="og:image" content="https://nokiam9.github.io/2022/11/13/Apple%E6%95%B0%E6%8D%AE%E4%BF%9D%E6%8A%A4%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98%E4%B9%8B%E4%B8%80%EF%BC%9A%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84/filevault-off.png">
<meta property="og:image" content="https://nokiam9.github.io/2022/11/13/Apple%E6%95%B0%E6%8D%AE%E4%BF%9D%E6%8A%A4%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98%E4%B9%8B%E4%B8%80%EF%BC%9A%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84/SKP.png">
<meta property="og:image" content="https://nokiam9.github.io/2022/11/13/Apple%E6%95%B0%E6%8D%AE%E4%BF%9D%E6%8A%A4%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98%E4%B9%8B%E4%B8%80%EF%BC%9A%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84/mac-boot.png">
<meta property="article:published_time" content="2022-11-13T06:34:06.000Z">
<meta property="article:modified_time" content="2023-10-15T15:01:42.794Z">
<meta property="article:author" content="Alex Sun">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://nokiam9.github.io/2022/11/13/Apple%E6%95%B0%E6%8D%AE%E4%BF%9D%E6%8A%A4%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98%E4%B9%8B%E4%B8%80%EF%BC%9A%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84/KEY-ARCH.jpg">


<link rel="canonical" href="https://nokiam9.github.io/2022/11/13/Apple%E6%95%B0%E6%8D%AE%E4%BF%9D%E6%8A%A4%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98%E4%B9%8B%E4%B8%80%EF%BC%9A%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://nokiam9.github.io/2022/11/13/Apple%E6%95%B0%E6%8D%AE%E4%BF%9D%E6%8A%A4%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98%E4%B9%8B%E4%B8%80%EF%BC%9A%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84/","path":"2022/11/13/Apple数据保护技术专题之一：基础架构/","title":"Apple数据保护技术专题之一：基础架构"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Apple数据保护技术专题之一：基础架构 | Alex的技术博客</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Alex的技术博客</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E6%96%87%E4%BB%B6%E6%95%B0%E6%8D%AE%E4%BF%9D%E6%8A%A4"><span class="nav-text">一、文件数据保护</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E6%95%B0%E6%8D%AE%E4%BF%9D%E6%8A%A4%E7%AD%89%E7%BA%A7"><span class="nav-text">二、数据保护等级</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#A%E7%B1%BB%EF%BC%9A%E5%AE%8C%E5%85%A8%E4%BF%9D%E6%8A%A4%EF%BC%8CComplete-Protection"><span class="nav-text">A类：完全保护，Complete Protection</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#B%E7%B1%BB%EF%BC%9A%E6%9C%AA%E6%89%93%E5%BC%80%E6%96%87%E4%BB%B6%E4%BF%9D%E6%8A%A4%EF%BC%8CProtected-Unless-Open"><span class="nav-text">B类：未打开文件保护，Protected Unless Open</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#C%E7%B1%BB%EF%BC%9A%E9%A6%96%E6%AC%A1%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E5%89%8D%E4%BF%9D%E6%8A%A4%EF%BC%8CProtected-Until-First-User-Authentication"><span class="nav-text">C类：首次用户认证前保护，Protected Until First User Authentication</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#D%E7%B1%BB%EF%BC%9A%E6%97%A0%E4%BF%9D%E6%8A%A4%EF%BC%8CNo-Protection"><span class="nav-text">D类：无保护，No Protection</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E9%92%A5%E5%8C%99%E5%8C%85%EF%BC%88keyBag%EF%BC%89%E6%95%B0%E6%8D%AE%E4%BF%9D%E6%8A%A4"><span class="nav-text">三、钥匙包（keyBag）数据保护</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E7%94%A8%E6%88%B7%E5%AF%86%E9%92%A5%E5%8C%85-User-keyBag"><span class="nav-text">1. 用户密钥包(User keyBag)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E8%AE%BE%E5%A4%87%E5%AF%86%E9%92%A5%E5%8C%85-Device-keyBag"><span class="nav-text">2. 设备密钥包 (Device keyBag)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%A4%87%E4%BB%BD%E5%AF%86%E9%92%A5%E5%8C%85%EF%BC%88Backup-keyBag%EF%BC%89"><span class="nav-text">3. 备份密钥包（Backup keyBag）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%89%98%E7%AE%A1%E5%AF%86%E9%92%A5%E5%8C%85%EF%BC%88Escrow-keybag%EF%BC%89"><span class="nav-text">4. 托管密钥包（Escrow keybag）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E4%BA%91%E5%A4%87%E4%BB%BD%E5%AF%86%E9%92%A5%E5%8C%85%EF%BC%88iCloud-Backup-keybag%EF%BC%89"><span class="nav-text">5.云备份密钥包（iCloud Backup keybag）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E9%92%A5%E5%8C%99%E4%B8%B2-Key-Chain-%E6%95%B0%E6%8D%AE%E4%BF%9D%E6%8A%A4"><span class="nav-text">四、钥匙串 (Key Chain)数据保护</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E7%B1%BB%E5%9E%8B%E5%AE%9A%E4%B9%89"><span class="nav-text">1. 类型定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%85%B8%E5%9E%8B%E5%9C%BA%E6%99%AF"><span class="nav-text">2. 典型场景</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E6%96%87%E4%BB%B6%E4%BF%9D%E7%AE%A1%E7%AE%B1%EF%BC%88FileVault%EF%BC%89"><span class="nav-text">五、文件保管箱（FileVault）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%96%87%E4%BB%B6%E4%BF%9D%E9%99%A9%E7%AE%B1%E5%B7%B2%E6%89%93%E5%BC%80%E7%9A%84%E5%86%85%E9%83%A8%E5%82%A8%E5%AD%98%E8%AE%BE%E5%A4%87"><span class="nav-text">1. 文件保险箱已打开的内部储存设备</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%96%87%E4%BB%B6%E4%BF%9D%E9%99%A9%E7%AE%B1%E5%B7%B2%E5%85%B3%E9%97%AD%E7%9A%84%E5%86%85%E9%83%A8%E5%82%A8%E5%AD%98%E8%AE%BE%E5%A4%87"><span class="nav-text">2. 文件保险箱已关闭的内部储存设备</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%88%A0%E9%99%A4%E6%96%87%E4%BB%B6%E4%BF%9D%E9%99%A9%E7%AE%B1%E5%AE%97%E5%8D%B7"><span class="nav-text">3. 删除文件保险箱宗卷</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E5%8F%AF%E7%A7%BB%E9%99%A4%E5%82%A8%E5%AD%98%E8%AE%BE%E5%A4%87"><span class="nav-text">4. 可移除储存设备</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AD%E3%80%81%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90"><span class="nav-text">六、技术分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-SKP-%E5%AF%86%E5%B0%81%E5%AF%86%E9%92%A5%E4%BF%9D%E6%8A%A4%E6%8A%80%E6%9C%AF"><span class="nav-text">1. SKP 密封密钥保护技术</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%85%B3%E4%BA%8E-iOS-%E7%9A%84%E6%96%87%E4%BB%B6%E4%BF%9D%E6%8A%A4%E7%B1%BB%E5%9E%8B"><span class="nav-text">2. 关于 iOS 的文件保护类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%85%B3%E4%BA%8E-MacOS-%E7%9A%84-Volume-Key"><span class="nav-text">2. 关于 MacOS 的 Volume Key</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E9%81%97%E7%95%99%E9%97%AE%E9%A2%98"><span class="nav-text">4. 遗留问题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%8D%E8%AF%8D%E8%A7%A3%E9%87%8A"><span class="nav-text">名词解释</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Effaceable-Storage%EF%BC%8C%E5%8F%AF%E6%93%A6%E9%99%A4%E5%8C%BA%E5%9F%9F"><span class="nav-text">Effaceable Storage，可擦除区域</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LLB-Low-Level-Bootloader%EF%BC%8C%E5%BA%95%E5%B1%82%E5%BC%95%E5%AF%BC%E8%BD%BD%E5%85%A5%E7%A8%8B%E5%BA%8F"><span class="nav-text">LLB - Low Level Bootloader，底层引导载入程序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#xART-eXtended-Anti-Replay-Technology%EF%BC%8C%E5%8F%8D%E9%87%8D%E6%94%BE%E6%8A%80%E6%9C%AF"><span class="nav-text">xART - eXtended Anti-Replay Technology，反重放技术</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%A0%B8%E5%BF%83%E5%AF%86%E9%92%A5%E7%B1%BB%E5%9E%8B"><span class="nav-text">3. 核心密钥类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UID-unique-ID%EF%BC%8C%E5%94%AF%E4%B8%80ID"><span class="nav-text">UID - unique ID，唯一ID</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#PDK-Passcode-Derived-Key%EF%BC%8C%E5%AF%86%E7%A0%81%E6%B4%BE%E7%94%9F%E5%AF%86%E9%92%A5"><span class="nav-text">PDK - Passcode-Derived Key，密码派生密钥</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#per-file-key%EF%BC%8C%E6%96%87%E4%BB%B6%E7%8B%AC%E6%9C%89%E5%AF%86%E9%92%A5"><span class="nav-text">per-file key，文件独有密钥</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#filesystem-key%EF%BC%8C%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%AF%86%E9%92%A5"><span class="nav-text">filesystem key，文件系统密钥</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Volume-Key%EF%BC%8C%E5%8D%B7%E5%AE%97%E5%AF%86%E9%92%A5"><span class="nav-text">Volume Key，卷宗密钥</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#KEK-Key-Encryption-Key%EF%BC%8C%E5%AF%86%E9%92%A5%E5%B0%81%E8%A3%85%E5%AF%86%E9%92%A5"><span class="nav-text">KEK - Key Encryption Key，密钥封装密钥</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Apple%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3"><span class="nav-text">Apple官方文档</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Alex Sun</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">90</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://nokiam9.github.io/2022/11/13/Apple%E6%95%B0%E6%8D%AE%E4%BF%9D%E6%8A%A4%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98%E4%B9%8B%E4%B8%80%EF%BC%9A%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Alex Sun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Alex的技术博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Apple数据保护技术专题之一：基础架构 | Alex的技术博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Apple数据保护技术专题之一：基础架构
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-11-13 14:34:06" itemprop="dateCreated datePublished" datetime="2022-11-13T14:34:06+08:00">2022-11-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-10-15 23:01:42" itemprop="dateModified" datetime="2023-10-15T23:01:42+08:00">2023-10-15</time>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>7.8k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>28 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>长期以来 Apple 公司有两条数据安全的技术演进路线，iPhone 和 iPad 等智能终端设备使用称为<strong>数据保护（Data Protection）</strong>的文件加密方法，基于Intel的Mac设备通过<strong>文件保险箱（FileVault）</strong>的宗卷加密技术。</p>
<p>MacOS 和 iOS 都是基于 FreeBSD 发展而来，基础架构是一个多用户的操作系统，但 iPhone 等作为个人化（无需支持多用户）的终端设备，存储了通信录、照片等非常敏感的隐私数据，对数据保护的要求更高；其次，App Store 和 iCloud等云服务大量出现，在网络开放环境下既要支持便利的后台服务管理，又要解决数据迁移过程中的数据保护，对数据保护的技术方案提出了新要求；最后，跨平台的生态系统需要密切协同（例如多个不同设备之间需要共享邮箱账号和密码），需要解决服务协同与数据安全的矛盾。</p>
<p>数据保护的技术实现离不开关键的硬件支持！限于技术演进和商业利益，早期的 Mac 设备基于 Intel CPU，早期的 iPhone 也采用 ARM6 和 ARM7 CPU，其底层架构难以满足数据保护的技术需求，为此 Apple 先后推出了适配 iPhone 的 A 系列 CPU 和适配 Mac 设备的 T 系列增强型安全芯片，依托自主研发的 Secure Encalve 为数据保护技术提供底层硬件支持，同时结合操作系统内核技术和 APP 沙盒技术等，确保只有受信任的代码及App可以在设备上运行（典型成果就是流行一时的 iPhone 越狱已经成为历史！），并有效提升了安全启动链、系统安全性和App安全性功能。</p>
<p>随着 M1 自研芯片的推出，上述两条技术路线正在逐步融合，搭载 Apple 芯片的 Mac 设备已经使用两者的混合模型，相信未来 FileVault 技术将逐步退出，因此本文主要研究Data Protection 技术。根据Apple 官方文档，其主要设计目标包括：</p>
<ul>
<li>在硬件被改动的情况下也能保护数据（替换组件&#x2F;直接读取闪存等）</li>
<li>对抗离线攻击（物理方式获取闪存内的数据后用更强大的计算设备进行破解）</li>
<li>对不同的数据提供不同级别的保护（锁屏之后有些数据要保护，有些数据还需要访问）</li>
<li>需要时能够快速安全清除所有数据</li>
<li>考虑性能和功耗</li>
</ul>
<h2 id="一、文件数据保护"><a href="#一、文件数据保护" class="headerlink" title="一、文件数据保护"></a>一、文件数据保护</h2><p>iOS 的所有用户数据文件都是加密存储的，Mac的情况复杂一些，文件系统加密是可选的，但USB外接存储就没有必要了。主要设计思想是：</p>
<ul>
<li>每个文件创建时会生成一个<code>Per-file Key</code>，在文件写入闪存时通过硬件用<code>AES-XTS</code>加密</li>
<li><code>Per-file Key</code>存储在文件的元数据 (Metadata) 中，被<code>Class Key</code>和<code>Filesystem Key</code>加密</li>
<li><code>Class Key</code>和<code>Filesystem Key</code>都被硬件密钥<code>UID</code>保护</li>
<li><code>Class Key</code>还被用户密码<code>Passcode</code>保护</li>
</ul>
<p><img src="/2022/11/13/Apple%E6%95%B0%E6%8D%AE%E4%BF%9D%E6%8A%A4%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98%E4%B9%8B%E4%B8%80%EF%BC%9A%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84/KEY-ARCH.jpg" alt="key"></p>
<blockquote>
<p>EMF Key 就是加密封装的 Filesystem Key，存储在闪存的可擦除区域，只允许安全隔区访问<br>Class Key 通过多层加密封装，持久化存储在 keybag（系统密钥包）之中</p>
</blockquote>
<p>这种设计方案的主要优势在于：</p>
<ol>
<li>实现了“一件一密”，每个文件都有独立的密钥<code>Per-file Key</code>，加密强度大大提高</li>
<li><code>Class Key</code>实现对文件不同级别的保护（最高级别只有在设备解锁状态下才可用），一个密钥就可以解封对应级别所有文件的<code>Per-file Key</code>；当用户修改<code>Passcode</code>时，只需重置<code>Class Key</code>并对元数据中的文件密钥重新封装即可，原始文件无需重新加密，兼顾了安全性和灵活性</li>
<li><code>Filesystem Key</code>在 iOS 安装时或每次设备数据被清除时生成，其目标不是保护数据的机密性，而是用于实现快速清除数据，即一旦<code>Filesystem Key</code>被删除，设备上所有文件将永久无法解密</li>
<li>所有加密处理由 AES Engine 的硬件处理，性能有保障；同时所有密钥由 Secure Enclave 统一管理，不对外泄露，确保安全性并对上层应用透明</li>
<li>文件数据有<code>Class Key</code>和<code>Filesystem Key</code>两层密钥，并最终由<code>UID</code>和<code>Passcode</code>提供保护，考虑到用户设置<code>Passcode</code>的强度不高，Apple还专门强化了安全隔区的反重放机制以提高安全性</li>
</ol>
<blockquote>
<p>When a file is opened, its metadata is decrypted with the file system key, revealing the wrapped per-file key and a notation on which class protects it. The per-file (or per-extent) key is unwrapped with the class key and then supplied to the hardware AES Engine, which decrypts the file as it’s read from flash storage. All wrapped file key handling occurs in the Secure Enclave; the file key is never directly exposed to the Application Processor.</p>
</blockquote>
<h2 id="二、数据保护等级"><a href="#二、数据保护等级" class="headerlink" title="二、数据保护等级"></a>二、数据保护等级</h2><p>设备中我们需要对不同的文件提供不同程度的保护。iOS 上每个文件创建时都会被指定一个级别，每个级别对应一个<code>Class Key</code>。</p>
<h3 id="A类：完全保护，Complete-Protection"><a href="#A类：完全保护，Complete-Protection" class="headerlink" title="A类：完全保护，Complete Protection"></a>A类：完全保护，Complete Protection</h3><ul>
<li>该类密钥通过从用户密码和设备 UID 派生的密钥得到保护。用户锁定设备后不久（如果 “需要密码” 设置为 “立即”，则为10秒钟），解密的类密钥会被丢弃，此类的所有数据都无法访问，除非用户再次输入密码或使用触控 ID 或面容 ID 解锁（登录）设备。</li>
<li>在 macOS 中，上一个用户退出登录不久后，解密的类密钥会被丢弃，此类的所有数据都无法访问，直到某位用户再次输入密码或使用触控 ID 登录设备。</li>
</ul>
<h3 id="B类：未打开文件保护，Protected-Unless-Open"><a href="#B类：未打开文件保护，Protected-Unless-Open" class="headerlink" title="B类：未打开文件保护，Protected Unless Open"></a>B类：未打开文件保护，Protected Unless Open</h3><ul>
<li>设备锁定或用户退出登录时，可能需要写入部分文件（如后台下载邮件附件）。此行为通过使用非对称椭圆曲线加密技术（基于 Curve25519 的 ECDH）实现。普通的文件独有密钥通过使用一次性迪菲-赫尔曼密钥交换协议（One-Pass Diffie-Hellman Key Agreement，如 NIST SP 800-56A 中所述）派生的密钥进行保护。</li>
<li>该协议的临时公钥与封装的文件独有密钥一起储存。 KDF 是串联密钥导出函数 (Approved Alternative 1)，如 NIST SP 800-56A 中 5.8.1 所述。AlgorithmID 已忽略。 PartyUInfo 和 PartyVInfo 分别是临时公钥和静态公钥。SHA256 被用作哈希函数。一旦文件关闭，文件独有密钥就会从内存中擦除。要再次打开该文件，系统会使用 “未打开文件的保护” 类的私钥和文件的临时公钥重新创建共享密钥，用来解开文件独有密钥的封装，然后用文件独有密钥来解密文件。</li>
<li>在 macOS 中，只要系统上的任何用户已登录或认证即可访问 NSFileProtectionCompleteUnlessOpen 的私有部分。</li>
</ul>
<h3 id="C类：首次用户认证前保护，Protected-Until-First-User-Authentication"><a href="#C类：首次用户认证前保护，Protected-Until-First-User-Authentication" class="headerlink" title="C类：首次用户认证前保护，Protected Until First User Authentication"></a>C类：首次用户认证前保护，Protected Until First User Authentication</h3><ul>
<li>此类和 “全面保护” 类的行为方式相同，只不过在设备锁定或用户退出登录时已解密的类密钥不会从内存中删除。此类中的保护与桌面电脑全宗卷加密有类似的属性，可防止数据受到涉及重新启动的攻击。这是未分配给数据保护类的所有第三方 App 数据的默认类。</li>
<li>在 macOS 中，此类的作用类似于文件保险箱，且使用只要宗卷装载即可访问的宗卷密钥。</li>
</ul>
<h3 id="D类：无保护，No-Protection"><a href="#D类：无保护，No-Protection" class="headerlink" title="D类：无保护，No Protection"></a>D类：无保护，No Protection</h3><ul>
<li>此类密钥仅受 UID 的保护，并且存储在可擦除存储器中（即 DKey 密钥）。由于解密该类中的文件所需的所有密钥都储存在设备上，因此采用该类加密的唯一好处就是可以进行快速远程擦除。即使未向文件分配数据保护类，此文件仍会以加密形式储存 （就像 iOS 和 iPadOS 设备上的所有数据那样）。</li>
<li>macOS 不支持该类型。</li>
</ul>
<blockquote>
<p>The contents of a file may be encrypted with one or more per-file (or per-extent) keys that are wrapped with a class key and stored in a file‘s metadata, which in turn is encrypted with the file system key. The class key is protected with the hardware UID and, for some classes, the user’s passcode. This hierarchy provides both flexibility and performance. For example, <strong>changing a file‘s class only requires rewrapping its per-file key, and a change of passcode just rewraps the class key</strong>。</p>
</blockquote>
<h2 id="三、钥匙包（keyBag）数据保护"><a href="#三、钥匙包（keyBag）数据保护" class="headerlink" title="三、钥匙包（keyBag）数据保护"></a>三、钥匙包（keyBag）数据保护</h2><p>系统密钥包是一个加密的 <code>plist</code> 格式的二进制文件，存储了所有类密钥的数据，Apple 系统的数据解密实现方式见下图。</p>
<p><img src="/2022/11/13/Apple%E6%95%B0%E6%8D%AE%E4%BF%9D%E6%8A%A4%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98%E4%B9%8B%E4%B8%80%EF%BC%9A%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84/daemon.png" alt="Daemon"></p>
<p>有五种不同类型的钥匙包，但数据格式完全相同，包括：</p>
<h3 id="1-用户密钥包-User-keyBag"><a href="#1-用户密钥包-User-keyBag" class="headerlink" title="1. 用户密钥包(User keyBag)"></a>1. 用户密钥包(User keyBag)</h3><p>用户密钥包是设备常规操作中使用的封装类密钥的储存位置。例如，输入密码后，<code>NSFileProtectionComplete</code>会从用户密钥包中载入并解封。它是储存在“无保护”类中的二进制属性列表 (.plist) 文件。<br>对于搭载 A9 之前的 SoC 的设备，该 .plist 文件的内容通过保存在可擦除存储器中的密钥（Bag1 Key）加密。为了给密钥包提供前向安全性，用户每次更改密码时，系统都会擦除并重新生成此密钥。<br>对于搭载 A9 或后续型号 SoC 的设备，该 .plist 文件包含一个密钥，表示密钥包储存在受反重放随机数（由安全隔区控制）保护的有锁储存库中。</p>
<h3 id="2-设备密钥包-Device-keyBag"><a href="#2-设备密钥包-Device-keyBag" class="headerlink" title="2. 设备密钥包 (Device keyBag)"></a>2. 设备密钥包 (Device keyBag)</h3><p>设备密钥包用来储存用于涉及设备特定操作数据的封装类密钥。 配置为共用的 iPadOS 设备有时需要在用户登录前访问凭证，因此需要一个不受用户密码保护的密钥包。<br>iOS 和 iPadOS 不支持对用户独有的文件系统内容进行单独加密，这就意味着系统使用来自设备密钥包的类密钥，对文件独有密钥进行封装，而钥匙串则使用来自用户密钥包中的类密钥来保护用户钥匙串中的项目。<br>在配置为单用户使用 (默认配置) 的 iOS 和 iPadOS 设备中， 设备密钥包和用户密钥包是同一个， 并受用户的密码保护。</p>
<h3 id="3-备份密钥包（Backup-keyBag）"><a href="#3-备份密钥包（Backup-keyBag）" class="headerlink" title="3. 备份密钥包（Backup keyBag）"></a>3. 备份密钥包（Backup keyBag）</h3><p>备份密钥包在 “访达” (macOS 10.15 或更高版本) 或 iTunes (macOS 10.14 或更低版本) 进行加密备份时创建，并储存在设备被备份到的电脑中。<br>新密钥包是通过一组新密钥创建的，备份的数据会使用这些新密钥重新加密。 如前所述，不可迁移钥匙串项仍使用 UID 派生密钥封装，以使其可以恢复到最初备份它们的设备，但在其他设备上不可访问。<br>由于备份密钥包并未捆绑特定设备， 理论上尝试在多台电脑上对备份密钥包并行展开暴力破解是可行的。<br>如果用户选择不加密备份， 那么不管备份文件属于哪一种数据保护类， 备份文件都不加密，但钥匙串仍使用 UID 派生密钥获得保护。这就是只有设置备份密码才能将钥匙串项迁移到新设备的原因。</p>
<h3 id="4-托管密钥包（Escrow-keybag）"><a href="#4-托管密钥包（Escrow-keybag）" class="headerlink" title="4. 托管密钥包（Escrow keybag）"></a>4. 托管密钥包（Escrow keybag）</h3><p>托管密钥包用于通过 USB 与 “访达” (macOS 10.15 或更高版本) 或 iTunes (macOS 10.14 或更低版 本) 进行同步， 还用于移动设备管理 (MDM)。 此密钥包允许 “访达” 或 iTunes 执行备份和同步， 而无需用户输入密码，它还允许 MDM 解决方案远程清除用户密码。它储存在用于与 “访达” 或 iTunes 进行同步的电脑上，或者在远程管理设备的 MDM 解决方案上。<br>托管密钥包改善了设备同步过程中的用户体验，期间可能需要访问所有类别的数据。当使用密码锁定的设备首次连接到 “访达” 或 iTunes 时，会提示用户输入密码。然后设备创建托管密钥包，其中包含的类密钥与设备上使用的完全相同，该密钥包由新生成的密钥进行保护。托管密钥包及用于保护它的密钥划分到设备和主机或服务器上，其数据以 “首次用户认证前保护” 类储存在设备上。这就是重新启动后，用户首次使用 “访达” 或 iTunes 进行备份之前必须输入设备密码的原因。</p>
<h3 id="5-云备份密钥包（iCloud-Backup-keybag）"><a href="#5-云备份密钥包（iCloud-Backup-keybag）" class="headerlink" title="5.云备份密钥包（iCloud Backup keybag）"></a>5.云备份密钥包（iCloud Backup keybag）</h3><p>iCloud 云备份密钥包与备份密钥包类似。 该密钥包中的所有类密钥都是非对称的 (与 “未打开文件的保护”数据保护类一样， 使用 Curve25519)。<br>非对称密钥包还可用于 “iCloud 钥匙串” 钥匙串恢复中的备份。</p>
<h2 id="四、钥匙串-Key-Chain-数据保护"><a href="#四、钥匙串-Key-Chain-数据保护" class="headerlink" title="四、钥匙串 (Key Chain)数据保护"></a>四、钥匙串 (Key Chain)数据保护</h2><p>许多 App 都需要处理密码和其他一些简短但比较敏感的数据，如密钥和登录令牌。钥匙串提供了储存这些项的安全方式。不同的 Apple 操作系统采用不同机制实施与各钥匙串保护类关联的保障。<br>在 macOS (包括搭 载 Apple 芯片的 Mac) 中，数据保护不直接用于实施此类保障。</p>
<p>钥匙串项使用两种不同的 AES-256-GCM 密钥加密 : 表格密钥 (元数据) 和行独有密钥 (私密密钥)。钥匙串元数据 (除 kSecValue 外的所有属性) 使用元数据密钥加密以加速搜索，私密值 (kSecValueData) 使用私密密钥进行加密。元数据密钥受安全隔区保护，但会缓存在应用程序处理器中以便进行钥匙串快速查询。私密密钥则始终需要通过安全隔区进行往返处理。</p>
<blockquote>
<p>元数据密钥就是 FileSystem Key（EMF），私密密钥就是 Passcode Key</p>
</blockquote>
<p>钥匙串以储存在文件系统中的<code>SQLite</code>数据库的形式实现， 而且数据库只有一个<code>securityd</code>监控程序决定每个进程或 App 可以访问哪些钥匙串项。钥匙串访问 API 将生成对监控程序的调用，从而查询 App 的 “keychain-access-groups”、 “application-identifier” 和 “application-group” 权限。访问组允许在 App 之间共享钥匙串项，而非将访问权限限制于单个进程。</p>
<h3 id="1-类型定义"><a href="#1-类型定义" class="headerlink" title="1. 类型定义"></a>1. 类型定义</h3><p>根据 Apple 最新的 <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/security/ksecattraccessiblewhenunlockedthisdeviceonly">KeyChain 的开发技术文档</a>，当前提供如下类型：</p>
<p>对应文件保护的类型定义：</p>
<ul>
<li>kSecAttrAccessibleAfterFirstUnlock: 首次解锁后，对应文件保护的 Class C</li>
<li>kSecAttrAccessibleWhenUnlocked: 未锁定状态下，对应文件保护的 Class A</li>
<li>kSecAttrAccessibleAlways: <strong>iOS 13 已弃用</strong>。始终，对应文件保护的 Class D</li>
</ul>
<blockquote>
<p>使用后台刷新服务的 App 可通过 kSecAttrAccessibleAfterFirstUnlock 访问需要的钥匙串项</p>
</blockquote>
<p>钥匙串类都有对应的 “仅限本设备” 项目，后者在备份期间从设备拷贝时始终通过 UID 加以保护，如果恢复（迁移）至其他设备将无法使用，例如 VPN 证书。</p>
<ul>
<li>kSecAttrAccessibleAfterFirstUnlockThisDeviceOnly: 仅限本设备，首次解锁后</li>
<li>kSecAttrAccessibleWhenUnlockedThisDeviceOnly: 仅限本设备，未锁定状态下</li>
<li>kSecAttrAccessibleAlwaysThisDeviceOnly: <strong>iOS 13 已弃用</strong>。仅限本设备，始终</li>
</ul>
<p>还有一个仅存在于系统密钥包的特殊类型，一旦用户密码被移除或重设，该类密钥便会丢弃，且不会备份、不同步到 iCloud 钥匙串、不包括在托管密钥包。</p>
<ul>
<li>kSecAttrAccessibleWhenPasscodeSetThisDeviceOnly：仅当设备配置了密码时可用，行为方式与“未锁定状态下”相同</li>
</ul>
<h3 id="2-典型场景"><a href="#2-典型场景" class="headerlink" title="2. 典型场景"></a>2. 典型场景</h3><p>Apple 根据所保护信息的类型以及 iOS 和 iPadOS 需要这些信息的时间来选择钥匙串类，妥善平衡了安全性和可用性。例如，VPN 证书必须始终可用，这样设备才能保持连接，但它归类为 “不可迁移”， 因此不能将其移至另一台设备.</p>
<table>
<thead>
<tr>
<th align="center">Item</th>
<th align="center">Accessibility</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Wi-Fi passwords</td>
<td align="center">Always</td>
</tr>
<tr>
<td align="center">IMAP&#x2F;POP&#x2F;SMTP accounts</td>
<td align="center">AfterFirstUnlock</td>
</tr>
<tr>
<td align="center">Exchange accounts</td>
<td align="center">Always</td>
</tr>
<tr>
<td align="center">VPN</td>
<td align="center">Always</td>
</tr>
<tr>
<td align="center">LDAP&#x2F;CalDAV&#x2F;CardDAV accounts</td>
<td align="center">Always</td>
</tr>
<tr>
<td align="center">iTunes backup password</td>
<td align="center">WhenUnlockedThisDeviceOnly</td>
</tr>
<tr>
<td align="center">Device certificate &amp; private key</td>
<td align="center">AlwaysThisDeviceOnly</td>
</tr>
</tbody></table>
<h2 id="五、文件保管箱（FileVault）"><a href="#五、文件保管箱（FileVault）" class="headerlink" title="五、文件保管箱（FileVault）"></a>五、文件保管箱（FileVault）</h2><blockquote>
<p>On Apple devices that support Data Protection, the key encryption key (KEK) is protected (or sealed) with measurements of the software on the system, as well as being tied to the UID available only from the Secure Enclave.<br>On a Mac with Apple silicon, the protection of the KEK is further strengthened by incorporating information about security policy on the system, because macOS supports critical security policy changes (for example, disabling secure boot or SIP) that are unsupported on other platforms.<br>On a Mac with Apple silicon, this protection encompass FileVault keys, because FileVault is implemented using Data Protection (Class C).<br>The key that results from entangling the user password, long-term SKP key, and Hardware key 1 (the UID from Secure Enclave) is called the password-derived key.<br>This key is used to protect the user keybag (on all supported platforms) and <strong>KEK (in macOS only)</strong>, and then enable biometric unlock or auto unlock with other devices such as Apple Watch.</p>
</blockquote>
<p>MacOS 使用文件保险箱（FileVault）技术提供数据保护功能，使用 AES-XTS 数据加密算法保护内部和可移除储存设备上的完整宗卷。</p>
<blockquote>
<p>xART Key 是反重放密钥，SKP、KEK ？？？</p>
</blockquote>
<p>数据宗卷文件系统中所有文件的元数据都使用随机宗卷密钥（<code>Volume Key</code>）进行加密，该密钥在首次安装操作系统或用户擦除设备时创建。此密钥由密钥封装密钥（<code>Key Encryption Key</code>）加密和封装，<strong>密钥封装密钥由安全隔区长期储存，只在安全隔区中可见</strong>。每次用户抹掉设备时，它都会发生变化。在 A9（及后续型号）SoC 上，安全隔区依靠由反重放系统支持的熵来实现可擦除性，以及保护其他资源中的密钥封装密钥。</p>
<blockquote>
<p>Volume Key 负责加密 volume 和文件 metadata，其作用与 iOS 的 FileSystem Key 相同，但加密和存储方式存在显著差异：<br>iOS 中，FileSystem Key 的密文是 EMF，持久化存储在 NAND 可擦除区域；而 MacOS 将</p>
</blockquote>
<p>在搭载 Apple 芯片的 Mac 上，数据保护默认为 C 类，但<strong>使用宗卷密钥，而非范围独有密钥或文件独有密钥</strong>，可为用户数据高效重建文件保险箱安全模型。用户仍须选择使用文件保险箱，以获得加密密钥层级搭配用户密码的全面保护。开发者也可以选择使用文件独有密钥或范围独有密钥的更高保护类。</p>
<blockquote>
<p>APFS 支持文件克隆（使用写入时拷贝技术的零损耗拷贝），如果文件被克隆，克隆的每一半都会得到一个新的密钥以接受传入的数据写入，这样新数据会使用新密钥写入媒介。久而久之， 文件可能会由不同的范围（或片段）组成，每个映射到不同的密钥（称为范围密钥，<code>Per-extend Key</code>）。<br>但是，组成文件的所有范围密钥仍然受同一 Class key 的保护。</p>
</blockquote>
<p>搭载 Apple 芯片的 Mac 上的文件保险箱通过使用宗卷密钥的数据保护 C 类来实施。<br>在搭载 Apple T2 安 全芯片的 Mac 和搭载 Apple 芯片的 Mac 上， 直接连接到安全隔区的加密内部储存设备会使用安全隔区的硬件安全性功能和 AES 引擎的功能。<br>用户在 Mac 上启用文件保险箱后，启动过程中将需要其凭证。</p>
<h3 id="1-文件保险箱已打开的内部储存设备"><a href="#1-文件保险箱已打开的内部储存设备" class="headerlink" title="1. 文件保险箱已打开的内部储存设备"></a>1. 文件保险箱已打开的内部储存设备</h3><p>如果没有有效的登录凭证或加密恢复密钥，即使物理储存设备被移除并连接到其他电脑，内置 APFS 宗卷仍保持加密状态，以防止未经授权的访问。在 macOS 10.15 中，此类宗卷同时包括系统宗卷和数据宗卷。从 macOS 11 开始，系统宗卷通过签名系统宗卷 (SSV) 功能进行保护，而数据宗卷仍通过加密进行保护。搭载 Apple 芯片的 Mac 以及搭载 T2 芯片的 Mac 通过构建和管理密钥层级实施内部宗卷加密，基于芯片内建的硬件加密技术而构建。<br><img src="/2022/11/13/Apple%E6%95%B0%E6%8D%AE%E4%BF%9D%E6%8A%A4%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98%E4%B9%8B%E4%B8%80%EF%BC%9A%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84/filevault-on.png" alt="filevault-on"></p>
<p>此密钥层级的设计旨在同时实现四个目标 :<br>• 请求用户密码用于加密<br>• 保护系统免受针对从 Mac 上移除的储存媒介的直接暴力破解攻击<br>• 提供擦除内容的快速安全的方法， 即通过删除必要的加密材料<br>• 让用户无需重新加密整个宗卷即可更改其密码 (同时也会更改用于保护其文件的加密密钥)</p>
<p>在搭载 Apple 芯片的 Mac 以及搭载 T2 芯片的 Mac 上，所有文件保险箱密钥的处理都发生在安全隔区中；加密密钥绝不会直接透露给 Intel CPU。 所有 APFS 宗卷默认使用宗卷加密密钥创建。宗卷和元数据内容使用此宗卷加密密钥加密，此宗卷加密密钥使用<strong>类密钥</strong>封装。 文件保险箱启用时，类密钥受用户密码和硬件 UID 共同保护。</p>
<h3 id="2-文件保险箱已关闭的内部储存设备"><a href="#2-文件保险箱已关闭的内部储存设备" class="headerlink" title="2. 文件保险箱已关闭的内部储存设备"></a>2. 文件保险箱已关闭的内部储存设备</h3><p>在搭载 Apple 芯片或搭载 T2 芯片的 Mac 上，如果在 “设置助理” 初次运行过程中未启用文件保险箱，宗卷仍会加密，但宗卷加密密钥仅由安全隔区中的硬件 UID 保护。<br><img src="/2022/11/13/Apple%E6%95%B0%E6%8D%AE%E4%BF%9D%E6%8A%A4%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98%E4%B9%8B%E4%B8%80%EF%BC%9A%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84/filevault-off.png" alt="filevault-off"></p>
<p>如果稍后启用了文件保险箱 (由于数据已加密， 该过程可立即完成)， 反重放机制会帮助阻止旧密钥 (仅基于硬件 UID) 被用于解密宗卷。 然后宗卷将受用户密码和硬件 UID 共同保护 (如前文所述)。</p>
<h3 id="3-删除文件保险箱宗卷"><a href="#3-删除文件保险箱宗卷" class="headerlink" title="3. 删除文件保险箱宗卷"></a>3. 删除文件保险箱宗卷</h3><p>删除宗卷时，其宗卷加密密钥由安全隔区安全删除。这有助于防止以后使用此密钥进行访问 (即使是通过安全 隔区)。另外，所有宗卷加密密钥都使用媒介密钥封装。媒介密钥不提供额外的数据机密性，而是旨在启用快 速安全的数据删除，如果缺少了它，则不可能进行解密。<br>在搭载 Apple 芯片的 Mac 和搭载 T2 芯片的 Mac 上，媒介密钥一定是由受安全隔区支持的技术来抹掉，例如远程 MDM 命令。以这种方式抹掉媒介密钥将导致宗卷因存在加密而不可访问。</p>
<h3 id="4-可移除储存设备"><a href="#4-可移除储存设备" class="headerlink" title="4. 可移除储存设备"></a>4. 可移除储存设备</h3><p>可移除储存设备的加密不使用安全隔区的安全性功能，而是采用与基于 Intel 的 Mac (不搭载 T2 芯片) 相同的方式执行加密。</p>
<h2 id="六、技术分析"><a href="#六、技术分析" class="headerlink" title="六、技术分析"></a>六、技术分析</h2><h3 id="1-SKP-密封密钥保护技术"><a href="#1-SKP-密封密钥保护技术" class="headerlink" title="1. SKP 密封密钥保护技术"></a>1. SKP 密封密钥保护技术</h3><p>Apple 设备支持一项称为密封密钥保护 (SKP，Sealed Key Prtection) 的技术， 其旨在确保加密材料在这些情况下不可用 : 脱离设备 时， 或者对操作系统版本或安全性设置存在未经用户正确授权的操纵时。</p>
<p>注意！SKP 功能不是由安全隔区提供，而是由位于更底层的硬件寄存器支持（也就意味着，仅在搭载 Apple 设计的 SoC 的设备上提供），目的是针对解密用户数据所需的密钥提供独立于安全隔区的额外保护层。</p>
<p><img src="/2022/11/13/Apple%E6%95%B0%E6%8D%AE%E4%BF%9D%E6%8A%A4%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98%E4%B9%8B%E4%B8%80%EF%BC%9A%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84/SKP.png" alt="SKP"></p>
<p>安全隔区启动监视器会捕获所加载的安全隔区操作系统的测量值。 当应用程序处理器 Boot ROM 测量附于 LLB 的 Image4 清单时， 该清单也包含所有其他已加载的系统配对固件的测量值。 LocalPolicy </p>
<ul>
<li>安全隔区固件 sepOS ：由安全隔区启动监视器（硬件实现）获取测量值</li>
<li>LLB Image4 manifest：包含所有与 macOS 配对的固件和 macOS 核心启动对象 (如启动内核集或签名系统宗卷 (SSV) 根哈希值)的测量值</li>
<li>本地安全策略 LocalPolicy 的测量值：包含已加载 macOS 的核心安全性配置。 还包含 nsih 字段， 它是 macOS Image4 清单的哈希值。</li>
</ul>
<p><img src="/2022/11/13/Apple%E6%95%B0%E6%8D%AE%E4%BF%9D%E6%8A%A4%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98%E4%B9%8B%E4%B8%80%EF%BC%9A%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84/mac-boot.png" alt="搭载 Apple 芯片的 Mac 开机时的启动过程步骤"></p>
<p>如果攻击者能够意外地更改任何上述测量的固件、 软件或安全性配置组件， 则也会修改储存在硬件寄存器中的测量值。 测量值的修改会导致从加密硬件派生的系统测量根密钥 (SMRK) 派生出不同的值， 从而有效破坏密钥层 级的封章。 这将导致无法访问系统测量设备密钥 (SMDK)， 从而导致无法访问 KEK， 因此也无法访问数据。</p>
<p>但是， 系统在未受到攻击时， 必须容纳合法的软件更新， 这些更新会更改固件测量值和 LocalPolicy 中的 nsih 字段， 以指向新的 macOS 测量值。 在其他尝试整合固件测量值但没有已知真实来源的系统中， 用 户将被要求停用安全性， 更新固件后重新启用安全性， 以便捕获新的测量基线。 这大大增加了攻击者在软件 更新期间篡改固件的风险。 Image4 清单包含所需的所有测量值， 这对系统很有帮助。 正常启动期间如果测 量值匹配， 使用 SMRK 解密 SMDK 的硬件也可以将 SMDK 加密为所建议的将来的 SMRK。 通过指定软 件更新后预期的测量值， 硬件可以加密在当前操作系统中可访问的 SMDK， 以便在将来的操作系统中仍可 访问。 同样地， 当客户在 LocalPolicy 中合法更改其安全性设置时， 必须根据 LLB 下次重新启动时计算的 LocalPolicy 测量值， 将 SMDK 加密为将来的 SMRK。</p>
<blockquote>
<p>Image4 是经 ASN.1（抽象语法标记一）DER 编码的数据结构格式，用于描述 Apple 平台上有关安全启动链对象的信息。</p>
</blockquote>
<h3 id="2-关于-iOS-的文件保护类型"><a href="#2-关于-iOS-的文件保护类型" class="headerlink" title="2. 关于 iOS 的文件保护类型"></a>2. 关于 iOS 的文件保护类型</h3><p>对于早期的 iOS 系统，Class D 是用户数据文件的默认类型，其类密钥是 DKey。也就是说，尽管每个文件都有 per-file key，但是这些文件专有密钥的包裹密钥都是 DKey，而 DKey 并未将 Passcode 作为加密因子（仅由基于 UID 的 Key 0x835 提供保护），因此其加密强度难以抵抗暴力破解。</p>
<p>从 iOS 5 开始，Apple 决定将 Class C 作为默认类型，即在设备开机时，校验用户输入的 passcode，成功后即可自由访问（即使发生了锁屏事件，仍然可以访问数据文件）；但是如果设备关机，就必须在开机之后重新校验 passcode。</p>
<p>Class A 主要适用于日历、信息、邮件、照片、通讯录和健康数据等个人敏感信息，其特点是一旦锁屏事件发生（延迟10秒），将丢弃内存中的类密钥，结果是无法访问数据文件了；只有用户重新输入 passcode 解锁屏幕后，再重新计算类密钥，才可以继续提供数据文件访问。</p>
<p>Class B 的设计目标是解决远程下载等互联网服务的后台权限问题，方法是采用 ECC 非对称密码系统，代价是文件元数据需要额外存储一个临时公钥（类密钥就是静态私钥）</p>
<h3 id="2-关于-MacOS-的-Volume-Key"><a href="#2-关于-MacOS-的-Volume-Key" class="headerlink" title="2. 关于 MacOS 的 Volume Key"></a>2. 关于 MacOS 的 Volume Key</h3><p>MacOS 使用的 FileVault 技术与 iOS 使用的 Data Protection 存在一些差异，主要体现在：</p>
<ol>
<li>不支持 Class D 保护类型，也就是说，没有 <code>DKey</code> 密钥；</li>
<li>Class C 是默认类型，但并非每个文件都有不同的 per-file key，而是所有文件内容使用统一的卷宗密钥（<code>Volume Key</code>）;</li>
<li></li>
</ol>
<h3 id="4-遗留问题"><a href="#4-遗留问题" class="headerlink" title="4. 遗留问题"></a>4. 遗留问题</h3><ol>
<li>用户修改passcode后，需要重新封装metadata中所有的per-file key，似乎计算量也不小啊！</li>
</ol>
<h2 id="名词解释"><a href="#名词解释" class="headerlink" title="名词解释"></a>名词解释</h2><h3 id="Effaceable-Storage，可擦除区域"><a href="#Effaceable-Storage，可擦除区域" class="headerlink" title="Effaceable Storage，可擦除区域"></a>Effaceable Storage，可擦除区域</h3><p>可擦除存储器 NAND 存储器中一个用于储存加密密钥的专用区域，可被直接寻址和安全擦除。尽管当攻击者实际占有设备时，可擦除存储器无法提供保护，但其中存储的密钥可用作密钥层级的一部分，用于实现快速擦 除和前向安全性。</p>
<h3 id="LLB-Low-Level-Bootloader，底层引导载入程序"><a href="#LLB-Low-Level-Bootloader，底层引导载入程序" class="headerlink" title="LLB - Low Level Bootloader，底层引导载入程序"></a>LLB - Low Level Bootloader，底层引导载入程序</h3><p>在具有两步启动架构的 Mac 电脑上，LLB 包含由 Boot ROM 调用的代码，该代码随后会载入 iBoot，成为安全启动链的一环。</p>
<h3 id="xART-eXtended-Anti-Replay-Technology，反重放技术"><a href="#xART-eXtended-Anti-Replay-Technology，反重放技术" class="headerlink" title="xART - eXtended Anti-Replay Technology，反重放技术"></a>xART - eXtended Anti-Replay Technology，反重放技术</h3><p>一组为具有反重放功能 (基于物理储存架构) 的安全隔区提供加密且经认证的永久储存区的服务。</p>
<h3 id="3-核心密钥类型"><a href="#3-核心密钥类型" class="headerlink" title="3. 核心密钥类型"></a>3. 核心密钥类型</h3><h3 id="UID-unique-ID，唯一ID"><a href="#UID-unique-ID，唯一ID" class="headerlink" title="UID - unique ID，唯一ID"></a>UID - unique ID，唯一ID</h3><p>UID 是一个 256 位的 AES 密钥，在设备制造过程中刻录在每个处理器上。<br>这种密钥无法由固件或软件读取，只能由处理器的硬件 AES 引擎使用。 若要获取实际密钥，攻击者必须对处理器的芯片发起极为复杂且代价高昂的物理攻击。 UID 与设备上的任何其他标识符均无关，包括但不限于 UDID。</p>
<h4 id="PDK-Passcode-Derived-Key，密码派生密钥"><a href="#PDK-Passcode-Derived-Key，密码派生密钥" class="headerlink" title="PDK - Passcode-Derived Key，密码派生密钥"></a>PDK - Passcode-Derived Key，密码派生密钥</h4><p>用户密码与长期 SKP 密钥和安全隔区的 UID 配合使用，由此派生加密密钥。</p>
<h4 id="per-file-key，文件独有密钥"><a href="#per-file-key，文件独有密钥" class="headerlink" title="per-file key，文件独有密钥"></a>per-file key，文件独有密钥</h4><p>数据保护用于在文件系统上加密文件的密钥。文件独有密钥使用类密钥封装，储存在文件的元数据 metadata 中。</p>
<h4 id="filesystem-key，文件系统密钥"><a href="#filesystem-key，文件系统密钥" class="headerlink" title="filesystem key，文件系统密钥"></a>filesystem key，文件系统密钥</h4><p>用于加密每个文件的元数据的密钥，包括其类密钥。存储在可擦除存储器中，用于实现快速擦除，并非用于保密目的。</p>
<h4 id="Volume-Key，卷宗密钥"><a href="#Volume-Key，卷宗密钥" class="headerlink" title="Volume Key，卷宗密钥"></a>Volume Key，卷宗密钥</h4><p>数据宗卷文件系统中所有文件的元数据都使用随机宗卷密钥（Volume Key）进行加密，该密钥在首次安装操作系统或用户擦除设备时创建。</p>
<h4 id="KEK-Key-Encryption-Key，密钥封装密钥"><a href="#KEK-Key-Encryption-Key，密钥封装密钥" class="headerlink" title="KEK - Key Encryption Key，密钥封装密钥"></a>KEK - Key Encryption Key，密钥封装密钥</h4><p>宗卷密钥密钥由密钥封装密钥（Key Encryption Key）加密和封装，密钥封装密钥由安全隔区长期储存，只在安全隔区中可见。每次用户抹掉设备时，它都会发生变化。在 A9（及后续型号） SoC 上，安全隔区依靠由反重放系统支持的熵来实现可擦除性，以及保护其他资源中的密钥封装密钥。</p>
<blockquote>
<p>从功能描述上看，KEK 就是 PDK ！！！</p>
</blockquote>
<hr>
<h2 id="Apple官方文档"><a href="#Apple官方文档" class="headerlink" title="Apple官方文档"></a>Apple官方文档</h2><ul>
<li><a href="apple-platform-security-guide.pdf">Apple 平台安全白皮书 - 2022年英文版</a></li>
<li><a href="apple%E5%B9%B3%E5%8F%B0%E5%AE%89%E5%85%A8%E7%99%BD%E7%9A%AE%E4%B9%A6-2021%E4%B8%AD%E6%96%87%E7%89%88.pdf">Apple 平台安全白皮书 - 2021年中文版</a></li>
<li><a href="iOS%E5%AE%89%E5%85%A8%E7%99%BD%E7%9A%AE%E4%B9%A6-2018%E8%8B%B1%E6%96%87%E7%89%88.pdf">iOS 安全白皮书 - 2018年英文版</a></li>
<li><a href="Apple_T2_Security_Chip_Overview.pdf">Apple T2 安全芯片概览</a></li>
<li><a href="Apple-File-System-Reference.pdf">APFS 文件系统参考手册</a></li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/10/18/%E5%AF%86%E9%92%A5%E6%B4%BE%E7%94%9F%E5%87%BD%E6%95%B0%EF%BC%88KDF%EF%BC%89%E6%A6%82%E8%BF%B0/" rel="prev" title="密钥派生函数（KDF）概述">
                  <i class="fa fa-angle-left"></i> 密钥派生函数（KDF）概述
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/11/13/Apple%E6%95%B0%E6%8D%AE%E4%BF%9D%E6%8A%A4%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98%E4%B9%8B%E4%BA%8C%EF%BC%9A%E5%AF%86%E9%92%A5%E5%B1%82%E7%BA%A7/" rel="next" title="Apple数据保护技术专题之二：密钥层级">
                  Apple数据保护技术专题之二：密钥层级 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Alex Sun</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">206k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">12:30</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/nokiam9/nokiam9.github.io.git" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>

  <script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"https://cdnjs.cloudflare.com/ajax/libs/pdfobject/2.2.12/pdfobject.min.js","integrity":"sha256-g2xji1rlE3KsGVClvuxTbcR0Kn2+wtQADSff2Tbb4zA="},"url":"/lib/pdf/web/viewer.html"}</script>
  <script src="/js/third-party/tags/pdf.js"></script>

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.5.0/mermaid.min.js","integrity":"sha256-K7oJiQlDulzl24ZUFOywuYme1JqBBvQzK6m8qHjt9Gk="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>





  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
