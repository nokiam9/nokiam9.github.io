---
title: Apple产品安全技术分析之一：硬件安全
date: 2022-07-09 21:55:23
tags:
---

[apple平台安全白皮书](apple平台安全白皮书-2021中文版.pdf)指出，Apple平台安全性的核心理念是：

- 强调硬件、软件和服务的紧密联系和共同协作，即：**平台安全性=硬件+软件+服务**。
    通过Apple设计的芯片和安全性硬件，为关键的安全性功能提供支持
    通过软件保护为操作系统和第三方App提供了安全保障
    通过服务提供安全且及时的软件更新机制，帮助建立受保护的App生态系统，并保障通信和支付的安全
- 为智能终端（iOS）、台式设备（MacOS）、可穿戴设备（WatchOS）和家居设备等不同类型设备提供具备独特性的安全性架构
- 三个目标：高安全性、透明用户体验和个人信息安全

## TEE可信计算环境

![framework](framework.png)

### 安全非易失性存储器

安全隔区配备了专用的安全非易失性存储器设备。 安全非易失性存储器通过专用的 I2C 总线与安全隔区连接， 因此它仅可被安全隔区访问。 所有用户数据加密密钥植根于储存在安全隔区非易失性存储器中的熵内。
搭载 A12、 S4 及后续型号 SoC 的设备并用了安全隔区与安全储存组件来储存熵。 安全储存组件本身设计为 使用不可更改的 ROM 代码、 硬件随机数生成器、 每个设备唯一的加密密钥、 加密引擎和物理篡改检测。 安全 隔区和安全储存组件使用加密且认证的协议通信以提供对熵的独有访问权限。

2020 年秋季或之后首次发布的设备配备了第二代安全储存组件。 第二代安全储存组件增加了计数器加密箱。 **每个计数器加密箱储存一个128位盐、 一个128位密码验证器、 一个8位计数器， 以及一个 8位最大尝试值**。 对计数器加密箱的访问通过加密且认证的协议来实现。
计数器加密箱中含有所需用于解锁受密码保护用户数据的熵。 若要访问用户数据， 配对的安全隔区必须从用户 的密码和安全隔区的 UID 中派生出正确的密码熵值。 从除配对安全隔区之外其他来源发送的解锁尝试均无法 获知用户的密码。 如果密码的尝试次数超过限制 (例如， 在 iPhone 上为 10 次)， 安全储存组件就会完全抹 掉受密码保护的数据。
为了创建计数器加密箱， 安全隔区会向安全储存组件发送密码熵值和最大尝试次数值。 安全储存组件会使用其 随机数生成器生成盐值。 之后通过提供的密码熵、 安全储存组件的唯一加密密钥和盐值派生出密码验证器值和 加密箱熵值。 安全储存组件使用计数 0、 提供的最大尝试次数值、 派生的密码验证器值和盐值来初始化计数器 加密箱。 之后安全储存组件将生成的加密箱熵值返回到安全隔区。
为了稍后从计数器加密箱中取回加密箱熵值， 安全隔区会向安全储存组件发送密码熵。 安全储存组件会先为加 密箱递增计数器。 如果递增后的计数器超过最大尝试次数值， 安全储存组件就会完全抹掉计数器加密箱。 如果 尚未达到最大尝试次数， 安全储存组件会尝试通过与用于创建计数器加密箱相同的算法来派生出密码验证器 值和加密箱熵值。 如果派生的密码验证器值匹配所储存的密码验证器值， 安全储存组件会将加密箱熵值返回到 安全隔区并将计数器重设为 0。
用于访问受密码保护数据的密钥植根于计数器加密箱所储存的熵中。 有关更多信息， 请参阅数据保护概览。

安全隔区中的所有反重放服务均使用了安全非易失性存储器。 安全隔区上的反重放服务用于在发生以下标记反重放边界的事件时撤销数据， 这些事件包括但不限于 :
• 更改密码
• 启用或停用触控 ID 或面容 ID
• 添加或移除触控 ID 指纹或面容 ID 面容
• 重设触控 ID 或面容 ID
• 添加或移除 Apple Pay 卡片
• 抹掉所有内容和设置
在未配备安全储存组件的架构上， EEPROM (电可擦除可编程只读存储器) 被用于为安全隔区提供安全储存 服务。 跟安全储存组件类似， EEPROM 连接到安全隔区并仅可从安全隔区访问， 但其不包含专用的硬件安全 性功能， 不能确保对熵的独有访问权限 (除了其物理连接特性)， 也不具备计数器加密箱功能。

### 熵源

内核 CPRNG 源自启动过程中的多个熵源并存在于设备的整个生命周期。 这些来源包括 (取决于可用性):

- 安全隔区硬件 TRNG
- 启动过程中所收集基于时序的时间误差
- 从硬件中断收集的熵
- 用于启动过程中保持熵的种子文件
- Intel 随机指令， 例如 RDSEED 和 RDRAND (仅限基于 Intel 的 Mac)

### 内核 CPRNG

内核 CPRNG 的设计源自 Fortuna 算法， 旨在满足 256 位安全级别。 它使用以下 API 为用户空间使用者
提供高质量的随机数 :
• getentropy(2) 系统调用
• 随机设备 (/dev/random)
内核 CPRNG 通过写入随机设备接受用户提供的熵。

### 安全存储组件

NAND存储的专用区域，用于存储加密密钥，可以直接寻址并安全擦除。虽然如果攻击者实际拥有设备，它不会提供保护，但保存在可擦除存储中的密钥可以用作密钥层次结构的一部分，以促进快速擦除和转发安全。