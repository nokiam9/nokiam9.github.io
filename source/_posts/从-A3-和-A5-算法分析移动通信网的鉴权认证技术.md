---
title: 从 A3 和 A5 算法分析移动通信网的鉴权认证技术
date: 2023-04-09 19:31:50
tags:
---

## GSM 采用的 COMP128-1 算法

COMP128 - Details

1. x[16-31] = RAND
2. for 0<i<8
     x[0-15] = Ki
     call Compression (5 rounds)
     call FormBitsFromBytes
     if i<7 call Permute

Compress 16-byte result to 12-bytes, store in simoutput[] and return.

``` c
void comp128v1(const uint8_t *ki, const uint8_t *rand, uint8_t *sres, uint8_t *kc)
{
    int i;
    uint8_t x[32], bits[128];

    /* x[16-31] = RAND */
    memcpy(&x[16], rand, 16);

    /* Round 1-7 */
    for (i=0; i<7; i++) {
        /* x[0-15] = Ki */
        memcpy(x, ki, 16);

        /* Compression */
        _comp128_compression(x);

        /* FormBitFromBytes */
        _comp128_bitsfrombytes(x, bits);

        /* Permutation */
        _comp128_permutation(x, bits);
    }

    /* Round 8 (final) */
    /* x[0-15] = Ki */
    memcpy(x, ki, 16);

    /* Compression */
    comp128_compression(x);

    /* Output stage */
    for (i=0; i<8; i+=2)
        sres[i>>1] = x[i]<<4 | x[i+1];

    for (i=0; i<12; i+=2)
        kc[i>>1] = (x[i + 18] << 6) |
                   (x[i + 19] << 2) |
                   (x[i + 20] >> 2);

    kc[6] = (x[30]<<6) | (x[31]<<2);
    kc[7] = 0;
}
```

通常来说，在这个6步的过程里面同时实现了认证和会话密钥协商，称为AKA（Authentication and Key Agreement，会话与密钥协商）协议。

COMP128-1算法的设计较为简单，其实现仅需20行代码；在最初设计与使用时，由所有参与方签订MoU协议对方法进行保密。但在1998年算法被泄露，随即在1999年即被破解，在2000年即出现了对应的SIM卡破解软件。

由于输入的信息（128bits）大于输出的信息（96bits,即SRES+Kc），因此必然会出现不同的输入产生相同的输出，我们称为“碰撞”。而且由于字节压缩得很厉害，很容易找到“碰撞”；最初的破解中，攻击者输入大量连续的数据就能轻易获得碰撞，以此来推算出密钥Ki。一旦计算出Ki，SIM卡就可被复制。因此，对SIM卡的破解并不是从智能卡中读取了机密信息，而是利用算法的脆弱性实施了计算破解。

此后，中国移动在2003、2008又两次对COMP128-1算法进行了增强，其中2008年自主研发的“防克隆SIM卡”具有对攻击的主动防御能力，有力保障了SIM卡的安全使用至今。

![GSM网络鉴权原理](GSM.jpg)

## CDMA 采用的 算法

CDMA 系统的鉴权流程在 IS-41 MAP 中被详细定义。
CDMA 系统中用于移动台鉴权的密码分为两级，第一级为移动台的密钥 A_Key，第二级为共享加密数据(SSD，shared secret data)。

- 密钥 A_Key是高级密码，长度为 64 bit，由运营商分配，它和 IMSI 一同被写入移动终端永久性存储器中。
    同时，运营商核心网存储该用户的 IMSI 和对应的 A_Key。该密钥是永久性的，不在网络和空中信道上传播。
- SSD 是低级密码，长为 128 bit(分为 SSD_A 为 64 bit 和 SSD_B 为 64 bit)，它由A_Key 运算产生，存在于移动台、鉴权中心和拜访者位置寄存器。
    在鉴权过程中，核心网使用RAND 和 SSD_A 计算出期望的响应 AUTHx，倘若移动终端计算的 AUTHx(用 RAND 和 SSD_A计算所得)和核心网计算的 AUTHx 相同，则鉴权成功，攻击者因没有正确有效的 SSD 值，无法计算得到核心网所期望的 AUTHx 值导致鉴权 失败]。

## 3G 的算法

## 4G 的算法

## 5G 的算法

---

## 参考文献

- [移动通信网中的密码算法演进 (三)：认证篇](https://www.secrss.com/articles/36564)
- [移动通信网鉴权认证综述 - 胡鑫鑫](移动通信网鉴权认证综述_胡鑫鑫.pdf)
- [COMP128算法源码 - Github](https://github.com/osmocom/libosmocore/blob/master/src/gsm/comp128.c)
- [GSM SIM卡算法COMP128生日攻击原理 - 知乎](https://zhuanlan.zhihu.com/p/528866024)
- [COMP128算法分析中关键问题研究 - 汪涛](chinois.pdf)
- [COMP128: A Birthday Surprise - Stuart Wray](comp128-a-birthday-surprise-rev.pdf)
