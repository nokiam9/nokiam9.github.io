---
title: Apple Data Protection的硬件加密分析
date: 2024-03-04 21:23:05
tags:
---

根据 Apple 官网提供的[第三方平台认证信息](https://support.apple.com/zh-cn/guide/certifications/welcome/web)，其硬件、操作系统、应用软件、互联网服务和 Apple Pay 均符合 FIPS 140-2 认证，但 FIPS 140-3 认证仍在进行中，[安全隔区的加密模块报告](Apple_Secure_Key_Store_Cryptographic_Module_v10.0.pdf)的最新版本是 v10.0。
此外，Apple 也符合通用标准 (CC) 认证，并委托知名评估机构 [ATSEC 公司](https://www.atsec.com)出具了[iOS 16 安全评估报告 TOE - Target of Evaluation](https://www.niap-ccevs.org/MMO/Product/st_vid11349-st.pdf)，当前版本是 v1.1。
本文就是依据上述公开信息的研究分析。

## 一、整体架构

Cocoa 是苹果公司为 macOS 所创建的原生面向对象的应用程序接口，是 Mac OS X 上五大 AP 之一（其它四个是Carbon、POSIX、X11和Java）。

Cocoa 应用程序一般在苹果公司的开发工具 Xcode（前身为 Project Builder ）和 Interface Builder 上用Objective-C 写成。

Cocoa包含三个主要的Objective-C对象库，称为“框架”。框架的功能类似于动态库，即可以在运行时动态的加载应用程序的地址空间，但框架作为一个捆绑而非独立文件，其中除了可执行代码外，也包含了资源，头文件和文档。

“Foundation工具包”，或简称为“Foundation”，首先出现在OpenStep中。在Mac OS X中，它是基于Core Foundation的。作为通用的面向对象的函数库，Foundation提供了字符串，数值的管理，容器及其枚举，分布式计算，事件循环，以及一些其它的与图形用户界面没有直接关系的功能。其中用于类和常数的“NS”前缀来自于Cocoa的来源，NeXTSTEP。它可以在Mac OS X和iOS中使用。
“应用程序工具包”，或称AppKit（Application Kit）是直接派生自NeXTSTEP的AppKit的。它包含了程序与图形用户界面交互所需的代码。它是基于Foundation创建的，也使用“NS”前缀。它只能在Mac OS X中使用。
“用户界面工具包”，或称UIKit（User Interface Kit），是用于iOS的图形用户界面工具包。与AppKit不同，它使用“UI”的前缀。

根据[iOS 16 安全评估报告](Apple_iOS_16_iPhone_Security_Target.pdf)的表述，其提供三个层次的加密服务：

- User Space：SL1，软件级。驻留在用户空间内的动态可加载库，为 App 提供加密功能
- Kernel Space：SL1，软件级。操作系统内核加载的扩展模块，仅为内核提供加密功能
- Secure Key Store：SL2，硬件级，也称为 SKS（安全密钥存储）。一个单芯片独立硬件加密模块，为传输中和静态数据提供保护，包含固件和硬件加密算法实现

![SKS](SKS-arch.png)

- HW：hardware，硬件；
- POST：Power-On Self Test，启动自检；
- OTP-ROM：One Time Programmable Read-Only Memory，一次性编程的只读内存，即熔丝；
- DRBG，Deterministic Random Bit Generator，确定性随机位生成器，即伪随机发生器

在具有A12、S4和更高版本SoC的设备中，安全飞地与用于熵存储的安全存储组件配对。
安全存储组件本身设计有：不可变的ROM代码、硬件随机数生成器、每个设备唯一的加密密钥、加密引擎和物理篡改检测。

2020年秋季或以后首次发布的设备配备了第二代安全存储组件。
第二代安全存储组件增加了计数器锁箱。
每个计数器锁箱存储128位salt、128位密码验证器、8位计数器和8位最大尝试值。

---

![TOC](<TOC-key.png>)

### 安全隔区 AES 引擎

安全隔区 AES 引擎是一个硬件块， 用于基于 AES 密码来执行对称加密。 AES 引擎设计用于防范通过时序和静态功耗分析 (SPA) 泄露信息。 从 A9 SoC 开始， AES 引擎还包括动态功耗分析 (DPA) 对策。
AES 引擎支持硬件密钥和软件密钥。 **硬件密钥派生自安全隔区 UID 或 GID**。 这些密钥保存在 AES 引擎内，即使对 sepOS 软件也不可见。 虽然软件可以请求通过硬件密钥进行加密和解密操作， 但不能提取密钥。

### AES 引擎

每台包含安全隔区的 Apple 设备还具有专用的 AES256 加密引擎 （“AES 引擎”）， 它内置于 NAND（非易失性） 闪存与主系统内存之间的直接内存访问 (DMA) 路径中， 可以实现高效的文件加密。 在 A9或后续型号的 A 系列处理器上， 闪存子系统位于隔离的总线上， 该总线被授权只能通过 DMA 加密引擎访问包含用户数据的内存。

启动时， sepOS 会使用 TRNG 生成一个**临时封装密钥**。 安全隔区**使用专用线**将此密钥传输到 AES 引擎，旨在防止它被安全隔区外的任何软件访问。 sepOS 随后可以使用临时封装密钥来封装文件密钥， 供应用程序处理器文件系统驱动程序使用。 当文件系统驱动程序读取或写入文件时， 它会将封装的密钥发送到 AES 引擎以解封密钥。 AES 引擎绝不会将未封装的密钥透露给软件。

### 安全非易失性存储器 - Secure nonvolatile storage

安全隔区配备了专用的安全非易失性存储器设备。 安全非易失性存储器通过专用的 I2C 总线与安全隔区连接，因此它仅可被安全隔区访问。**所有用户数据加密密钥植根于储存在安全隔区非易失性存储器中的熵内**。

搭载 A12、 S4 及后续型号 SoC 的设备并用了安全隔区与安全储存组件来储存熵。 安全储存组件本身设计为使用：

- 不可更改的 ROM 代码
- 硬件随机数生成器
- **每个设备唯一的加密密钥**
- 加密引擎
- 物理篡改检测
- 计数器加密箱（第二代增加）：包含 salt、verify、counter、max_retry_limit

安全隔区和安全储存组件使用加密且认证的协议通信以提供对熵的独有访问权限。

2020 年秋季或之后首次发布的设备配备了**第二代安全储存组件**。 第二代安全储存组件增加了计数器加密箱。每个计数器加密箱储存一个 128 位**盐**、 一个 128 位**密码验证器**、 一个 8 位计数器， 以及一个 8 位最大尝试值。 对计数器加密箱的访问通过加密且认证的协议来实现。

计数器加密箱中含有所需用于解锁受密码保护用户数据的熵。 若要访问用户数据， 配对的安全隔区必须从用户的密码和安全隔区的 UID 中派生出正确的密码熵值。 从除配对安全隔区之外其他来源发送的解锁尝试均无法获知用户的密码。 如果密码的尝试次数超过限制 （例如， 在 iPhone 上为 10 次）， 安全储存组件就会完全抹掉受密码保护的数据。

为了创建计数器加密箱， 安全隔区会向安全储存组件发送密码熵值和最大尝试次数值。 安全储存组件会**使用其随机数生成器生成盐值**。 之后**通过提供的密码熵、 安全储存组件的唯一加密密钥和盐值派生出密码验证器值和加密箱熵值**。 安全储存组件使用计数 0、 提供的最大尝试次数值、 派生的密码验证器值和盐值来初始化计数器加密箱。 之后安全储存组件将生成的加密箱熵值返回到安全隔区。

为了稍后从计数器加密箱中取回加密箱熵值， 安全隔区会向安全储存组件发送密码熵。 安全储存组件会先为加密箱递增计数器。 如果递增后的计数器超过最大尝试次数值， 安全储存组件就会完全抹掉计数器加密箱。 如果尚未达到最大尝试次数， 安全储存组件会尝试通过与用于创建计数器加密箱相同的算法来派生出密码验证器值和加密箱熵值。 如果派生的密码验证器值匹配所储存的密码验证器值， 安全储存组件会将加密箱熵值返回到安全隔区并将计数器重设为 0。

用于访问受密码保护数据的密钥植根于计数器加密箱所储存的熵中。 有关更多信息， 请参阅数据保护概览。
安全隔区中的所有反重放服务均使用了安全非易失性存储器。 安全隔区上的反重放服务用于在发生以下标记反重放边界的事件时撤销数据， 这些事件包括但不限于 ：
• 更改密码
• 启用或停用触控 ID 或面容 ID
• 添加或移除触控 ID 指纹或面容 ID 面容
• 重设触控 ID 或面容 ID
• 添加或移除 Apple Pay 卡片
• 抹掉所有内容和设置

在未配备安全储存组件的架构上， EEPROM （电可擦除可编程只读存储器） 被用于为安全隔区提供安全储存服务。 跟安全储存组件类似， EEPROM 连接到安全隔区并仅可从安全隔区访问， 但其不包含专用的硬件安全性功能， 不能确保对熵的独有访问权限 （除了其物理连接特性）， 也不具备计数器加密箱功能。

### Effaceable Storage - 可擦除存储器

NAND 存储器中一个用于储存加密密钥的专用区域，可被直接寻址和安全擦除。尽管当攻击者实际占有设备时，可擦除存储器无法提供保护，但其中存储的密钥可用作密钥层级的一部分，用于实现快速擦除和前向安全性。

### Secure Storage Component - 安全储存组件

芯片设计为使用不可更改的 RO 代码、硬件随机数生成器、加密引擎和物理篡改检测。在支持的设备上，安全隔区与用于储存反重放随机数的安全储存组件配对。为了读取和更新随机数，安全隔区和储存芯片采用安全协议来帮助确保对随机数的排他访问。此技术已更迭多代，提供了不同的安全性保证。

#### User keybag - 用户密钥包

用户密钥包是设备常规操作中使用的封装类密钥的储存位置。例如，输入密码后，`NSFileProtectionComplete`会从用户密钥包中载入并解封。 它是储存在 “无保护” 类中的二进制属性列表 (.plist) 文件。

- 对于搭载 A9 之前的 SoC 的设备，该 .plist **文件的内容通过保存在可擦除存储器中的密钥加密**。为了给密钥包提供前向安全性，用户每次更改密时， 系统都会擦除并重新生成此密钥。
    > `BAG1 Key`负责对密钥包的内容加密
- 对于搭载 A9 或后续型号 SoC 的设备，该 .plist 文件包含一个**密钥**，表示密钥包储存在受**反重放随机数**（由安全隔区控制）保护的有锁储存库中。
    > Besides unlocking the device, a passcode or password provides entropy for certain encryption keys.
    > 表明`the passcode entropy`就是 pasccode，而用户密钥包中存储的密钥就是`the lockbox entropy`

安全隔区管理用户密钥包并且可用于查询设备的锁定状态。 仅当用户密钥包中的所有类密钥均可访问且成功解封时， 它才会报告设备已解锁。

#### Device Keybag - 设备密钥包

设备密钥包用来储存用于涉及设备特定操作数据的封装类密钥。

- 配置为共用的 iPadOS 设备有时需要在用户登录前访问凭证 ；因此，需要一个不受用户密码保护的密钥包。
- iOS 和 iPadOS 不支持对用户独有的文件系统内容进行单独加密，这就意味着系统使用来自设备密钥包的类密钥，对文件独有密钥进行封装。而钥匙串则使用来自用户密钥包中的类密钥来保护用户钥匙串中的项目。
- 在配置为单用户使用 （默认配置） 的 iOS 和 iPadOS 设备中，**设备密钥包和用户密钥包是同一个**，并受用户的密码保护。

When stored, the encrypted file system key is additionally wrapped by an “effaceable key” stored in Effaceable Storage **or** using a media key-wrapping key, protected by Secure Enclave anti-replay mechanism.
> EMF Key 的存储方式发生变化？

NSFileProtectionNone: This class key is protected only with the UID, and is kept in Effaceable Storage.
> 就是 DKey，存储在 Effaceable Storage
---

|SoC|内存保护引擎|安全储存区|AES 引擎| PKA|备注|
|:---:|:---:|:---:|:---:|:---:|:---:|
|A8|加密,认证|EEPROM|是|否||
|A9|加密,认证|EEPROM|DPA保护|是||
|A10|加密,认证|EEPROM|DPA保护、可锁定的种子位|操作系统绑定密钥||
|A11|加密,认证,反重放| EEPROM|DPA保护、可锁定的种子位|操作系统绑定密钥||
|A12|加密,认证,反重放|安全储存组件(第一、二代)| DPA保护、可锁定的种子位| 操作系统绑定密钥|2020年秋季升级|
|A13|加密,认证,反重放|安全储存组件(第一、二代)|DPA 保护、可锁定的种子位|操作系统绑定密钥和启动监视器|2020年秋季升级|


## 参考文献
