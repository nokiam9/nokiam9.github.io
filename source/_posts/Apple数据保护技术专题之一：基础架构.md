---
title: Apple数据保护技术专题之一：基础架构
date: 2022-11-13 14:34:06
tags:
---

安全启动链、系统安全性和App安全性功能有助于验证只有受信任的代码及App可以在设备上运行，但Apple还需要更多加密功能实现用户数据的安全保护，主要挑战包括：

1. iPhone等移动终端设备保存通讯录、照片等大量个人信息，与Mac相比，对数据安全保护的要求更高、更细致；
2. App Store、iCloud、在线软件升级等云服务大量出现，网络开放环境下如何平衡数据安全和服务便利的矛盾；
3. 跨平台的生态系统需要密切协同，多个不同设备之间如何解决服务协同与数据安全的矛盾；


APFS号称是针对SSD等新型设备专门设计（也兼容传统硬盘），提供Copy-on-Write、系统快照、动态分区调整、稀疏大文件支持等功能，但与业界最优秀的ZFS相比并无优势，唯一值得表扬的是，结合Apple封闭硬件体系的优势，数据加密功能大大提升，iPhone再也不怕被执法机构读取数据了。

目前，iOS 和iPadOS设备使用称为数据保护（Data Protection）的文件加密方法，基于Intel的Mac设备通过文件保险箱（FileVault）的宗卷加密技术进行数据保护，搭载Apple芯片的Mac设备使用两者的混合模型，但具体功能上有所差异。
此外，Apple还使用操作系统内核强制执行保护和安全措施。内核使用访问控制来沙盒化App(限制App可访问的数据)，还使用一种称为数据保险箱的机制来限制所有其他提出请求的App访问某一App 的数据(而不是限制某个App可进行的调用)。


长期以来 Apple 公司有两条数据安全的技术演进路线，iPhone 和 iPad 等智能终端设备使用称为**数据保护（Data Protection）**的文件加密方法，基于Intel的Mac设备通过**文件保险箱（FileVault）**的宗卷加密技术，造成这种问题的原因有：

1. MacOS 是基于 FreeBSD 发展而来，基础架构是一个多用户的操作系统，但 iPhone 等作为个人化的终端设备，无需支持多用户，但非常强调个人数据的隐私保护，产品定位导致业务需求存在明显差异；
2. iOS 是在 MacOS 的基础上改进而来，但受限于 MacOS 的底层技术架构，尤其是被称为业界最烂的文件系统 - **HFS+**，许多急需的新功能只能通过纯软件的方法强行实现；
3. iPhone 很早就采用自研芯片，非常有利于制定软硬件一体化的解决方案，而 MacOS 受到 Intel CPU 的限制，兼容性要求导致技术演进存在障碍。



随着 M1 自研芯片的推出，两条技术路线正在逐步融合，搭载 Apple 芯片的 Mac 设备已经使用两者的混合模型，相信未来 FileVault 技术将逐步退出，因此本文主要研究Data Protection 技术。根据Apple 官方文档，其主要设计目标包括：

- 在硬件被改动的情况下也能保护数据（替换组件/直接读取闪存等）
- 对抗离线攻击（物理方式获取闪存内的数据后用更强大的计算设备进行破解）
- 对不同的数据提供不同级别的保护（锁屏之后有些数据要保护，有些数据还需要访问）
- 需要时能够快速安全清除所有数据
- 考虑性能和功耗