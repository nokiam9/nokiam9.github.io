---
title: V8引擎技术简介
date: 2021-11-05 11:34:43
tags:
---

## 早期版本

早期 V8 引擎有`Full-Codegen`和 `Crankshaft`(曲轴) 两个编译器。V8 首先用 Full-Codegen 把所有的代码都编译一次，生成基准机器码。JS 在执行的过程中，V8 内置的 Profiler 分析器筛选出热点函数并且记录参数的反馈类型，然后解析再次生成 AST 交给 Crankshaft 来进行优化。所以 Full-Codegen 本质上是生成的是未优化的机器码，而 Crankshaft 生成的是优化过的机器码。

{% asset_img v8-arch-0.png %}

javascript 会被解析两次，第一次用于 Full-Codegen 生成机器码，而第二次用于 Crankshaft 进行优化
Full-Codegen 生成机器码会占用大量内存，一个 1M 左右 的 js 源码的文件，编译生成的二进制代码可能就是十几 M，而早期手机的内存普遍不高，过度占用会导致性能大大降低
而且为了兼容不同架构 CPU Full-Codegen引擎以及优化编译的Crankshaft引擎要针对不同的CPU架构编写代码



## 现代版本

新版本的 V8 进行重大改变
2017年，Google完全废弃并移除了`full-codegen`和 `Crankshaft`，v8 的 5.9 版本发布了，新增了一个 `Ignition`（点火器） 字节码解释器，将默认启动。
Ignition 引擎可以对字节码进行解释执行，那就是说他的功能类似于Java的JVM，本质上就是一个虚拟机。 开始逐句对字节码进行解释成二进制代码并执行。在解释执行的过程中，标记重复执行的热点代码，将标记的代码通过`Turbofan`（涡轮风扇）引擎进行编译生成效率更高二进制代码，再次运行到这个函数时便只执行高效代码而不再解释执行字节码。

{% asset_img v8-arch.png %}

{% asset_img v8.jpg %}

{% asset_img bytecode.png %}

---

## 参考文献

- [V8引擎的十年之路 - 官方网站](https://v8.dev/blog/10-years)
- [深入理解JavaScript的V8引擎 - 系列之一](https://juejin.cn/post/6984302939095449608)
- [深入了解 JavaScript 引擎精华](https://juejin.cn/post/6844903622333956103)

- [Java即时编译器原理解析及实践 - 美团技术](https://tech.meituan.com/2020/10/22/java-jit-practice-in-meituan.html)
- [关于Jvm知识看这一篇就够了](https://zhuanlan.zhihu.com/p/34426768)
- 《深入理解Java虚拟机：JVM高级特性与最佳实践》 周志明 著
