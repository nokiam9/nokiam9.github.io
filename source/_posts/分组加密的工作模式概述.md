---
title: 分组加密的工作模式概述
date: 2022-12-17 16:26:07
tags:
---
## 一、背景

在密码学中，有一个基本的分类就是：对称加密 Vs 非对称加密。

- 如果使用**相同的密钥**进行消息的加密与解密（算法不一定相同，例如函数 & 逆函数），就是对称加密算法（也称为ciphers），例如：DES、3DES、AES、Blowfish、IDEA、RC5、RC6...
- 否则，就是非对称加密算法，通常需要一个密钥对：公钥 (public key) + 私钥 (private key)，分别用于加密和解密，例如：RSA、DSA、ECC、DH...

关于对称加密算法，可以进一步细分为：分组加密算法 Vs 流密码算法。

- 流密码算法（Stream Cipher）就是将明文按字节与密钥相对应，逐位地做约定的运算（通常是 XOR ）从而获得密文流，包括 RC4 和 GSM 等
- 分组密码算法（Block Cipher）每次只能加密固定大小的块（例如 128 位），包括 AES、ChaCha20、Twofish、IDEA、Serpent、Camelia、RC6、CAST 等

|流密码（Stream Cipher）|分组密码|
|:-:|:-:|
|按比特流顺序加密，完全串行化|按分组长度分批加密，需要处理碎片padding|
|网络数据传输是典型场景|磁盘文件加密是典型场景|
|多数基于专用电路，算法种类较少|提供软件代码实现，算法种类丰富|
|速度快，CPU资源开销少|纯软件实现消耗较多CPU资源，主流算法有指令集支持|
|根据是否依赖先前的密文，分为同步/异步模式|通过工作模式技术转换为流密码，有的支持并行化|
|加密和解密的算法一致，有利于硬件复用|加密和解密的算法不一定相同|

通过使用称为**分组密码工作模式**的技术，可以将分组密码算法转换为流密码算法。
> 工作模式与具体的对称加密算法无关！

注意！明文数据长度很有可能不等于分组长度的倍数，如何有效处理碎片问题，请参见附录一。

## 二、基础的 ECB 模式（Electronic codebook，电子密码本）

ECB 模式就是传统的密码本方式，将整个明文分成若干段相同的小段，然后使用同一个密钥对每一小段进行加密。
ECB 模式的技术实现简单明了，而且有一个潜在的好处，就是加密和解密都可以并行处理，如果在传输过程中出现误码，一般只影响当前块。

![ECB](ECB.png)

ECB 模式存在着严重的安全隐患，相同的明文块会被加密成相同的密文块，即著名的明文攻击问题！下图演示了一个图像文件通过 ECB 模式的加密结果。
![明文攻击](plaintext-attack.png)

造成明文攻击的根本原因，是用单一密钥对多个明文分组进行加密，但如果仅仅使用一个或者少量的分组（例如加密密钥传输等场景），ECB 模式仍然是安全的。

## 三、改进的分组工作模式

造成选择明文攻击的，解决方案就是增加随机数作为密钥的加密因子。

- CBC 模式引入了初始向量 IV（initialization vector）。
    IV 与 Plaintext 执行异或，并作为分组加密函数的第一次输入，可以实现”相同明文不同密文“
- CFB & OFB 模式同样引入了 IV，但用途有所差异。
    IV 用于流密码构造函数的第一次输入，同样实现”相同明文不同密文“
- CTR 模式的处理方式更简单，直接引入计数器 Counter 作为 IV。
    注意，CTR 模式的每个分组都需要将 Counter 作为输入，而非仅是第一次。

> 在信息长度小于分组长度的场景下（如密钥传输），ECB 模式仍然是安全的。



## 三、 如何实现随机读取的解密？也就是是否并行处理的问题


## 四、 关于传输误码的容错能力

OFB 模式的优点在于 OFB 模式不会出现误码传播，即由于的错误而导致之后明文分组的错误，这从图 4 中可以清晰地观察到。
OFB模式要求在给定密钥下加密的每条消息都有一个唯一的IV。如果与此要求相反，同一个IV用于多个消息的加密，那么这些消息的机密性可能会受到损害。

---


高级加密标准（Advanced Encryption Standard: AES）是美国国家标准与技术研究院（NIST）在2001年建立了电子数据的加密规范。其是对称加解密算法的最经典算法之一，它是一种分组加密标准，每个加密块大小为128位，允许的密钥长度为128、192和256位。这里只介绍ECB、CBC、CFB和OFB四种加密模式。

其实现的数据加密算法有字节代替（SubBytes）、行移位（ShiftRows）、列混淆（MixColumns）、轮密钥加（AddRoundKey）几种

|工作模式|ECB|CBC|CFB|OFB|CTR|
|:-:|:-:|:-:|:-:|:-:|:-:|
|对抗明文攻击|否|IV & 密文|IV & 密文|IV & 密钥输出|Counter|
|转换为流密码|否|否|是|是|是|
|加密并行处理|是|否|否|否|是|
|支持随机访问解密|是|是|否|否|是|


## 一、基础的工作模式

### 1. ECB（Electronic codebook，电子密码本模式）



### 2. CBC（Cipher-block chaining，密码块链接模式）

![CBC](CBC.png)

- 通过引入初始向量 IV，相同明文不同密文，可以对抗明文攻击
- 加密处理不可并行，但解密处理可以并行；
- 如果出现传输错误，那么后续结果解密后可能全部错误
- 预初始值IV可预测，敌⽅方可构建⽔水印(watermark)
- 适合场景：面向分组的通⽤用传输; 认证

CBC算法优点：
串行化运算，
CBC算法缺点：
需要初始向量，不过这其实不算缺点，下文的CTR也是需要随机数的。

### 3. CFB（Cipher feedback，密文反馈模式）

![CFB](CFB.png)

主要优势：可视为流密码，节省传输能⼒
重要缺陷：
业务场景：面向分组的通⽤用传输; 认证

### 4. OFB（Output feedback, 输出反馈模式）

![OFB](OFB.png)

主要优势：与CFB相似；传输时某位错误不不会影响其他位
重要缺陷：抗消息流篡改攻击不不如CFB
业务场景：噪声信道的传输

### 5. CTR（Counter，计数器模式）

CTR模式（ mode，CM）也被称为ICM模式（Integer Counter Mode，整数计数模式）和SIC模式（Segmented Integer Counter）

![CTR](CTR.png)

主要优势：并⾏行行性、预处理理、随机读写；可证明安全；简单性
重要缺陷：
：⾯面向分组的通⽤用传输; 高速要求

## 二、增强的工作模式

### 1. GCM

![GCM](GCM.png)

### 2. AES-XTS（XEX-based tweaked-codebook mode with ciphertext stealing）

XTS-AES 要求:• 
• 密⽂文应该与明⽂文⼤大⼩小相同，从⽽而不不改变数据的布局
• 数据分组可单独访问，且相互独⽴立
• 加密分组⼤大⼩小为16字节
• 没有使⽤用其他元数据(除了了数据分组的位置)
• 不不同位置 相同明⽂文 ==》密⽂文不不同
• 符合标准的加解密设备可以相互通⽤用

业务场景：Mac OS X Lion's FileVault 2，Windows 10's BitLocker



## 一、分组加密算法 Vs 流加密算法

对称加密算法主要包括两类：分组密码和流密码，存在明显的技术差异：



分组密码	流密码
对称密钥密码，用于对固定大小的块中的数据进行加密和解密。	对称密钥密码是有状态密码，可对数据进行逐位加密和解密。
处理速度较慢。	处理速度更快。
需要更多资源。	需要更少的资源。
通过某些操作模式可以具有流密码属性。	无法采用分组密码属性。
依靠无状态和有状态操作模式，包括 ECB，CBC，CFB，OFB，CTR，GCM 和 XTS。	可以是同步的或异步的。
几乎到处使用。	用于某些数据在途加密，包括某些 SSL / TLS 密码套件。


一般来说，流密码的特点是按比特位进行加密，适合于网络数据传输的业务场景，而分组密码是按一定长度分批次进行加密，适合于磁盘文件加密的业务场景。
Stream Cipher 按 bit 加密的技术特点，非常适合

### 分组密码算法（Block Cipher）

也称为块密码算法。这种算法一次只能加密固定大小的块（例如 128 位），适用于磁盘文件的数据加密。
![bolck cipher](block-cipher.png)
分组加密算法可以设计非常复杂的逻辑处理，加密强度较高，但也需要消耗较多硬件资源。
绝大多数对称加密算法都是分组加密算法，，但常见算法包括：

- 数据加密标准（DES）
- 三重 DES（3DES 或 TDEA）
- 高级加密标准（AES）
- 国际数据加密算法（IDEA）
- 河豚，
- Twofish
- RC5

通常将明文消息分解为固定大小的块，然后使用密钥将其转换为密文。即：通过使用**分组密码工作模式**，可以将分组密码算法转换为流密码算法！

### 流密码算法（Stream Cipher）

可对数据进行逐位加密和解密，将明文数据逐字节地加密为密文流，而不必等待指定长度的数据块形成，这与流媒体服务非常相似，经常用于某些数据在途加密，包括 SSL / TLS 密码套件、蓝牙连接、蜂窝和 4G 连接等重要业务场景。流密码实际上是如何在技术上起作用的呢？

- 基于加密密钥（Key）和种子（Nonce，随机数），通过特定算法（Stream Cipher）生成一个伪随机比特流（Keystream）
- 该伪随机比特流作为密钥流，与明文输入的一个字节进行异或运算，生成单个字节的密文输出
- 这种重复过程会在每一位明文数据中反复发生，最终生成持续不断的密文输出

![Stream Cipher](stream-cipher.png)

请注意，实际上流密码有同步 / 异步 的两种工作模式，即：

- 同步流密码（也称密钥自动密钥，即 KAK），这些类型的密码独立于任何先前的纯文本或密文生成密钥流。
- 异步流密码（也称自同步流密码，密文自动密钥或 CTAK）。这些密码依赖于先前的密文位来生成密钥流。

一般来说，流算法比分组密码更快更高效，因为它们一次只将一位数据加密为单个符号，而不是整个块。因此，它们更适合于资源较少的设备。同时，由于这种单比特数据方法，这意味着如果一个符号中有错误，则影响下一个符号的可能性较小。常见算法包括：

- Salsa20：软件和硬件均可实现
- ChaCha20：是 Salsa20 的修改版；TLS 1.3支持 ChaCha20
- RC4（**已弃用**）：由美国密码学家罗纳德·李维斯特（Ronald Rivest）在1987年设计的，常用于无线网络。由于RC4算法存在弱点，2015年2月所发布的 RFC 7465 规定禁止在TLS中使用RC4加密算法。
- A5：用于 GSM 蜂窝网络的核心算法

但是，某些流密码容易受到**比特翻转攻击**和**密钥重用攻击**的攻击，为此需要注意不要再次使用相同的精确键-Nonce 组合。

> 由于异或运算（XOR）的**对合性**，加密和解密的计算过程可以完全相同，因此在加密算法中得到广泛应用。

## 二、基础工作模式

密码学中，分组密码的工作模式（mode of operation）允许使用同一个分组密码密钥对多于一块的数据进行加密，并保证其安全性。分组密码自身只能加密长度等于密码分组长度的单块数据，若要加密变长数据，则数据必须先被划分为一些单独的密码块。通常而言，最后一块数据也需要使用合适填充方式将数据扩展到符合密码块大小的长度。一种工作模式描述了加密每一数据块的过程，并常常使用基于一个通常称为初始化向量的附加输入值以进行随机化，以保证安全。

工作模式主要用来进行加密和认证。对加密模式的研究曾经包含数据的完整性保护，即在某些数据被修改后的情况下密码的误差传播特性。后来的研究则将完整性保护作为另一个完全不同的，与加密无关的密码学目标。部分现代的工作模式用有效的方法将加密和认证结合起来，称为认证加密模式。

虽然工作模式通常应用于对称加密，它亦可以应用于公钥加密，例如在原理上对RSA进行处理，但在实用中，公钥密码学通常不用于加密较长的信息，而是使用结合对称加密和公钥加密的混合加密方案。

### 历史和标准化

最早出现的工作模式，ECB，CBC，OFB和CFB可以追溯到1981年[4]。2001年，NIST修订了其早先发布的工作模式任务栏表，加入了AES，并加入了CTR模式[5]。最后，在2010年1月，NIST加入了XTS-AES[6]，而其余的可信模式并没有为NIST所认证。例如CTS是一种密文窃取的模式，许多常见的密码学运行库提供了这种模式。

ECB，CBC，OFB，CFB，CTR和XTS模式仅仅提供了机密性；为了保证加密信息没有被意外修改或恶意篡改，需要采用分离的消息验证码，例如CBC-MAC。密码学社群认识到了对专用的保证完整性的方法的需求，NIST因此提出了HMAC，CMAC和GMAC。HMAC在2002年通过了认证[7]，CMAC在2005年通过[8]，GMAC则在2007年被标准化[9]。

在发现将认证模式与加密模式联合起来的难度之后，密码学社区开始研究结合了加密和认证的单一模式，这种模式被称为认证加密模式（AE，Authenticated Encryption），或称为authenc。AE模式的例子包括CCM[10]，GCM[11]，CWC，EAX，IAPM和OCB。

现在，工作模式为许多国家和国内的标准认证实体所定义，其中最有影响力的来源是美国的NIST，而其它有影响力的组织包括ISO，IEC，IEEE，美国的ANSI，以及IETF。

### 初始化向量（IV）

初始化向量（IV，Initialization Vector）是许多任务作模式中用于将加密随机化的一个位块，由此即使同样的明文被多次加密也会产生不同的密文，避免了较慢的重新产生密钥的过程。

初始化向量与密钥相比有不同的安全性需求，因此IV通常无须保密，然而在大多数情况中，不应当在使用同一密钥的情况下两次使用同一个IV。对于CBC和CFB，重用IV会导致泄露明文首个块的某些信息，亦包括两个不同消息中相同的前缀。对于OFB和CTR而言，重用IV会导致完全失去安全性。另外，在CBC模式中，IV在加密时必须是无法预测的；特别的，在许多实现中使用的产生IV的方法，例如SSL2.0使用的，即采用上一个消息的最后一块密文作为下一个消息的IV，是不安全的。

## 二、基础工作模式

AES五种加密模式（CBC、ECB、CTR、OCF、CFB）.

### 1. ECB（Electronic Codebook Book，电码本模式)



### 2. CTR (Counter，分组模式）

同样将明文/密文拆分成若干个长度固定的分组，但是其算法包含了3个参数：

- 初始向量 IV（Initialization Vector）：也被称作 Salt 或者 Nonce。通常是一个随机数，主要作用是往密文中添加随机性，使同样的明文被多次加密也会产生不同的密文，从而确保密文的不可预测性
- 计数器 Counter: 自增的算子。一般从 0 开始，每次计算都自增 1，相当于一次一密
- 密钥 Key: 对称加密的密钥

CTR模式简单快速，安全可靠，而且可以并行加密，但是在计算器不能维持很长的情况下，密钥只能使用一次。

### 3. CBC（Cipher Block Chaining，密码分组链接模式）

在CBC模式中，。同时，为了保证每条消息的唯一性，在第一个块中需要使用初始化向量。

同样将明文/密文拆分成若干个长度固定的分组，其算法规定：

- 第一个分组需要使用初始化向量 IV 执行异或操作
- 随后的每个明文块，先与前一个密文块进行异或后，再进行加密。即每个密文块都依赖于它前面的所有明文块、

CBC 模式有较好的保密性，但由于依赖关系无法实现并行计算，因此不适合对流数据进行加密。

CBC 模式有较好的保密性，是最常见的工作模式。主要缺点在于加密过程存在依赖关系，无法被并行化，但是解密过程可以被并行化！！！

CBC 模式在固定大小的分组上工作。因此，在将输入数据拆分为分组后，应使用填充算法使最后一个分组的长度一致。大多数应用程序使用 PKCS7 填充方案或 ANSI X.923. 在某些情况下，CBC 阻塞模式可能容易受到「padding oracle」攻击，因此最好避免使用 CBC 模式



### 5. CFB（Cipher FeedBack，密码反馈模式）

类似于CBC，可以将块密码变为自同步的流密码；工作过程亦非常相似，CFB的解密过程几乎就是颠倒的CBC的加密过程：

### 6. OFB（Output FeedBack，输出反馈模式）

这种模式较复杂。

常用的安全块模式是 CBC（密码块链接）、CTR（计数器）和 GCM（伽罗瓦/计数器模式），它们需要一个随机（不可预测的）初始化向量 (IV)，也称为 nonce 或 salt
「CTR（Counter）」块模式在大多数情况下是一个不错的选择，因为它具有很强的安全性和并行处理能力，允许任意输入数据长度（无填充）。但它不提供身份验证和完整性，只提供加密

GCM（Galois/Counter Mode）块模式继承了 CTR 模式的所有优点，并增加了加密消息认证能力。GCM 是在对称密码中实现认证加密的快速有效的方法，强烈推荐

CBC 模式在固定大小的分组上工作。因此，在将输入数据拆分为分组后，应使用填充算法使最后一个分组的长度一致。大多数应用程序使用 PKCS7 填充方案或 ANSI X.923. 在某些情况下，CBC 阻塞模式可能容易受到「padding oracle」攻击，因此最好避免使用 CBC 模式
众所周知的不安全块模式是 ECB（电子密码本），它将相等的输入块加密为相等的输出块（无加密扩散能力）。
CBC、CTR 和 GCM 模式等大多数块都支持「随机访问」解密。比如在视频播放器中的任意时间偏移处寻找，播放加密的视频流
总之，建议使用 CTR (Counter) 或 GCM (Galois/Counter) 分组模式。 其他的分组在某些情况下可能会有所帮助，但很可能有安全隐患，因此除非你很清楚自己在做什么，否则不要使用其他分组模式！

CTR 和 GCM 加密模式有很多优点：它们是安全的（目前没有已知的重大缺陷），可以加密任意长度的数据而无需填充，可以并行加密和解密分组（在多核 CPU 中）并可以直接解密任意一个密文分组。 因此它们适用于加密加密钱包、文档和流视频（用户可以按时间查找）。 GCM 还提供消息认证，是一般情况下密码块模式的推荐选择。

请注意，GCM、CTR 和其他分组模式会泄漏原始消息的长度，因为它们生成的密文长度与明文消息的长度相同。 如果您想避免泄露原始明文长度，可以在加密前向明文添加一些随机字节（额外的填充数据），并在解密后将其删除。


分组密码有五种工作体制：1.电码本模式（Electronic Codebook Book (ECB)）；2.密码分组链接模式（Cipher Block Chaining (CBC)）；3.计算器模式（Counter (CTR)）；4.密码反馈模式（Cipher FeedBack (CFB)）；5.输出反馈模式（Output FeedBack (OFB)）。
以下逐一介绍一下：
1.电码本模式（Electronic Codebook Book (ECB)
    这种模式是将整个明文分成若干段相同的小段，然后对每一小段进行加密。

AES 是对称加密算法的一种，了解AES 算法可以从这几方面入手：

密钥支持的长度
常用的工作模式（ECB模式/CBC模式）
Padding 的填充模式
密钥
密钥是AES算法实现加解密的根本。对称加密算法之所以对称，是因为这类算法对明文的加密和解密需要使用相同的一个。
AES 支持三种长度的密钥:

128bit (16B), 192bit(24B) , 256bit(32B)

使用效果:

AES256 安全性最高，AES128性能最优。本质是它们的加密处理轮数不同。

AES128	10轮
AES192	12轮
AES256	14轮
ECB 模式
ECB 模式是最简单块密码加密模式，加密前根据加密块大小（AES 128位）分成若干块，之后将每块使用相同的密钥单独加密，在该模式下，每个明文块的加密都是独立的，互不影响的。解密同理。

优势

简单

有利于并行计算

缺点

相同的明文块经过加密会变成相同的密文块，因此安全性较差。
CBC 模式
CBC模式引入一个新的概念：初始向量IV。

IV的作用和MD5的"加盐"有些类似，目的是防止同样的明文块始终加密成相同的密文块。

CBC模式原理:

在每个明文块加密前会让那个明文块和IV向量先做异或操作。IV作为初始化变量，参与第一个明文块的异或，

后续的每个明文块和它前一个明文块所加密出的密文块相异或，这样相同的明文块加密出来的密文块显然不一样。

优势

安全性更高
缺点

无法并行计算，性能上不如ECB

引入初始向量IV，增加复杂度

#### CTS

在密码学中，密文窃取（CTS）是使用分组密码操作模式的通用方法，该操作模式允许处理不能均匀分割成块的消息，而不会延长密文，代价是略为复杂。

目录
一般特性
编辑
窃取密文是使用密码加密明文的技术，不须将消息填充到块大小的倍数，因此密文与明文大小相同。

它通过更改消息最后两块来实现这点。除了最后两块之外，所有块都保持不变，但“窃取”倒数第二块的一部分密文用以填充最后一块明文块。填充的最后一块，然后像往常一样加密。

最终密文的最后两块，包括部分倒数第二块（删掉“窃取”部分）和完整的最后一块，它们大小与原明文相同。

解密时要求首先解密最后一块，然后将“窃取”的密文恢复到倒数第二块，然后可以像往常一样解密。

原则上，任何使用块密码的分组加密模式都可用，但流密码模式已经可以加密任意长度的消息无需填充，因此它们不能用该操作。与窃取密文相结合的常用加密方式有电子密码本（ECB）和密码块链接（CBC）。

ECB密文窃取要明文长过一块。当明文长度为一个或更少时，一种可能的解决办法是，使用一种类似流密码的分组密码操作模式，如CTR、CFB或OFB。

CBC密文窃取不一定要明文长过一块。在明文为一块或更少块长度的情况下，初始向量（IV）可作为先前的密文块。在这种情况，必须将修改后的IV发送予接受者。但这在发送密文时IV不能由发送者自由选择的情况下（如当IV是派生值或预先确定的值）不太可能，并且在这种情况下，针对CBC模式的密文窃取只能在明长于一个块文中发生。

为了以CTS加密或解密未知长度的数据，必须延迟处理（和缓存）最新的两块数据块，以便处理数据流末端。

## 三、认证加密模式（AE，Authenticated Encryption）

### 1. GCM (Galois Counter Mode，分组模式）

GCM (Galois/Counter) 模式在 CTR 模式的基础上，添加了消息认证的功能，而且同时还具有与 CTR 模式相同的并行计算能力。因此相比 CTR 模式，GCM 不仅速度一样快，还能额外提供对消息完整性、真实性的验证能力。

在密码学中，伽罗瓦/计数器模式( GCM ) 是对称密钥加密分组密码的一种操作模式，因其性能而被广泛采用。可以使用廉价的硬件资源实现最先进的高速通信通道的 GCM 吞吐率。 [1]该操作是一种经过身份验证的加密算法，旨在提供数据真实性（完整性）和保密性。 GCM 是为块大小为 128 位的块密码定义的。 伽罗瓦消息认证码（Galois Message Authentication Code ，GMAC ) 是 GCM 的仅认证变体，可以形成增量消息认证代码。 GCM 和 GMAC 都可以接受任意长度的初始化向量。

不同的分组密码操作模式可能具有明显不同的性能和效率特性，即使使用相同的分组密码也是如此。 GCM 可以充分利用并行处理，实现 GCM 可以有效利用指令流水线或硬件流水线。相比之下，密码块链接（CBC）操作模式会导致流水线停顿，从而影响其效率和性能。

与普通计数器模式一样，块按顺序编号，然后该块编号与初始化向量（Initialization Vector，IV） 组合并使用块密码E加密，通常为AES 。然后将此加密的结果与明文进行异或以产生密文。与所有计数器模式一样，这本质上是一个流密码，因此对于每个加密的流使用不同的 IV 是必不可少的。

密文块被视为多项式的系数，然后在依赖于密钥的点H使用有限域算术对其进行评估。然后对结果进行加密，生成可用于验证数据完整性的身份验证标签。然后，加密文本包含 IV、密文和身份验证标签。


---

认证加密
主条目：认证加密
一些工作模式在设计中希望将保密性和认证性结合起来，例如XCBC[21]，ACBC，APM[22]，OCB，EAX，CWC，CCM和GCM。认证加密模式被可以分为单次处理和两次处理两种类型。然而，对密码学用户社群而言，不幸的是，许多单次处理的认证加密算法，例如OCB，是受专利所保护的。

另外，有的模式也允许为未加密的关联数据进行认证，因此被称为AEAD（Authenticated-Encryption with Associated-Data，用于关联数据的认证加密）。例如，EAX是一种两次处理的AEAD方法，而OCB模式是单次的。

---

流密码的特点：
按位处理理明⽂文消息(as a stream)
• 典型做法是⽤用⼀一个伪随机流 密钥与明⽂文按位异或
• 流密钥的随机性完全扰乱了了 明⽂文消息的统计特性
• 不不能重复使⽤用流密钥，不不然 系统可能被破解

---

## 附录一：如何解决分组密码的碎片问题

在分组密码中，当数据长度不等于分组长度的倍数时，需要有效处理碎片问题，有填充和密文窃取两种方法。

### 1. 填充 - padding

在分组密码中，当数据长度不等于分组长度的倍数时，需要按一定的方式，将尾部明文分组进行填充，这种将尾部分组数据填满的方法称为**填充**（Padding)。常见的处理规则有：

#### ANSI X9.23

在填充字节序列中，最后一个字节填充为需要填充的字节长度(示例为0x04)，其余字节填充0。
`... | DD DD DD DD DD DD DD DD | DD DD DD DD 00 00 00 04 |`

#### ISO 10126

在填充字节序列中，最后一个字节填充为需要填充的字节长度(示例为0x04)，其余字节填充**随机数**。
`... | DD DD DD DD DD DD DD DD | DD DD DD DD 81 A6 23 04 |`

#### PKCS#7

PKCS#7 定义于 RFC 5652。
在填充字节序列中，每个字节填充为需要填充的字节长度(示例为0x04)。
`... | DD DD DD DD DD DD DD DD | DD DD DD DD 04 04 04 04 |`

#### ISO/IEC 7816-4

在填充字节序列中，第一个字节填充固定值**0x80**，其余字节填充0。若只需填充一个字节，则直接填充**0x80**。
`... | DD DD DD DD DD DD DD DD | DD DD DD DD 80 00 00 00 |`
`... | DD DD DD DD DD DD DD DD | DD DD DD DD DD DD DD 80 |`

> 采用填充方式时，密文长度通常大于明文长度，意味着网络传输时需要消耗额外的传输能力。

### 2. 密文窃取 - Ciphertext stealing

窃取密文是使用密码加密明文的技术，不须将消息填充到块大小的倍数，因此密文与明文大小相同。
它通过更改消息最后两块来实现这点。除了最后两块之外，所有块都保持不变，但“窃取”倒数第二块的一部分密文用以填充最后一块明文块。填充的最后一块，然后像往常一样加密。
最终密文的最后两块，包括部分倒数第二块（删掉“窃取”部分）和完整的最后一块，它们大小与原明文相同。
解密时要求首先解密最后一块，然后将“窃取”的密文恢复到倒数第二块，然后可以像往常一样解密。
原则上，任何使用块密码的分组加密模式都可用，但流密码模式已经可以加密任意长度的消息无需填充，因此它们不能用该操作。与窃取密文相结合的常用加密方式有电子密码本（ECB）和密码块链接（CBC）。

ECB密文窃取要明文长过一块。当明文长度为一个或更少时，一种可能的解决办法是，使用一种类似流密码的分组密码操作模式，如CTR、CFB或OFB。
CBC密文窃取不一定要明文长过一块。在明文为一块或更少块长度的情况下，初始向量（IV）可作为先前的密文块。在这种情况，必须将修改后的IV发送予接受者。但这在发送密文时IV不能由发送者自由选择的情况下（如当IV是派生值或预先确定的值）不太可能，并且在这种情况下，针对CBC模式的密文窃取只能在明长于一个块文中发生。
为了以CTS加密或解密未知长度的数据，必须延迟处理（和缓存）最新的两块数据块，以便处理数据流末端。
![CTS-ECB](CTS_ECB.png)

密文格式
有几种不同的方式来排列密文以便传输。不同排列方式的密文位元数都相同，只是传输顺序不同，因此选择不影响安全性，纯粹是为了方便实现。
也就是分组密码如何转换为流密码的问题，也是关于填充处理的问题

> 采用密文窃取方式时，密文长度严格等于明文长度，不会浪费网络传输能力，同时这个优点非常适合磁盘文件存储（文件大小等于密文长度），因此产生 AES-XTS 工作模式。
> 密文窃取也是有代价的，需要延迟处理（和缓存）最新的两块数据块，以便处理数据流末端。
---

可以看到加密时 s 位的明文分组加密成 s 位的密文分组 ，而位数 s 不取决于加密函数，因此可以通过选择 s 的大小（通常为 8 位）来使得明文长度等于密文长度，从而不浪费传输能力。相比于 CFB 模式，那些需要填充的分组密码工作模式，往往是密文长度稍大于实际的明文长度，这样会使得传输能力被浪费。

可以看到在分组加密工作模式中仍然可以实现加密单个字节的明文分组，此时分组密码可以转换为流密码，流密码最大的特点就是明文和密文等长，分组密码则不是如此，但在一些工作模式中分组密码实际上达到了流密码的特点。

> 碎片填充造成密文长度大于明文，意味着需要消耗额外的传输能力。

---

## 参考文档

- [分组加密工作模式 - Yang‘s blog](http://stuyang.com/blog/6fdd6732f56d/)
- [分组密码与流密码：它们是什么以及它们如何工作](https://www.asiaregister.com/zh/news/fen-zu-mi-ma-yu-liu-mi-ma-ta-men-shi-shen-me-yi-ji-ta-men-ru-he-gong-zuo-2453.htm)
- [分组密码工作模式 - WiKi](https://zh.m.wikipedia.org/zh-hans/%E5%88%86%E7%BB%84%E5%AF%86%E7%A0%81%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F)

### 文档下载

- [分组密码 工作模式建议：NIST SP 800-38A 2001 Edition](nistspecialpublication800-38a.pdf)
- [分组密码 GCM/GMAC 工作模式：NIST SP 800-38D 2001 Edition](nistspecialpublication800-38d.pdf)
- [分组密码 XTS-AESC 工作模式：NIST SP 800-38E 2001 Edition](nistspecialpublication800-38e.pdf)
- [IEEE Std 1619-2007, The XTS-AES Tweakable Block Cipher](1619-2007-NIST-Submission.pdf)
- [现代密码学理论与实践 - 苗付友.pdf](现代密码学理论与实践-苗付友.pdf)
