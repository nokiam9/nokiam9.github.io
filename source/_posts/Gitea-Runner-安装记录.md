---
title: Gitea Runner å®‰è£…è®°å½•
date: 2025-02-09 18:59:03
tags:
---

## ä¸€ã€æ¦‚è¿°

å¯¹æ ‡ Jenkis è‡ªåŠ¨åŒ– CI/CD å·¥å…·ï¼ŒGitlab å¼€å‘äº†è‡ªå·±çš„ Gitlab CI/CDï¼ŒGithub åŸæ¥æ˜¯å’Œ Tranvis åˆä½œçš„ï¼Œåæ¥ä¹Ÿå¼€å‘äº†è‡ªå·±çš„ Actionsï¼ŒGitea æ²¡æœ‰è‡ªå·±çš„ CI/CD å·¥å…·ï¼Œè€Œæ˜¯â€œå€Ÿç”¨â€äº† Actionsï¼Œæ”¹äº†ä¸ªåå­—å°±æ˜¯ Gitea Actionsã€‚

å’Œå…¶ä»– CI/CD è§£å†³æ–¹æ¡ˆä¸€æ ·ï¼ŒGitea ä¸ä¼šè‡ªå·±è¿è¡Œ Jobï¼Œè€Œæ˜¯å°† Job å§”æ‰˜ç»™ Runnerã€‚ä»å®‰å…¨å’Œæ€§èƒ½çš„è§’åº¦è€ƒè™‘ï¼ŒRunner é€šå¸¸è¿è¡Œåœ¨ä¸€å°ç‹¬ç«‹çš„æœåŠ¡å™¨ä¸Šï¼Œä¾‹å¦‚å®‰å…¨åŸŸè¾¹ç•Œçš„å ¡å’æœºã€‚

Gitea Actions çš„ Runner è¢«ç§°ä¸º`act_runner`ï¼Œæ˜¯ä¸€ä¸ªç”¨ Go è¯­è¨€ç¼–å†™çš„ç¨‹åºã€‚
æºä»£ç ä½äºï¼š[https://gitea.com/gitea/act_runner](https://gitea.com/gitea/act_runner)ï¼Œå½“å‰æœ€æ–°ç‰ˆæœ¬æ˜¯ 0.2.11ã€‚

> act_runner å…¶å®æ˜¯ [nektos/act](http://github.com/nektos/act) çš„ä¸€ä¸ªåˆ†æ”¯

## äºŒã€æŠ€æœ¯æ¶æ„

GitHub Actions æœ‰ä¸€äº›è‡ªå·±çš„æœ¯è¯­ã€‚

- workflowÂ ï¼ˆå·¥ä½œæµç¨‹ï¼‰ï¼šæŒç»­é›†æˆä¸€æ¬¡è¿è¡Œçš„è¿‡ç¨‹ï¼Œ**å¯¹åº”ä¸ºä¸€ä¸ª yaml æ–‡ä»¶**
- jobÂ ï¼ˆä»»åŠ¡ï¼‰ï¼šä¸€æ¬¡æŒç»­é›†æˆçš„è¿è¡Œï¼ŒåŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ª jobsã€‚**å¯¹åº”ä¸ºä¸€ä¸ª Container å®ä¾‹**
- stepï¼ˆæ­¥éª¤ï¼‰ï¼šæ‰§è¡Œ job çš„è‹¥å¹²ä¸ªæ­¥éª¤ï¼Œä¸€æ­¥æ­¥å®Œæˆã€‚ç±»ä¼¼äº Gitlab CI çš„ stage
- actionï¼ˆåŠ¨ä½œï¼‰ï¼šæ¯ä¸ª step å¯ä»¥ä¾æ¬¡æ‰§è¡Œä¸€ä¸ªæˆ–å¤šä¸ªå‘½ä»¤ï¼ˆactionï¼‰ã€‚å¯ä»¥æ˜¯ä¸€æ¡ bash æŒ‡ä»¤ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ª**åœ¨ Github Market ä¸Šæ¶çš„è„šæœ¬**

![arch](runner.png)

1. Act Runner æ˜¯ä¸€ä¸ªç®¡ç†è€…ï¼Œé¦–å…ˆä½¿ç”¨ä»¤ç‰Œåœ¨æŒ‡å®šçš„ Gitea å®ä¾‹ä¸Šæ³¨å†Œï¼Œå¹¶é€šè¿‡å£°æ˜è‡ªå·±çš„ lable å‘ Gitea æŠ¥å‘Šå®ƒå¯ä»¥è¿è¡Œçš„ Job ç±»å‹ã€‚
2. å½“è§¦å‘æ¡ä»¶æ»¡è¶³æ—¶ï¼ŒAct Runner ä¸ºæ¯ä¸ª Job åˆ›å»ºå¹¶è¿è¡Œç›¸åº”çš„ Containerï¼›Job å®¹å™¨è´Ÿè´£é€æ¡å¤„ç†æ¯ä¸ªæ­¥éª¤å’ŒåŠ¨ä½œï¼Œæœ‰äº› action å¯èƒ½éœ€è¦ä» Gitea å®ä¾‹è·å¾—è„šæœ¬ä»£ç ï¼Œä¾‹å¦‚ä½¿ç”¨äº† [http://gitea.lan/actions/checkout@v3](http://gitea.lan/actions/checkout@v3)
3. Act Runner è¿è¡Œéœ€è¦åŠ è½½ Job é•œåƒï¼Œå¯èƒ½ä½äº dockerhub ä¸Šï¼›ä¹Ÿå¯èƒ½éœ€è¦ä» github.com æˆ– gitea.com ä¸‹è½½è„šæœ¬ä»£ç ï¼Œå› æ­¤å¯èƒ½éœ€è¦è®¿é—®äº’è”ç½‘ã€‚
4. Job å®¹å™¨æ‰§è¡Œ action è„šæœ¬æ—¶ï¼Œå¯èƒ½ä¹Ÿéœ€è¦ä»äº’è”ç½‘ä¸‹è½½èµ„æºï¼Œä¾‹å¦‚ ubunut çš„è½¯ä»¶åŒ…ã€npm çš„è½¯ä»¶åŒ…ç­‰ï¼Œå› æ­¤ä¹Ÿå¯èƒ½è®¿é—®äº’è”ç½‘ã€‚

Runner èƒ½å¤Ÿè¿æ¥åˆ° Gitea å®ä¾‹æ˜¯å¿…é¡»çš„ï¼Œäº’è”ç½‘è®¿é—®æ˜¯å¯é€‰çš„ã€‚ä½†å¦‚æœæ²¡æœ‰äº’è”ç½‘è®¿é—®ï¼Œç®¡ç†å‘˜éœ€è¦ç¡®ä¿æ‰€ä½¿ç”¨çš„ imageã€action åŠå…¶èµ„æºä¾èµ–éƒ½åœ¨å†…ç½‘ä¸­ã€‚

## ä¸‰ã€å®‰è£…æ­¥éª¤

Act Runner äºŒè¿›åˆ¶ä»£ç ä¸‹è½½é¡µé¢ï¼š[https://gitea.com/gitea/act_runner/releases](https://gitea.com/gitea/act_runner/releases)
Act Runner é•œåƒåœ°å€ï¼š gitea/act_runner:0.2.11

Act Runner éœ€è¦åˆ›å»ºå¹¶è°ƒç”¨ Runner ä½œä¸º Job çš„å·¥ä½œè´Ÿè½½ï¼Œæ”¯æŒ Ubuntuã€MacOS å’Œ Windows2019 ç­‰æ“ä½œç³»ç»Ÿã€‚
Runner é•œåƒåœ°å€ï¼šgitea/runner-images:ubuntu-22.04

Ubuntu çš„ Runner é•œåƒæ”¯æŒæœ€æ–°çš„ 3 ä¸ª LTS ç‰ˆæœ¬ï¼ˆ20.04ï¼Œ22.04ï¼Œ24.04ï¼‰ï¼Œå¹¶è¿›ä¸€æ­¥åˆ†ä¸º slimã€standardã€full ç­‰å­ç‰ˆæœ¬ï¼ŒåŒºåˆ«å°±æ˜¯é¢„è£… nodeã€jvmã€gccã€go ç­‰å¸¸ç”¨è½¯ä»¶çš„æ•°é‡ï¼Œè¯¦ç»†è½¯ä»¶æ¸…å•å‚è§[Ubuntu 22.04 ç‰ˆæœ¬è¯´æ˜](https://github.com/actions/runner-images/blob/main/images/ubuntu/Ubuntu2204-Readme.md)

### 1. åœ¨ Gitea æ³¨å†Œ

```bash
# ç”Ÿæˆé…ç½®æ–‡ä»¶
./act_runner generate-config > config.yml

# æ³¨å†Œrunner
./act_runner register --no-interactive --instance <instance_url> --token <registration_token> --name <runner_name> --labels <runner_labels>

# åå°å¯åŠ¨å‘½ä»¤
 ./act_runner daemon -c config.yml 
```

æ³¨å†ŒæˆåŠŸåï¼Œä¼šåœ¨å®‰è£…ç›®å½•ä¸‹æœ‰ä¸€ä¸ªéšè—æ–‡ä»¶`.runner`ï¼Œç”¨äºç®¡ç†æœ‰æ•ˆæ³¨å†Œæ•°æ®ã€‚

```yml
{
  "WARNING": "This file is automatically generated by act-runner. Do not edit it manually unless you know what you are doing. Removing this file will cause act runner to re-register as a new runner.",
  "id": 5,
  "uuid": "b10307c2-7df3-46ca-88b7-6ffb06035a18",
  "name": "Runner",
  "token": "e4c2f662d3479e81ba40e7dba73911b6a073409e",
  "address": "http://gitea.lan",
  "labels": [
    "ubuntu-latest:docker://gitea/runner-images:ubuntu-latest",
    "ubuntu-22.04:docker://gitea/runner-images:ubuntu-22.04",
    "ubuntu-20.04:docker://gitea/runner-images:ubuntu-20.04"
  ]
}
```

### 2. docker å¯åŠ¨ act runner

#### docker-compose.yml

```yaml
version: "3"
services:
  runner:
    image: harbor.lan/gitea/act_runner:0.2.11
    environment:
      CONFIG_FILE: /config.yaml
      GITEA_INSTANCE_URL: "http://gitea.lan"
      GITEA_RUNNER_REGISTRATION_TOKEN: "YRK2jnTuwJXYTMJCmsH13H0bf0IDp8T9EY86OSwx"
      GITEA_RUNNER_NAME: "Runner"
      GITEA_RUNNER_LABELS: "ubuntu-22.04"
    volumes:
      - ./config.yaml:/config.yaml
      - ./data:/data
      - /var/run/docker.sock:/var/run/docker.sock
```

#### config.yml

```yaml
log:
  level: info

runner:
  file: .runner                                 # data/.runner æ–‡ä»¶å­˜å‚¨äº† Gitea æ³¨å†Œçš„è¿”å›ä¿¡æ¯
  capacity: 1                                   # åŒæ—¶å…è®¸ 1 ä¸ªå®ä¾‹è¿è¡Œ
  envs:
    A_TEST_ENV_NAME_1: a_test_env_value_1
    A_TEST_ENV_NAME_2: a_test_env_value_2
  env_file: .env
  timeout: 3h
  shutdown_timeout: 0s
  insecure: false                               # å®‰å…¨æ¨¡å¼ï¼Ÿ
  fetch_timeout: 5s
  fetch_interval: 2s
  labels:                                       # é»˜è®¤ä» github æ‹‰å–ï¼Œæ”¹ä¸ºæœ¬åœ°é•œåƒ!!!
    - "ubuntu-latest:docker://harbor.lan/proxy/gitea/runner-images:ubuntu-latest"
    - "ubuntu-22.04:docker://harbor.lan/proxy/gitea/runner-images:ubuntu-22.04"
    - "ubuntu-20.04:docker://harbor.lan/proxy/gitea/runner-images:ubuntu-20.04"

cache:
  enabled: true                                 # å…è®¸ cache server
  dir: ""
  host: ""
  port: 0
  external_server: ""

container:
  network: ""
  privileged: false
  options:
  workdir_parent:
  valid_volumes: []
  docker_host: ""
  force_pull: true
  force_rebuild: false

host:
  workdir_parent:
```

### 3. ç³»ç»Ÿè‡ªå¯åŠ¨

ç¼–è¾‘`/etc/systemd/system/runner.service`

```txt
[Unit]
Description=Gitea Actions runner
Documentation=https://gitea.com/gitea/act_runner
After=docker.service

[Service]
Type=simple
Restart=on-failure
RestartSec=5
ExecStartPre=/usr/bin/docker-compose -f /opt/runner/docker-compose.yml down
ExecStart=/usr/bin/docker-compose -f /opt/runner/docker-compose.yml up
ExecStop=/usr/bin/docker-compose -f /opt/runner/docker-compose.yml down

[Install]
WantedBy=multi-user.target
```

workflow çš„å¯åŠ¨é˜¶æ®µï¼Œä¸»è¦ä»»åŠ¡åŒ…æ‹¬ï¼š

- `docker pull gitea/runner-images:ubuntu-22.04`ï¼šè·å¾—åŸºç¡€é•œåƒï¼Œå¹¶ä¸ºå½“å‰ä»»åŠ¡å¯åŠ¨å®¹å™¨
- `git clone 'https://github.com/actions/setup-node`ï¼šä¸‹è½½å½“å‰ä»»åŠ¡éœ€è¦çš„ Actions è„šæœ¬
- æ ¹æ®å·¥ä½œæµè¯­æ³•ï¼Œåˆ†æå¹¶æ›¿æ¢æ‰€æœ‰è¡¨è¾¾å¼çš„å˜é‡åç§°
- åˆ›å»ºå·¥ä½œç›®å½• `/workspace`ï¼Œä¸ºåç»­çš„ä»£ç ä¸‹è½½å’Œåº”ç”¨å¤„ç†æä¾›å­˜å‚¨èµ„æº

ç„¶åï¼Œå°±å¯ä»¥ä¾æ¬¡æ‰§è¡Œå„ä¸ª step çš„æ“ä½œäº†ã€‚  

## å››ã€å·¥ä½œæµé…ç½®

å¯¹äºä¸€ä¸ªä»£ç åº“ï¼Œå·¥ä½œæµé…ç½®æ–‡ä»¶ä¿å­˜åœ¨éšè—ç›®å½•ä¸­ï¼Œä¾‹å¦‚ï¼š`$REPO/.gitea/workflows/demo.yml`

```yml
name: Gitea Actions Demo
run-name: ${{ gitea.actor }} is testing out Gitea Actions ğŸš€
on: [push]                          # å·¥ä½œæµçš„è§¦å‘äº‹ä»¶æ˜¯ git push

jobs:
  Explore-Gitea-Actions:
    runs-on: ubuntu-22.04           # æŸ¥è¯¢ runner ä¸­ label=ubuntu-22.04 çš„å®¹å™¨é•œåƒ 
    steps:
      - run: echo "ğŸ‰ The job was automatically triggered by a ${{ gitea.event_name }} event."
      - run: echo "ğŸ§ This job is now running on a ${{ runner.os }} server hosted by Gitea!"
      - run: echo "ğŸ” The name of your branch is ${{ gitea.ref }} and your repository is ${{ gitea.repository }}."
      - name: Check out repository code
        uses: actions/checkout@v3   # è°ƒç”¨é¢„å®šä¹‰è„šæœ¬ https://github.com/actions/checkoutï¼Œç‰ˆæœ¬3
      - run: echo "ğŸ’¡ The ${{ gitea.repository }} repository has been cloned to the runner."
      - run: echo "ğŸ–¥ï¸ The workflow is now ready to test your code on the runner."
      - name: List files in the repository
        run: |                      # æ‰§è¡Œ shell å‘½ä»¤
          ls ${{ gitea.workspace }} # Gitea æä¾› vars å’Œ secret çš„æ•°æ®å­˜å‚¨
      - run: echo "ğŸ This job's status is ${{ job.status }}."
```

Gitea å®ä¾‹ä¼šè‡ªåŠ¨æ£€æŸ¥ workflow æ–‡ä»¶ï¼Œå½“è§¦å‘æ¡ä»¶æ»¡è¶³æ—¶ï¼Œé€šçŸ¥å·²æ³¨å†Œçš„ Act Runner æ‰§è¡Œå·¥ä½œæµï¼Œå¹¶æ˜¾ç¤ºå¤„ç†ç»“æœã€‚
å†ç»™ä¸€ä¸ªç¤ºä¾‹ï¼Œå…¶ä¸­ checkoutã€setup-nodeã€ssh-agent ç­‰é¢„å®šä¹‰è„šæœ¬å·²ä» Github é•œåƒåˆ°æœ¬åœ° Gitea ä»£ç åº“ã€‚

```yaml
name: Deploy to Nginx
on:
  push:
    branches:
      - main  # æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹åˆ†æ”¯åç§°

jobs:
  build-and-deploy:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: http://gitea.lan/actions/checkout@v3
      - name: Set up Node.js
        uses: http://gitea.lan/actions/setup-node@v4
        with:
          node-version: 20  # æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ Node.js ç‰ˆæœ¬
      - name: Install dependencies
        run: npm install
      - name: Build project
        run: npm run build
      - name: Set up SSH key
        uses: http://gitea.lan/actions/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      - name: Deploy to Nginx server
        run: |
          hostname
          ssh -o StrictHostKeyChecking=no root@${{ vars.NGINX_IP_ADDRESS }} "mkdir -p " ${{ vars.NGINX_ROOT_DIRECTORY }}
          scp -r dist/* root@${{ vars.NGINX_IP_ADDRESS }}:${{ vars.NGINX_ROOT_DIRECTORY }}
```

---

## å‚è€ƒæ–‡çŒ®

- [Gitea Actions å…¥é—¨æ‰‹å†Œ](https://docs.gitea.com/usage/actions/quickstart)
- [Gitea Actions å…¥é—¨æ‰‹å†Œ - ä¸­æ–‡ç‰ˆ](https://docs.gitea.cn/usage/actions/quickstart)
- [GitHub Actions çš„å·¥ä½œæµç¨‹è¯­æ³•](https://docs.github.com/en/actions/writing-workflows/workflow-syntax-for-github-actions)
- [Runner Ubuntu 2204 é¢„è£…è½¯ä»¶æ¸…å•](https://github.com/actions/runner-images/blob/main/images/ubuntu/Ubuntu2204-Readme.md)
- [nektosact act ä¸»é¡µ](https://nektosact.com/introduction.html)
- [GitHub Actions ä½¿ç”¨ä»‹ç»](https://oragekk.me/tutorial/github/github-action.html)
- [Gitlab-CICDæœ€ç®€å•æ˜äº†çš„å…¥é—¨æ•™ç¨‹](https://cloud.tencent.com/developer/article/2098099)
