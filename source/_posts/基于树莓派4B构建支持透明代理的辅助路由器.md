---
title: 基于树莓派4B构建支持透明代理的辅助路由器
date: 2020-07-21 00:18:58
tags:
---

## 基础组件

- Raspberry Lite OS：   基于ARM V7，32位操作系统
- dnsmasq： 自建域名服务器 + DHCP服务器， 192.168.0.8
- hostapd： 提供AP服务器，SSID=xxx-PI， 192.168.11.x/24
- clash：   作为v2ray节点的客户端，自带Dashboard
- ？squid： proxy代理服务器

## 安装步骤

1. 软件源

    ``` txt
    deb https://mirrors.aliyun.com/raspbian/raspbian/ buster main non-free contrib
    deb-src https://mirrors.aliyun.com/raspbian/raspbian/ buster main non-free contrib
    ```

2. 网卡

    ``` sh
    pi@raspberrypi:/etc/network $ cat interfaces
    auto lo
    iface lo inet loopback
    auto eth0
    iface eth0 inet static
    address 192.168.0.8
    netmask 255.255.255.0
    gateway 192.168.0.1
    allow-hotplug wlan0
    iface wlan0 inet static
    address 192.168.11.1
    netmask 255.255.255.0
    ```

3. dnsmasq

   ``` sh
    pi@raspberrypi:/etc/trojan $ cat /etc/hosts
    127.0.0.1   localhost
    ::1         localhost ip6-localhost ip6-loopback
    ff02::1     ip6-allnodes
    ff02::2        ip6-allrouters

    127.0.0.1       dnsmasq

    192.168.0.8     dnsmasq
    192.168.0.1     gateway
    192.168.0.5     ap
    192.168.0.11    plc

    192.168.0.130   mirror
    192.168.0.130   reg
    192.168.0.130   nfs
    192.168.0.132   master1
    192.168.0.130   worker1

    pi@raspberrypi:/etc/trojan $ more /etc/dnsmasq.conf
    interface=wlan0
    listen-address=127.0.0.1, 192.168.11.1, 192.168.0.8
    dhcp-range=192.168.11.100, 192.168.11.150, 12h
    #resolv-file=/etc/resolv.conf
    expand-hosts
    server=8.8.8.8
    server=114.114.114.114
    domain=caogo.lan
    address=/caogo.lan/127.0.0.1
    address=/caogo.lan/192.168.0.8
   ```

4. hostapd

    ``` sh
    pi@raspberrypi:/etc/hostapd $ cat /etc/hostapd/hostapd.conf
    interface=wlan0
    driver=nl80211
    hw_mode=g
    ssid=WKHOME-PI
    channel=6
    wpa=2
    wpa_passphrase=sunxiaoyun911
    wpa_key_mgmt=WPA-PSK
    wpa_pairwise=CCMP
    rsn_pairwise=CCMP
    auth_algs=3
    wmm_enabled=1
    max_num_sta=10
    logger_stdout=-1
    logger_stdout_level=2
    ```

5. clash

    ``` sh
    sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE  
    sudo iptables -A FORWARD -i eth0 -o wlan0 -m state --state RELATED,ESTABLISHED -j ACCEPT  
    sudo iptables -A FORWARD -i wlan0 -o eth0 -j ACCEPT
    # 上面是我们已经添加过的
    sudo iptables -t nat -A POSTROUTING -o ppp0 -j MASQUERADE  
    sudo iptables -A FORWARD -i ppp0 -o wlan0 -m state --state RELATED,ESTABLISHED -j ACCEPT  
    sudo iptables -A FORWARD -i wlan0 -o ppp0 -j ACCEPT
    ```

    ``` txt
    "outbounds" : [
        {
            "sendThrough" : "0.0.0.0",
            "mux" : {
            "enabled" : false,
            "concurrency" : 8
        },
        "protocol" : "vmess",
        "settings" : {
            "vnext" : [
                {
                    "address" : "bt.caogo.cn",
                    "users" : [
                        {
                            "id" : "e9a282f8-94a6-49d2-9d8b-030eafbd5759",
                            "alterId" : 60,
                            "security" : "auto",
                            "level" : 0
                        }
                    ],
            "port" : 7322
            }
        ]
        },
    …...

    ```

---

## 补充问题

### 1. 关闭默认打开的avahi服务

Zeroconf
Zero configuration networking(zeroconf)零配置网络服务规范，是一种用于自动生成可用IP地址的网络技术，不需要额外的手动配置和专属的配置服务器。

“零 配置网络服务”的目标，是让非专业用户也能便捷的连接各种网络设备，例如计算机，打印机等。整个搭建网络的过程都是通过程式自动化实现。如果没有 zeroconf，用户必须手动配置一些服务，例如DHCP、DNS，计算机网络的其他设置等。这些对非技术用户和新用户们来说是很难的事情。

Zeroconf规范的提出者是Apple公司.

Avahi
Avahi 是Zeroconf规范的开源实现，常见使用在Linux上。包含了一整套多播DNS(multicastDNS)/DNS-SD网络服务的实现。它使用 的发布授权是LGPL。Zeroconf规范的另一个实现是Apple公司的Bonjour程式。Avahi和Bonjour相互兼容(废话，都走同一个 规范标准嘛，就象IE，Firefox，chrome都能跑HTTP1.1一样)。

Avahi允许程序在不需要进行手动网络配置的情况 下，在一个本地网络中发布和获知各种服务和主机。例如，当某用户把他的计算机接入到某个局域网时，如果他的机器运行有Avahi服务，则Avahi程式自 动广播，从而发现网络中可用的打印机、共享文件和可相互聊天的其他用户。这有点象他正在接收局域网中的各种网络广告一样。

Linux下系统实际启动的进程名，是avahi-daemon

除非你有兼容的设备或使用 zeroconf 协议的服务，否则应该关闭它。

如果你用不到 把该服务直接关闭
/etc/init.d/avahi-daemon stop or service avahi-daemon  stop

---

## 参考目录

- [在 Raspberry Pi上运行Clash作为透明代理](https://cherysunzhang.com/2020/05/deploy-clash-as-transparent-proxy-on-raspberry-pi/)
- [Clash的Github官方网站](https://github.com/Dreamacro/clash)
- [在树莓派上搭建软路由](https://blog.nicesite.win/2017/08/16/soft-router/)
- [使用PVE运行Clash旁路由虚拟机实现透明代理](https://blog.serenader.me/shi-yong-pve-yun-xing-clash-pang-lu-you-xu-ni-ji-shi-xian-tou-ming-dai-li)
- [V2ray的主流客户端](https://tlanyan.me/v2ray-clients-download/)
- [Clash的配置文件示例](https://www.v2rayssr.com/clashxx.html)
- [Clash的配置文件示例2](https://lancellc.gitbook.io/clash/clash-config-file/an-example-configuration-file)
- [树莓派搭建简略WiFi无线路由器](https://www.joxrays.com/raspberry-wifi-router/)
- [iptables的命令解释](https://lesca.me/archives/iptables-nat-mangle-clear-rules.html)
