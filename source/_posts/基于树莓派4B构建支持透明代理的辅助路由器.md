---
title: 基于树莓派4B构建支持透明代理的辅助路由器
date: 2020-07-21 00:18:58
tags:
---

## 基础组件

- Raspberry Lite OS：   基于ARM V7，32位操作系统
- dnsmasq： 自建域名服务器 + DHCP服务器， 192.168.0.8
- hostapd： 提供AP服务器，SSID=xxx-PI， 192.168.11.x/24
- clash：   作为v2ray节点的客户端，自带Dashboard
- ？squid： proxy代理服务器

## 安装步骤

``` txt
* 激活root，删除pi，设置ssh证书登录
* 关闭防火墙、avahi-daemon，dhcpcd
* 设置网卡，激活wlan
* 安装ntp（必须的，clash的clinet/Server模式依赖于系统时间同步）
    * rfkill unblock wlan
    * systemctl stop  avahi-daemon.service
    * systemctl disable avahi-daemon.service
    * systemctl disable  dhcpcd.service
    * systemctl stop  dhcpcd.service
* 设置IP转发
* 安装基础软件 hostapd、dnsmasq、
* 下载clash，clash-dashboard，手工下载MMDB
* 手工加载配置config.yaml
* 设置clash systemd
* 设置iptables
```

1. 软件源

    ``` txt
    deb https://mirrors.aliyun.com/raspbian/raspbian/ buster main non-free contrib
    deb-src https://mirrors.aliyun.com/raspbian/raspbian/ buster main non-free contrib
    ```

    ``` sh
    apt update
    apt install hostapd dnsmasq ntp git
    ```

2. 网卡

    ``` sh
    pi@raspberrypi:/etc/network $ cat interfaces
    auto lo
    iface lo inet loopback

    auto eth0
    iface eth0 inet static
    address 192.168.0.8
    netmask 255.255.255.0
    gateway 192.168.0.1

    allow-hotplug wlan0
    iface wlan0 inet static
    address 192.168.11.1
    netmask 255.255.255.0
    ```

3. dnsmasq

   ``` sh
    root@raspberrypi:~/.config/clash# cat /etc/dnsmasq.conf
    # DHCP
    interface=wlan0
    listen-address=192.168.11.1
    dhcp-range=192.168.11.100, 192.168.11.150, 12h

    # set default route
    dhcp-option=3,192.168.11.1

    # set default nameserver
    dhcp-option=6, 198.19.0.1, 198.19.0.2

    # without DNS
    port=0

    root@raspberrypi:/etc/default# cat /etc/default/dnsmasq
    #DOMAIN_SUFFIX=`dnsdomainname`
    #DNSMASQ_OPTS="--conf-file=/etc/dnsmasq.alt"

    # Whether or not to run the dnsmasq daemon; set to 0 to disable.
    ENABLED=1
    CONFIG_DIR=/etc/dnsmasq.d,.dpkg-dist,.dpkg-old,.dpkg-new

    #IGNORE_RESOLVCONF=yes
   ```

4. hostapd

    ``` sh
    cat > /etc/hostapd/hostapd.conf << EOF
    interface=wlan0
    driver=nl80211
    hw_mode=g
    ssid=< Your SSID >
    channel=6
    wpa=2
    wpa_passphrase=< Your Passeword >
    wpa_key_mgmt=WPA-PSK
    wpa_pairwise=CCMP
    rsn_pairwise=CCMP
    auth_algs=3
    wmm_enabled=1
    max_num_sta=10
    logger_stdout=-1
    logger_stdout_level=2
    EOF
    ```

5. Clash - V2ray Client

    ``` sh
    sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE  
    sudo iptables -A FORWARD -i eth0 -o wlan0 -m state --state RELATED,ESTABLISHED -j ACCEPT  
    sudo iptables -A FORWARD -i wlan0 -o eth0 -j ACCEPT
    # 上面是我们已经添加过的
    sudo iptables -t nat -A POSTROUTING -o ppp0 -j MASQUERADE  
    sudo iptables -A FORWARD -i ppp0 -o wlan0 -m state --state RELATED,ESTABLISHED -j ACCEPT  
    sudo iptables -A FORWARD -i wlan0 -o ppp0 -j ACCEPT
    ```

    ``` sh
    port: 7890
    socks-port: 7891
    redir-port: 7892
    allow-lan: true

    mode: Rule

    log-level: info
    # external-controller 主要是用于 web 端管理页面，必须监听在 0.0.0.0
    external-controller: 0.0.0.0:9090

    # secret 是进入管理面板所需要的密码，可填可不填，建议填上
    #secret: "secret-password"

    # external-ui 表示管理面板的路径
    external-ui: yacd-dashboard

    ## 自带DNS设置
    dns:
    enable: true
    ipv6: false
    listen: 192.168.0.8:53
    #  enhanced-mode: redir-host
    enhanced-mode: fake-ip
    fake-ip-range: 198.18.0.1/16
    nameserver:
        - '8.8.8.8'

    ## 强制域名解析，防止DNS被污染
    hosts:
    "dns.alidns.com": 223.5.5.5

    # 代理线路配置，主要是VPS参数
    proxies:
    - name: "vmess"
    ...

    - name: "trojan"
    ...

    # 代理组设置，捆绑用于后续rules
    proxy-groups:
    - name: "auto"
        type: url-test
        proxies:
        - vmess
        # tolerance: 150
        url: 'http://www.gstatic.com/generate_204'
        interval: 300

    - name: "Proxy"
        type: select
        proxies:
        - vmess
        - trojan
        - auto

    ## 规则设置，为各类地址设置路由策略
    rules:
    ...

    # 最终规则
    - GEOIP,CN,DIRECT
    - MATCH,Proxy
    ```

6. Iptables 设置

    ``` sh
    root@raspberrypi:~/.config/clash# iptables-save
    # Generated by xtables-save v1.8.2 on Fri Jul 24 18:45:10 2020
    *nat
    :PREROUTING ACCEPT [0:0]
    :INPUT ACCEPT [0:0]
    :POSTROUTING ACCEPT [0:0]
    :OUTPUT ACCEPT [0:0]
    :clash - [0:0]
    :clash_dns - [0:0]
    -A PREROUTING -d 198.19.0.0/24 -p tcp -m tcp --dport 53 -j clash_dns
    -A PREROUTING -d 198.19.0.0/24 -p udp -m udp --dport 53 -j clash_dns
    -A PREROUTING -p tcp -j clash
    -A POSTROUTING -o eth0 -j MASQUERADE
    -A clash -d 0.0.0.0/8 -j RETURN
    -A clash -d 10.0.0.0/8 -j RETURN
    -A clash -d 127.0.0.0/8 -j RETURN
    -A clash -d 169.254.0.0/16 -j RETURN
    -A clash -d 172.16.0.0/12 -j RETURN
    -A clash -d 192.168.0.0/16 -j RETURN
    -A clash -d 224.0.0.0/4 -j RETURN
    -A clash -d 240.0.0.0/4 -j RETURN
    -A clash -p tcp -j REDIRECT --to-ports 7892
    -A clash_dns -d 198.19.0.0/24 -p udp -m udp --dport 53 -j DNAT --to-destination 192.168.0.8:53
    -A clash_dns -d 198.19.0.0/24 -p tcp -m tcp --dport 53 -j DNAT --to-destination 192.168.0.8:53
    COMMIT
    # Completed on Fri Jul 24 18:45:10 2020
    # Generated by xtables-save v1.8.2 on Fri Jul 24 18:45:10 2020
    *filter
    :INPUT ACCEPT [0:0]
    :FORWARD ACCEPT [0:0]
    :OUTPUT ACCEPT [0:0]
    COMMIT
    # Completed on Fri Jul 24 18:45:10 2020
    ```

    ``` sh
    apt install iptables-persistent netfilter-persistent
    netfilter-persistent save
    netfilter-persistent start
    iptables-save  > /etc/iptables/rules.v4
    ```

    **config里198.18.x.x，但iptables里是198.19.x.x**

7. Systemd 设置

    ``` sh
    # 为 clash 添加绑定低位端口的权限，这样运行 clash 的时候无需 root 权限
    setcap cap_net_bind_service=+ep /usr/bin/clash

    cat > /etc/systemd/system/clash.service << EOF
    [Unit]
    Description=clash service
    After=network.target

    [Service]
    Type=simple
    User=root

    ExecStart=/usr/bin/clash -d /root/.config/clash
    Restart=on-failure # or always, on-abort, etc

    [Install]
    WantedBy=multi-user.target

    EOF
    ```

---

## 补充问题

### 1. 关闭默认打开的avahi服务

Zeroconf
Zero configuration networking(zeroconf)零配置网络服务规范，是一种用于自动生成可用IP地址的网络技术，不需要额外的手动配置和专属的配置服务器。

“零 配置网络服务”的目标，是让非专业用户也能便捷的连接各种网络设备，例如计算机，打印机等。整个搭建网络的过程都是通过程式自动化实现。如果没有 zeroconf，用户必须手动配置一些服务，例如DHCP、DNS，计算机网络的其他设置等。这些对非技术用户和新用户们来说是很难的事情。

Zeroconf规范的提出者是Apple公司.

Avahi
Avahi 是Zeroconf规范的开源实现，常见使用在Linux上。包含了一整套多播DNS(multicastDNS)/DNS-SD网络服务的实现。它使用 的发布授权是LGPL。Zeroconf规范的另一个实现是Apple公司的Bonjour程式。Avahi和Bonjour相互兼容(废话，都走同一个 规范标准嘛，就象IE，Firefox，chrome都能跑HTTP1.1一样)。

Avahi允许程序在不需要进行手动网络配置的情况 下，在一个本地网络中发布和获知各种服务和主机。例如，当某用户把他的计算机接入到某个局域网时，如果他的机器运行有Avahi服务，则Avahi程式自 动广播，从而发现网络中可用的打印机、共享文件和可相互聊天的其他用户。这有点象他正在接收局域网中的各种网络广告一样。

Linux下系统实际启动的进程名，是avahi-daemon

除非你有兼容的设备或使用 zeroconf 协议的服务，否则应该关闭它。

如果你用不到 把该服务直接关闭
/etc/init.d/avahi-daemon stop or service avahi-daemon  stop

### 2. V2ray Server的配置文件参考

``` txt
"outbounds" : [
    {
        "sendThrough" : "0.0.0.0",
        "mux" : {
        "enabled" : false,
        "concurrency" : 8
    },
    "protocol" : "vmess",
    "settings" : {
        "vnext" : [
            {
                "address" : "bt.caogo.cn",
                "users" : [
                    {
                        "id" : "xxxx-xxxx-xxx-",
                        "alterId" : 60,
                        "security" : "auto",
                        "level" : 0
                    }
                ],
        "port" : 7322
        }
    ]
    },
…...

```

---

## 参考目录

- [在 Raspberry Pi上运行Clash作为透明代理](https://cherysunzhang.com/2020/05/deploy-clash-as-transparent-proxy-on-raspberry-pi/)
- [Clash的Github官方网站](https://github.com/Dreamacro/clash)
- [在树莓派上搭建软路由](https://blog.nicesite.win/2017/08/16/soft-router/)
- [使用PVE运行Clash旁路由虚拟机实现透明代理](https://blog.serenader.me/shi-yong-pve-yun-xing-clash-pang-lu-you-xu-ni-ji-shi-xian-tou-ming-dai-li)
- [V2ray的主流客户端](https://tlanyan.me/v2ray-clients-download/)
- [Clash的配置文件示例](https://www.v2rayssr.com/clashxx.html)
- [Clash的配置文件示例2](https://lancellc.gitbook.io/clash/clash-config-file/an-example-configuration-file)
- [树莓派搭建简略WiFi无线路由器](https://www.joxrays.com/raspberry-wifi-router/)
- [iptables的命令解释](https://lesca.me/archives/iptables-nat-mangle-clear-rules.html)
- [IPv4的保留IP地址定义](https://zh.wikipedia.org/wiki/%E4%BF%9D%E7%95%99IP%E5%9C%B0%E5%9D%80)
