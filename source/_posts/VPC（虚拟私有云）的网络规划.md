---
title: VPC（虚拟私有云）的网络规划
date: 2021-06-26 23:07:16
tags:
---

虚拟私有云（Virtual Private Cloud，以下简称VPC，有的厂商也称为`私有网络`），是一个**用户自定义的**、**逻辑隔离**的虚拟网络环境，以提升用户云上资源的安全性，并满足不同的应用场景需求。

您可以在VPC中定义安全组、VPN、IP地址段、带宽等网络特性。用户可以通过VPC方便地管理、配置内部网络，进行安全、快捷的网络变更。同时，用户可以自定义安全组内与组间弹性云服务器的访问规则，加强弹性云服务器的安全保护。

VPC的基本框架如下图：

{% asset_img vpc-infra.png 典型 %}

## VPC的核心组件

VPC有几个核心组成部分：私有网络网段、子网、路由表、接入控制列表、安全组。

### CIDR - 私有网络网段

用户在创建私有网络时，需要用 `CIDR`（无类别域间路由） 作为私有网络指定 IP 地址组。
私有网络`CIDR`支持使用如下私有网段中的任意一个：

- 10.0.0.0 - 10.255.255.255（掩码范围需在16 - 28之间）
- 172.16.0.0 - 172.31.255.255（掩码范围需在16 - 28之间）
- 192.168.0.0 - 192.168.255.255 （掩码范围需在16 - 28之间）

### Subnet - 子网

一个私有网络由至少一个子网组成，私有网络中的所有云资源（如云服务器、云数据库等）都必须部署在子网内，子网的 CIDR 必须在私有网络的 CIDR 内。

私有网络具有 地域（Region） 属性（如广州），而子网具有 可用区（Zone） 属性（如广州一区），您可以为私有网络划分一个或多个子网。
> - 同一VPC下，不同Subnet**默认内网互通**
> - 不同VPC之间，无论是否在同一地域，均**默认内网隔离**，但可通过创建**对等连接**实现互联互通

### Router - 路由表

路由表由一系列路由规则组成，用于控制虚拟私有云内子网的出流量走向。

VPC中的每个子网都必须关联一个路由表，一个子网一次只能关联一个路由表，但一个路由表可以关联多个子网。
> 用户创建私有网络时，系统会自动为其生成一个默认路由表，以保证同一个私有网络下的所有子网互通。
当然，您也可以创建自定义路由表。

### ACL（Access Control List） - 接入控制列表

网络 ACL 是一个子网级别的、无状态的包过滤虚拟防火墙，用于控制进出子网的数据流，可以精确到协议和端口粒度。

实际上，ACL的本质就是用于描述一个IP数据包、以太网数据帧若干特征的集合。然后根据这些集合去匹配网络中的流量，根据策略来“允许”或者“禁止”。

### Secruity Group - 安全组

安全组是一种有状态的包过滤虚拟防火墙，用于控制实例级别的出入流量，为同一个VPC内具有相同安全保护需求并相互信任的云服务器提供访问策略。

系统为每个用户默认创建一个安全组，默认安全组的规则是在出方向上的数据报文全部放行，入方向访问受限，安全组内的云服务器无需添加规则即可互相访问。


{% asset_img vpc-map.png %}

{% asset_img vpc-desktop.png %}

## VPC的网络规划

---

## 附录：网络防火墙 VS 安全组

防火墙主要是做南北向的访问控制，作用范围是VPC及其子网；安全组主要是做东西向的访问控制，作用范围是虚拟机网卡。

> 从流量的角度来看，VPC访问路径依次是：
外部网络 --> VPC路由器 --> 所在子网的ACL过滤--> 虚拟机网卡的安全组过滤 --> 业务应用

{% asset_img vs.png %}

### ACL的工作方式

- 防火墙作用在VPC路由器上，属于集中式的VPC边缘设备，为整个VPC提供访问控制。防火墙的配置是动态生效的，即时的配置会马上作用到VPC路由器接口；
- 数据包进入防火墙时，根据规则集的规则优先级进行逐条匹配，如果匹配上了，则执行规则的行为；如果没有匹配上，则执行规则集的默认行为。
- 防火墙可以针对不同报文状态来进行过滤，如new、established、invalid、related；也可以针对常见的协议，如TCP、UDP、VRRP、ICMP等。同时，如果协议是TCP或者ICMP，防火墙提供了更加细粒度的过滤规则，能够针对ICMP的类型、TCP的flag进行匹配，进一步细化策略，满足更多的使用场景。

### 安全组的工作方式

- 安全组作用于虚拟机的虚拟网卡上，给虚拟机提供三层网络的访问控制，支持入方向、出方向的过滤；
- 安全组是一个分布式的访问控制，可以对TCP/UDP/ICMP等协议进行有效过滤；也可以直接匹配所有协议；可以根据数据包的源IP进行过滤。

### 小结

从安全的角度来看，在离威胁源更近的地方进行防护是更好的方式。
一般来说，南北向交给防火墙来做，安全组作为防火墙的补充，是云主机安全的最后防线。
安全组和防火墙是相辅相成的，两者有机结合，才能够更好的做云主机的安全防护。

| 对比项 | 安全组 | 网络ACL |
|:---:|:---:|:---:|
|流量控制|云服务器、数据库等实例级别的流量访问控制|子网级别的流量控制|
|规则|支持允许规则、拒绝规则|支持允许规则、拒绝规则|
|有无状态|有状态：返回数据流会被自动允许，不受任何规则的影响|无状态：返回数据流必须被规则明确允许|
|生效时间|只有在创建云服务器、云数据库等实例时指定安全组，或实例创建后再关联安全组，规则才会被应用到实例|创建 ACL 并绑定子网后，ACL 将自动应用到关联子网内的所有云服务器、云数据库等实例|
|规则优先级|有规则冲突时，默认应用位置更前的规则|有规则冲突时，默认应用位置更前的规则|

---

## 参考文献

- [华为云的网络规划介绍](https://support.huaweicloud.com/eu-west-0-usermanual-vpc/vpc_0001.html)
- [AWS VPC网络部署参考](http://www.coding-daddy.com/other/aws-deploy.html#_1-vpc%E5%AE%9A%E4%B9%89)
- [Azure Bastion 堡垒机的介绍](https://blog.csdn.net/qq_24550639/article/details/109202811)
- [UCloud云平台的VPC部署案例](https://zhuanlan.zhihu.com/p/35130978?ivk_sa=1024320u)
- [安全组和云防火墙的区别 ](https://zhuanlan.zhihu.com/p/86734727)

- [使用Cloud Native的服务治理替换Spring Cloud](https://xie.infoq.cn/article/8062a35d680349a5ca364e36f)