---
title: NFC核心技术概览
date: 2020-12-30 17:20:41
tags:
---

## NFC简介

NFC(近场通信，Near Field Communication）是一种短距高频的无线电技术，由非接触式射频识别(RFID)演变而来。
NFC工作频率为13.56Hz，通常只有在距离不超过4厘米时才能启动连接，其传输速度有106 Kbit/秒、212 Kbit/秒或者424 Kbit/秒三种。
NFC有3种工作模式：读卡器模式、点对点模式、卡模拟模式。

- 读取器/写入器模式（Reader/writer mode）：NFC设备产生射频场从外部采用相同标准的NFC标签中读写数据，支持 NFC 设备读取和/或写入被动 NFC 标签和贴纸。
- 点对点模式（P2P mode）：支持 NFC 设备与其他 NFC 对等设备交换数据，Android Beam 使用的就是此操作模式。
- 卡模拟模式（Card emulation mode）：读卡器是主动设备，产生射频场；NFC设备为被动设备，模拟一张符合NFC标准的非接触式卡片与读卡器进行交互。

{% asset_img 3.png NFC的三种工作模式 %}

## 基于Android的NFC终端

Android 4.4版本开始，通过HCE(host-based card emulation，基于主机的卡模拟)，方式提供NFC功能支持。

NFC终端主要包括非接触性前端CLF(也叫NFC控制器)、天线(Antenna)、安全模块(Secure Element,SE)三个主要部件，其中，非接前端、天线一般都集成在手机终端中，而安全模块可根据情况存放在不同的位置。

{% asset_img 2.jpg 典型的NFC终端架构 %}

- CLF：非接触性前端，也称为NFC控制器，其功能包括射频信号的调制解调，非接触通信的协议处理。
    非接触前端一方面连接射频天线，实现13.56MHz信号的发送与接收，另一方面与安全模块通信。在CLF中提供了识读接口、P2P接口、卡模拟接口，分别对应上面所说的三种工作模式。
- 天线，通常集成在终端内部，与非接前端相连，实现13.56MHz射频信号的发送与接收。
- 安全模块SE，主要功能是实现应用和数据的安全存储，对外提供安全运算服务，它是卡模拟的核心。
    安全模块还通过非接前端与外部读写设备进行通信，实现数据存储及交易过程的安全性。

根据安全模块存放的位置不同，NFC可分为不同的实现方案。

### 基于硬件的虚拟卡模式(Virtual Card Mode)

在虚拟卡模式下，需要提供安全模块SE(Secure Elemen)，SE提供对敏感信息的安全存储和对交易事务提供一个安全的执行环境。NFC芯片作为非接触通讯前端，将从外部读写器接收到的命令转发到SE，然后由SE处理，并通过NFC控制器回复。

{% asset_img SE.png 基于安全芯片SE的方式 %}

### 基于软件的主机卡模式(Host Card Mode)

在主机卡模式下，不需要提供SE，而是由在手机中运行的一个应用或云端的服务器完成SE的功能，此时NFC芯片接收到的数据由操作系统或发送至手机中的应用，或通过移动网络发送至云端的服务器来完成交互。两种方式的特点都是绕过了手机内置的SE的限制。

{% asset_img HCE.png 基于主机的模拟卡方式 %}

### 双模（Dual Mode）

{% asset_img dual-mode.png 双模方式 %}

### 对比分析
{% asset_img hce-se.png 对比分析 %}

## HCE的协议栈

为支持NFC射频卡，HCE主要实现了两个ISO协议，分别是硬件标准`ISO/IEC 14443`和应用协议`ISO/IEC 7816`。

{% asset_img protocol-stack.png NFC的核心协议栈 %}
### ISO/IEC 14443 

Android 4.4 支持基于`NFC-Forum ISO-DEP`规范（基于`ISO/IEC 14443-4`）的模拟卡，要求仅使用 Nfc-A (`ISO/IEC 14443-3 Type A`) 技术模拟 ISO-DEP，但也可以支持 Nfc-B (`ISO/IEC 14443-4 Type B`) 技术。

该标准包含四个部分：

- `ISO/IEC14443-1`:制定了有关非接触卡的物理特性；
- `ISO/IEC14443-2`:制定了有关射频功率及信号界面的特性；
- `ISO/IEC14443-3`:则为非接触卡的初始化及防冲突机制；
- `ISO/IEC14443-4`:位有关的交易协定。

ISO/IEC14443-3 定义了 TYPEA、TYPEB 两种卡型，均通过13.56Mhz的射频载波传送信号。
其主要的区别在于信号发送的载波调制深度、二进制数编码方式存在差异。
此外，防冲突机制的原理也完全不同，前者是基于 BIT 冲突检测协议，后者则是通过字节、帧及命令完成防冲突。

### ISO/IEC 7816

Android处理应用协议数据单元 (APDU)遵循的是`ISO/IEC 7816-4`规范。

Android系统上的HCE技术是通过系统服务实现的(HCE服务)。使用服务的一大优势是它可以一直在后台运行而不需要有用户界面。这个特点就使得HCE技术非常适合像会员卡、交通卡、门禁卡这类的交易，当用户使用时无需打开程序，只需要将手机放到NFC读卡器的识别范围内，交易就会在后台进行。当然如果有必要的话，用户也可以打开UI界面。这时的手机和普通的智能卡片已经没有区别了。

#### 服务选择AID

交易中我们有一个重要问题需要解决，当用户将手机放到NFC读卡器的识别范围时,Android系统需要知道读卡器真正想要和哪个HCE服务交互，这样它才能将接收到的数据发送至相应的服务。ISO/IEC 7816-4规范正是解决服务选择的问题，它定义了一种通过应用程序ID(AID)来选择相应服务的方法。

一个AID占16位，如果手机模拟的是一个已经存在的NFC读卡设施，那么这些NFC读卡设施会去寻找那些经公共注册而广为人知的AID(类似于端口号)。像Visa卡和万事达卡等这些智能卡可以注册 AID号作为他们专用的识别标志。反之，如果要为自己的新的读卡设施部署NFC应用，你就需要注册自己的AID。AID注册过程在ISO/IEC 7816-5规格中定义，为防止和其他的Android程序冲突，Google建议AID号按此规格中推荐的注册。

当用户将设备接近 NFC 读写器时，Android 系统需要知道 NFC 读写器实际上想要与哪个 HCE 服务对话。这就是`ISO/IEC 7816-4`规范的来源：它定义了一种以应用程序 ID（AID）为中心的选择应用程序的方法。

AID 由 16 个字节组成。如果您正在为现有的 NFC 读写器基础设施模拟卡片，这些读者正在寻找的 AID 通常是众所周知的和公开注册的（例如，支付网络的 AID，如 Visa 和 MasterCard）。

如果您想为自己的应用程序部署新的读取器基础设施，则需要注册您自己的 AID。AID 的注册过程在`ISO/IEC 7816-5`规范中定义。谷歌建议，如果您正在为 Android 部署 HCE 应用程序，可以按照 7816-5 注册一个 AID，它可避免与其他应用程序发生冲突。

#### AID组
在某些情况下，HCE 服务可能需要注册多个 AID 才能实现某个应用程序，并且需要确保它是所有这些 AID 的默认处理程序（与另一服务的组中的某些 AID 相反）。

AID 组是一系列被视为属于共同的操作系统 AID 。对于一个 AID 组中的 AID，Android 可以保证以下一项：

组中的所有 AID 都被路由至此 HCE 服务。
组中没有任何 AID 被路由至此 HCE 服务（例如，服务请求组中的一个或多个 AID，而用户优先选择另一服务）。
换句话说，不存在中间状态，其中该组中的一些 AID 可以被路由到一个 HCE 服务，而另一些可以路由到另一个 HCE 服务。

#### AID组和类别
每个 AID 组都与一个类别关联。这使得 Android 可以按类别将 HCE 服务分组，并且反过来允许用户在类别级别上设置默认值而不是 AID 级别。通常，避免在应用程序中任何面向用户的部分中提到 AID：它们对普通用户没有任何意义。

Android 4.4 支持两种类别：`CATEGORY_PAYMENT`（覆盖行业标准支付应用）和`CATEGORY_OTHER`（对应于所有其它 HCE 应用）。

注意：在任何给定时间，在系统中只能启用CATEGORY_PAYMENT类别中的一个 AID 组。通常，这将是一个应用程序，了解主要的信用卡支付协议，可以在任何商家工作。

对于仅在一个商家（例如储值卡）工作的闭环支付应用，您应该使用CATEGORY_OTHER。该类别中的 AID 组可以总是活动的，并且在必要时可以在 AID 选择期间由 NFC 读写器给予优先级。

---

## 参考资料

- [Android的NFC官方文档](https://developer.android.com/guide/topics/connectivity/nfc/hce?hl=zh-cn)
- [关于HCE的NFC支付研究报告及其安全性探讨](http://www.jiajuhf.com/zxxw_8/42705634.html)
- [基于主机的卡模拟概览](http://article.iotxfd.cn/RFID/Host-based%20card%20emulation)
- [HCE基础知识普及](https://blog.csdn.net/wwww1988600/article/details/69523369)
- [NFC之 Type A 与 TYpe B 卡区别](https://blog.csdn.net/liwei16611/article/details/85209361)
