<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"nokiam9.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.27.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.json","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false,"trigger":"auto"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="Transformer 架构于 2017 年在 Attention Is All You Need 论文中提出，因其具有能够有效捕捉长距离的依赖关系的能力，迅速成为自然语言处理（LLM）和计算机视觉（CV）任务的标准架构。  文字数字化、位置向量化、语义关系化、预测概率化 多头注意力机制，就是能力更强的 CNN，其中词向量的维度就是 CNN 的通道，多头对应的就是卷积核 词向量采用了绝对位置的编码">
<meta property="og:type" content="article">
<meta property="og:title" content="大模型学习笔记之六：Transformer">
<meta property="og:url" content="https://nokiam9.github.io/2024/08/05/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%85%AD%EF%BC%9ATransformer/index.html">
<meta property="og:site_name" content="Alex的技术博客">
<meta property="og:description" content="Transformer 架构于 2017 年在 Attention Is All You Need 论文中提出，因其具有能够有效捕捉长距离的依赖关系的能力，迅速成为自然语言处理（LLM）和计算机视觉（CV）任务的标准架构。  文字数字化、位置向量化、语义关系化、预测概率化 多头注意力机制，就是能力更强的 CNN，其中词向量的维度就是 CNN 的通道，多头对应的就是卷积核 词向量采用了绝对位置的编码">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://nokiam9.github.io/2024/08/05/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%85%AD%EF%BC%9ATransformer/transformer-c.png">
<meta property="og:image" content="https://nokiam9.github.io/2024/08/05/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%85%AD%EF%BC%9ATransformer/PE.png">
<meta property="og:image" content="https://nokiam9.github.io/2024/08/05/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%85%AD%EF%BC%9ATransformer/attention.png">
<meta property="og:image" content="https://nokiam9.github.io/2024/08/05/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%85%AD%EF%BC%9ATransformer/attention-2.png">
<meta property="og:image" content="https://nokiam9.github.io/2024/08/05/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%85%AD%EF%BC%9ATransformer/qkv-2.png">
<meta property="og:image" content="https://nokiam9.github.io/2024/08/05/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%85%AD%EF%BC%9ATransformer/attention-3.png">
<meta property="og:image" content="https://nokiam9.github.io/2024/08/05/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%85%AD%EF%BC%9ATransformer/MQA.png">
<meta property="og:image" content="https://nokiam9.github.io/2024/08/05/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%85%AD%EF%BC%9ATransformer/arch.jpg">
<meta property="og:image" content="https://nokiam9.github.io/2024/08/05/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%85%AD%EF%BC%9ATransformer/gpt3-2.png">
<meta property="og:image" content="https://nokiam9.github.io/2024/08/05/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%85%AD%EF%BC%9ATransformer/gpt3.png">
<meta property="og:image" content="https://nokiam9.github.io/2024/08/05/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%85%AD%EF%BC%9ATransformer/resnet0.png">
<meta property="og:image" content="https://nokiam9.github.io/2024/08/05/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%85%AD%EF%BC%9ATransformer/resnet.png">
<meta property="article:published_time" content="2024-08-05T05:32:20.000Z">
<meta property="article:modified_time" content="2026-02-23T08:34:16.168Z">
<meta property="article:author" content="Alex Sun">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://nokiam9.github.io/2024/08/05/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%85%AD%EF%BC%9ATransformer/transformer-c.png">


<link rel="canonical" href="https://nokiam9.github.io/2024/08/05/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%85%AD%EF%BC%9ATransformer/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://nokiam9.github.io/2024/08/05/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%85%AD%EF%BC%9ATransformer/","path":"2024/08/05/大模型学习笔记之六：Transformer/","title":"大模型学习笔记之六：Transformer"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>大模型学习笔记之六：Transformer | Alex的技术博客</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script><script src="/js/bookmark.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.5.0/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>

  <script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"https://cdnjs.cloudflare.com/ajax/libs/pdfobject/2.3.1/pdfobject.min.js","integrity":"sha256-jI72I8ZLVflVOisZIOaLvRew3tyvzeu6aZXFm7P7dEo="},"url":"/lib/pdf/web/viewer.html"}</script>
  <script src="/js/third-party/tags/pdf.js" defer></script>

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.10.1/mermaid.min.js","integrity":"sha256-BmQmdWDS8X2OTbrwELWK366LV6escyWhHHe0XCTU/Hk="}}</script>
  <script src="/js/third-party/tags/mermaid.js" defer></script>





  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js" defer></script>



  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Alex的技术博客</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E6%A6%82%E8%BF%B0"><span class="nav-text">一、概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81Position-Embedding-%E4%BD%8D%E7%BD%AE%E5%B5%8C%E5%85%A5"><span class="nav-text">二、Position Embedding - 位置嵌入</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81Multi-Head-Attention-%E5%A4%9A%E5%A4%B4%E6%B3%A8%E6%84%8F%E5%8A%9B"><span class="nav-text">三、Multi-Head Attention - 多头注意力</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%95%B0%E5%AD%A6%E5%AE%9A%E4%B9%89"><span class="nav-text">1. 数学定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0"><span class="nav-text">2. 具体实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E7%89%A9%E7%90%86%E6%84%8F%E4%B9%89"><span class="nav-text">3. 物理意义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E5%90%8E%E7%BB%AD%E6%94%B9%E8%BF%9B"><span class="nav-text">4. 后续改进</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E3%80%81Feed-Forward-Network-%E5%89%8D%E9%A6%88%E7%BD%91%E7%BB%9C"><span class="nav-text">四、Feed Forward Network - 前馈网络</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E5%85%B6%E4%BB%96%E7%BB%84%E4%BB%B6"><span class="nav-text">五、其他组件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E8%A7%84%E8%8C%83%E5%8C%96%E7%BB%84%E4%BB%B6"><span class="nav-text">2. 规范化组件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%AE%8B%E5%B7%AE%E8%BF%9E%E6%8E%A5%E7%BB%84%E4%BB%B6"><span class="nav-text">3. 残差连接组件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%99%84%E5%BD%95%E4%B8%80%EF%BC%9AGemma-7B-%E5%AF%B9%E6%AF%94%E5%88%86%E6%9E%90"><span class="nav-text">附录一：Gemma 7B 对比分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81GPT-3-%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%8F%82%E6%95%B0%E6%9E%84%E6%88%90%E5%88%86%E6%9E%90"><span class="nav-text">三、GPT-3 模型的参数构成分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Word-Embedding-Matrix%EF%BC%88%EF%BC%89"><span class="nav-text">1. Word Embedding Matrix（）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-QKV-%E7%9F%A9%E9%98%B5"><span class="nav-text">2. QKV 矩阵</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Feed-Forward"><span class="nav-text">3. Feed Forward</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%99%84%E5%BD%95%E4%B8%80%EF%BC%9A%E6%AE%8B%E5%B7%AE%E7%BD%91%E7%BB%9C%EF%BC%88ResNet%EF%BC%89"><span class="nav-text">附录一：残差网络（ResNet）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="nav-text">参考文献</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%86%E9%A2%91%E6%95%99%E6%9D%90"><span class="nav-text">视频教材</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%80%E6%9C%AF%E8%A7%A3%E8%AF%BB"><span class="nav-text">技术解读</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3"><span class="nav-text">官方文档</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%80%E6%9C%AF%E8%A7%A3%E8%AF%BB2"><span class="nav-text">技术解读2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LLAMA-%E8%A7%A3%E8%AF%BB"><span class="nav-text">LLAMA 解读</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Alex Sun</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">115</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://nokiam9.github.io/2024/08/05/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%85%AD%EF%BC%9ATransformer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Alex Sun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Alex的技术博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="大模型学习笔记之六：Transformer | Alex的技术博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          大模型学习笔记之六：Transformer
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-08-05 13:32:20" itemprop="dateCreated datePublished" datetime="2024-08-05T13:32:20+08:00">2024-08-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2026-02-23 16:34:16" itemprop="dateModified" datetime="2026-02-23T16:34:16+08:00">2026-02-23</time>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>4.8k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>17 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>Transformer 架构于 2017 年在 <a target="_blank" rel="noopener" href="https://arxiv.org/pdf/1706.03762">Attention Is All You Need</a> 论文中提出，因其具有能够有效捕捉长距离的依赖关系的能力，迅速成为自然语言处理（LLM）和计算机视觉（CV）任务的标准架构。</p>
<blockquote>
<p>文字数字化、位置向量化、语义关系化、预测概率化<br>多头注意力机制，就是能力更强的 CNN，其中词向量的维度就是 CNN 的通道，多头对应的就是卷积核<br>词向量采用了<strong>绝对</strong>位置的编码信息（基于加法进行矩阵修饰），而注意力机制采用了<strong>相对位置</strong>的编码信息<br>最后的 Liner 就是对前面的词向量进行一个线性运算，训练时变换称为计算损失值的形式，推理时变换为独热编码，以判断哪个 Token 的概率最大</p>
</blockquote>
<p>位置编码的要求：</p>
<ul>
<li>每个单词的TOken都能包含它的位置信息</li>
<li>模型可以看到文字之间的距离</li>
<li>模型可看懂并学习到位置编码的规则</li>
</ul>
<p>QKV就是在token原有客观语义的基础上，增加 context 代表的主观语义（嵌入向量，word embedding）进行修正，例如校准多义词的具体含义<br>WQ、WK、WV是增加了一些参数，如果没有他们，就是$XX^TT$ 也是可以表达自注意力，但是表达能力弱一点<br>单头QKV情况下，WV是一个（dmodel，dmodel）的矩阵，为了减少数据量 ，可以将其转化为（dmode，x）乘以（x，dmodl），即降秩+升秩；在多头情况下，WV是 nhead 个（dmodel，dhead&#x3D;dmodel&#x2F;nhead）的矩阵，然后连接起来与WO（dhead，dmodel）相乘，最终得到输出矩阵（ctx-lenght，dmodel）。上述两个方法在数学上是等价的。</p>
<h2 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h2><p>Transformer 总体架构可分为四个部分：输入、输出、编码器、解码器。</p>
<p><img src="/2024/08/05/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%85%AD%EF%BC%9ATransformer/transformer-c.png" alt="tr"></p>
<ol>
<li>输入部分：<ul>
<li>源文本嵌入层（Inputs Embedding），及其位置编码器（Positional Encoding）</li>
<li>目标文本嵌入层（Outputs Embedding），及其位置编码器（Positional Encoding）</li>
</ul>
</li>
<li>输出部分:<ul>
<li>线性层</li>
<li>softmax层</li>
</ul>
</li>
<li>编码器部分：<ul>
<li>由 N 个编码器层堆叠而成，每个编码器层由 2 个<strong>子层</strong>连接结构组成</li>
<li>第一个子层连接结构包括：一个多头自注意力子层，规范化层，一个残差连接</li>
<li>第二个子层连接结构包括：一个前馈全连接子层，规范化层，一个残差连接</li>
</ul>
</li>
<li>解码器部分:<ul>
<li>由 N 个解码器层堆叠而成，每个解码器层由 3 个<strong>子层</strong>连接结构组成</li>
<li>第一个子层连接结构包括：一个<strong>Masked</strong>多头自注意力子层，规范化层，一个残差连接</li>
<li>第二个子层连接结构包括：一个多头注意力子层（<strong>不是自注意力</strong>），规范化层，一个残差连接</li>
<li>第三个子层连接结构包括：一个前馈全连接子层，规范化层，一个残差连接</li>
</ul>
</li>
</ol>
<p>尽管存在许多堆叠的技术组件，但基本构成就是几种：文本嵌入组件+位置编码器、多头注意力组件、前馈全连接组件、残差组件、规范化组件。</p>
<h2 id="二、Position-Embedding-位置嵌入"><a href="#二、Position-Embedding-位置嵌入" class="headerlink" title="二、Position Embedding - 位置嵌入"></a>二、Position Embedding - 位置嵌入</h2><p>对于 Inputs 和 Outputs 的输入序列来说，仅仅完成词向量的 tokenlized 是不够的（例如“温州的气温是多少度”，两个“温”字的词向量完全相同，但其实际含义完全不同），因此我们需要为词向量添加位置信息。</p>
<p>一般来说，位置编码与嵌入具有相同的维数模型，Transformer 建议采用“矩阵加法”实现，数值则使用了不同频率的正弦和余弦函数，数学表示为：</p>
<p>$$ \begin{align*}<br>    PE_{(pos,2i)} &amp;&#x3D; sin(pos&#x2F;10000^{2i&#x2F;d_{model}}) \\<br>    PE_{(pos,2i+1)} &amp;&#x3D; cos(pos&#x2F;10000^{2i&#x2F;d_{model}})<br>    \end{align*}<br>$$<br>其中，$pos$ 定义了位置，$i$ 定义了维度。</p>
<p><img src="/2024/08/05/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%85%AD%EF%BC%9ATransformer/PE.png" alt="PE"></p>
<h2 id="三、Multi-Head-Attention-多头注意力"><a href="#三、Multi-Head-Attention-多头注意力" class="headerlink" title="三、Multi-Head Attention - 多头注意力"></a>三、Multi-Head Attention - 多头注意力</h2><p>在传统的循环神经网络（RNN）和长短期记忆网络（LSTM）中，处理长距离依赖可能非常困难，因为信息需要通过许多时间步长传递。自注意力机制可以直接捕捉序列中任意两个位置之间的依赖关系，无论它们之间的距离有多远，因此成为 Transformer 最关键的技术改进点！！！</p>
<h3 id="1-数学定义"><a href="#1-数学定义" class="headerlink" title="1. 数学定义"></a>1. 数学定义</h3><p><img src="/2024/08/05/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%85%AD%EF%BC%9ATransformer/attention.png" alt="attention"></p>
<p>最基础的注意力结构是 Scaled Dot-Product Attention（缩放点积注意力，即单头注意力），数学表达为：<br>$$Attention(Q,K,V) &#x3D; softmax(\frac {QK^T}{\sqrt {d_k}})V$$</p>
<p>其中：$\sqrt {d_k}$ 代表了 Scale（缩放），Softmax 就是概率的归一化，此外有可能需要采用 Mask（掩码）。</p>
<p>Multi-Head Attention（多头注意力）是 Scaled Dot-Product Attention 的扩展，数学表达为：<br><img src="/2024/08/05/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%85%AD%EF%BC%9ATransformer/attention-2.png" alt="multi"></p>
<p>相比单头注意力机制，多头注意力机制（Multi-Head Attention）具有以下优势：</p>
<ul>
<li>多头注意力允许模型在多个不同的表示子空间（分别关注输入序列的不同方面，例如，一个头可能关注句法信息，而另一个头可能关注语义信息）中并行地捕获信息，这增加了模型的表示能力，使其能够同时学习到输入数据的多种特征。</li>
<li>多头注意力的计算是高度并行的，这使得模型可以高效地利用 GPU 进行快速训练。</li>
<li>多头注意力可以帮助模型在面对不完整或嘈杂的数据时更加鲁棒，因为不同的头可以捕捉到不同的信息，从而减少对单一特征的依赖，同时也有助于提高模型的泛化能力</li>
<li>调整头的数量可以控制模型的复杂性和容量。更多的头可以提供更细粒度的分析，但也增加了计算成本。</li>
</ul>
<h3 id="2-具体实现"><a href="#2-具体实现" class="headerlink" title="2. 具体实现"></a>2. 具体实现</h3><p>观察上面的 Transformer 结构图，可以发现 3 个不同的多头注意力子层：</p>
<ol>
<li>encoder-decoder cross-attention：模仿了机器翻译的交叉注意力机制，Query 来自于解码器的前一层，Key 和 Value 来自于编码器的输出。注意输入顺序是<strong>V、K、Q</strong>！</li>
<li>encoder self-attention：标准的自注意力机制，Q、K、V 都来自于编码器的前一层输出。</li>
<li>decoder masked self-attention：带掩码的自注意力机制，以确保解码器的 auto-regressive 自回归特性（即在生成每个位置时，只能看到它之前的位置，而不能“看到”未来的位置）。实现方法是将矩阵对角线以上部分的所有值设为 $-\infty$</li>
</ol>
<h3 id="3-物理意义"><a href="#3-物理意义" class="headerlink" title="3. 物理意义"></a>3. 物理意义</h3><p><img src="/2024/08/05/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%85%AD%EF%BC%9ATransformer/qkv-2.png" alt="交叉注意力"></p>
<ul>
<li>词向量已经提供了基于字典表的、单个 token 的<strong>客观语义</strong>，自注意力机制的目的是提供基于当前上下文的、token 之间的<strong>主观语义</strong>，并据此对输入向量进行修正。</li>
<li>与基于直线的线形变换相比，矩阵二次型实际上是基于圆锥曲线的高维变换，因此有着更强的表达能力。<br>  $$ A &#x3D; X \cdot W_Q \cdot [X \cdot W_K]^T &#x3D; X \cdot [W_Q \cdot W_K^T] \cdot X^T &#x3D; X \cdot W_A \cdot X^T $$</li>
<li>Q 表示查询向量，K 表示关键字向量，V 表示值向量。可以认为，$Q$ 和 $K$ 分别负责<strong>设定语义</strong>和<strong>表达语义</strong>。</li>
</ul>
<p>换个角度看，就是：<br><img src="/2024/08/05/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%85%AD%EF%BC%9ATransformer/attention-3.png" alt="attention"></p>
<h3 id="4-后续改进"><a href="#4-后续改进" class="headerlink" title="4. 后续改进"></a>4. 后续改进</h3><p><img src="/2024/08/05/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%85%AD%EF%BC%9ATransformer/MQA.png" alt="VS"></p>
<p>MHA（Multi-head Attention）是标准的多头注意力机制，包含 H 个Query、Key 和 Value 矩阵。所有注意力头的 Key 和 Value 矩阵权重不共享。</p>
<p>MQA（Multi-Query Attention，多查询注意力）是 19 年提出的一种 Attention 机制，其能够在保证模型效果的同时加快 decoder 生成 token 的速度。MQA 是将 head 中的 key 和 value 矩阵抽出来单独存为一份共享参数，而 query 则是依旧保留在原来的 head 中，每个 head 有一份自己独有的 query 参数。</p>
<p>GQA（Grouped-Query Attentio，分组查询注意力）是一种针对 Transformer 模型中 Multi-head Attention 的改进方法，旨在提高模型的运算速度，同时保持预测质量。在标准的Multi-head Attention中，每个注意力头都是独立计算的，这导致了计算和存储需求较高。分组查询注意力通过将查询头分组，让每组共享一个键头和值头，从而减少计算和存储需求。</p>
<p>MQA 和 MHA 主要是在计算 K 和 V 的过程中有计算量的差异，由于训练阶段由于数据是并行的，这种差异整体不明显，而在推理阶段，在 memery cache的基础上，MQA 的推理速度有明显提升，同时也更省内存。</p>
<h2 id="四、Feed-Forward-Network-前馈网络"><a href="#四、Feed-Forward-Network-前馈网络" class="headerlink" title="四、Feed Forward Network - 前馈网络"></a>四、Feed Forward Network - 前馈网络</h2><p>在 Transformer 模型中，每层编码器和解码器都包含一个前馈网络（Feed-Forward Network，FFN），负责在注意力机制的基础上进一步提取特征，增加模型的表达能力。<br>$$ FFN(x) &#x3D; \max(0,xW_1+b_1)W_2+b_2$$</p>
<p>前馈网络包含两个线性变换（也称为全连接层或线性层），不同层使用不同的参数。尽管每个位置使用的线性变换形式相同，但是不同层之间的参数是不同的。这意味着每一层都有自己的权重矩阵和偏置项。<br>这种结构也可以被看作是两次具有核大小为 1 的卷积操作。这里的“卷积”是指在输入序列上应用线性滤波器，但由于核大小为1，它实际上等同于全连接层。</p>
<p>输入和输出的维度都是 $d_{model}$，中间层的维度是 $d_{ff}$（一般设定为 $d_{model}$ 的 4 倍），激活函数建议使用 ReLU。</p>
<h2 id="五、其他组件"><a href="#五、其他组件" class="headerlink" title="五、其他组件"></a>五、其他组件</h2><h3 id="2-规范化组件"><a href="#2-规范化组件" class="headerlink" title="2. 规范化组件"></a>2. 规范化组件</h3><h3 id="3-残差连接组件"><a href="#3-残差连接组件" class="headerlink" title="3. 残差连接组件"></a>3. 残差连接组件</h3><hr>
<h2 id="附录一：Gemma-7B-对比分析"><a href="#附录一：Gemma-7B-对比分析" class="headerlink" title="附录一：Gemma 7B 对比分析"></a>附录一：Gemma 7B 对比分析</h2><p>以 LLaMA-2 7B 为例，分析其配置文件</p>
<p><img src="/2024/08/05/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%85%AD%EF%BC%9ATransformer/arch.jpg" alt="arch"></p>
<p>与最近大语言模型的研究趋势一致，我们的网络也基于 Transformer 架构（Vaswani 等，2017）。 但做了很多改进，也借鉴了其他模型（例如 PaLM）中的一些技巧。</p>
<p>2.2.1 改进<br>以下是与原始架构的主要差异，</p>
<p>预归一化（Pre-normalization）：受 GPT3 启发<br>为了提高训练稳定性，我们对每个 Transformer sub-layer 的输入进行归一化，而不是对输出进行归一化。 这里使用由 Zhang 和 Sennrich（2019）提出的 RMSNorm 归一化函数。</p>
<p>SwiGLU 激活函数：受 PaLM 启发<br>用 SwiGLU 激活函数替换 ReLU 非线性，该函数由 Shazeer（2020）提出，目的是提升性能。 但我们使用的维度是 2&#x2F;3 * 4d，而不是 PaLM 中的 4d。</p>
<p>旋转嵌入（Rotary Embeddings）：受 GPTNeo 启发<br>去掉了绝对位置嵌入（absolute positional embeddings），并在每个网络层中添加旋转位置嵌入（rotary positional embeddings，RoPE）。 RoPE 由 Su 等（2021）提出。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 词汇表的大小：The number of tokens in the vocabulary.</span></span><br><span class="line">vocab_size: <span class="built_in">int</span> = <span class="number">256000</span></span><br><span class="line"><span class="comment"># The maximum sequence length that this model might ever be used with.</span></span><br><span class="line">max_position_embeddings: <span class="built_in">int</span> = <span class="number">8192</span></span><br><span class="line"><span class="comment"># 28 个隐藏层：The number of blocks in the model.</span></span><br><span class="line">num_hidden_layers: <span class="built_in">int</span> = <span class="number">28</span></span><br><span class="line"><span class="comment"># 16 个注意力 head ：The number of attention heads used in the attention layers of the model.</span></span><br><span class="line">num_attention_heads: <span class="built_in">int</span> = <span class="number">16</span></span><br><span class="line"><span class="comment"># The number of key-value heads for implementing attention.</span></span><br><span class="line">num_key_value_heads: <span class="built_in">int</span> = <span class="number">16</span></span><br><span class="line"><span class="comment"># The hidden size of the model.</span></span><br><span class="line">hidden_size: <span class="built_in">int</span> = <span class="number">3072</span></span><br><span class="line"><span class="comment"># The dimension of the MLP representations.</span></span><br><span class="line">intermediate_size: <span class="built_in">int</span> = <span class="number">24576</span></span><br><span class="line"><span class="comment"># The number of head dimensions.</span></span><br><span class="line">head_dim: <span class="built_in">int</span> = <span class="number">256</span></span><br><span class="line"><span class="comment"># The epsilon used by the rms normalization layers.</span></span><br><span class="line">rms_norm_eps: <span class="built_in">float</span> = <span class="number">1e-6</span></span><br><span class="line"><span class="comment"># The dtype of the weights.</span></span><br><span class="line">dtype: <span class="built_in">str</span> = <span class="string">&#x27;bfloat16&#x27;</span></span><br><span class="line"><span class="comment"># Whether a quantized version of the model is used.</span></span><br><span class="line">quant: <span class="built_in">bool</span> = <span class="literal">False</span></span><br><span class="line"><span class="comment"># The path to the model tokenizer.</span></span><br><span class="line">tokenizer: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="string">&#x27;tokenizer/tokenizer.model&#x27;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>词汇表的容量：256K</li>
<li>隐藏层的数量：28</li>
<li>隐藏层的维度：3072</li>
<li>自注意力 head 的数量：16</li>
</ul>
<hr>
<h2 id="三、GPT-3-模型的参数构成分析"><a href="#三、GPT-3-模型的参数构成分析" class="headerlink" title="三、GPT-3 模型的参数构成分析"></a>三、GPT-3 模型的参数构成分析</h2><p><a target="_blank" rel="noopener" href="https://github.com/openai/gpt-3">GPT-3</a> 是一个由 1750 亿个参数组成的语言模型，其 Transformer 架构仅包含解码器部分，预训练时将生成并<strong>固化</strong>所有 175B 个模型参数。<br>为了定义 GPT-3 模型的结构，其核心的超参数（无法通过训练调整的参数）包括：</p>
<ul>
<li>词向量维度：$d_{model}&#x3D;12288$，词汇表容量：$n_{vocab}&#x3D;50257$</li>
<li>解码器层数：$n_{layers}&#x3D;96$</li>
<li>注意力头数：$n_{heads}&#x3D;96$；相应得出查询向量维度：$d_k &#x3D; d_{model} \div n_{heads} &#x3D; 12288 &#x2F; 96 &#x3D;128$，而且仅有解码器部分时，$d_v&#x3D;d_k$</li>
<li>前馈神经元数量：$n_{neurons}&#x3D;49152$（经验表明，隐藏层神经元数量通常设置为输入层的 4 倍）</li>
<li>上下文长度：$n_{ctx}&#x3D;2048$</li>
<li>批次大小：Batch Size &#x3D; 3.2M</li>
<li>学习率：Learning Rate &#x3D; $0.6 \times 10^{-4}$</li>
</ul>
<p><img src="/2024/08/05/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%85%AD%EF%BC%9ATransformer/gpt3-2.png" alt="GPT-3"></p>
<p>Inputs 作为原始语言输入，例如“大模型的三个要素是”包含了 9 个 token，是一个用户输入的、长度为 $length_{ctx}$ 的向量（当然 $length_{ctx} \leqslant n_{ctx}$），后续就是其与包含大模型 175B 参数的若干个矩阵进行计算：</p>
<ol>
<li><p>1 个 $W_E(n_{vocab},d_{model})$：词向量嵌入矩阵，存储了所有词汇表及其维度信息。<br> 对用户输入进行向量化处理（Input Embedding），并嵌入位置信息（Positional Embedding）。<br> 输出一个形状为$(length_{ctx},d_{model})$ 的矩阵 $X$ 作为下一阶段的输入。</p>
</li>
<li><p>96 个多头注意力子层：包含了 96 个注意力头，每个注意力头包含 3 个矩阵</p>
<ul>
<li>$W_Q(d_{model},d_k)$：$Q&#x3D;XW_Q$</li>
<li>$W_K(d_{model},d_k)$：$K&#x3D;XW_K$，<br> 计算自注意力矩阵$A(length_{ctx},length_{ctx}) &#x3D; QK^T$，softmax 归一化处理得到$A’$</li>
<li>$W_V(d_{model},d_v)$：也称 Value Down 矩阵，$V&#x3D;XW_V$<br> 对于每个单头，分别计算 $O(length_{ctx}，d_v)&#x3D;A’V$</li>
</ul>
<p> 最后，$W_O(d_{model},d_{model})$：也称 Value UP 矩阵，目的是还原为 $d_{model}$ 维度<br> 把全部单头拼接起来形成$O’$，然后计算 $O’W_O$ 得到 $X’(length_{ctx}，d_{model})$</p>
</li>
<li><p>96 个前馈全联接子层：包含了 2 次线性变换，即图中的 <strong>Wff</strong></p>
<ul>
<li>$W_{Up}(d_{model},n_{neurons})$：$Up&#x3D;XW_{Up}$，维度从 $d_{model}$ 提升到 $d_{neurons}$</li>
<li>$W_{Down}(n_{neurons},d_{model})$：$X’’&#x3D;Down&#x3D;UpW_{Down}$，维度从 $d_{neurons}$ 还原到 $d_{model}$</li>
</ul>
</li>
<li><p>1 个Unembedding Matrix $(n_{model},d_{vocab})$：即图中的 <strong>Wp&#x2F;WU</strong>，与WE相似，但是行列顺序相反，目的是基于词向量维度，线性变换为词汇表，然后 Softmax 计算出每个词的概率，并选择概率最大的单词作为输出。</p>
</li>
</ol>
<blockquote>
<p>对于每一个可能的输出特征，在词典中对应的每一个文字，都有一个dmodel维度的权重向量</p>
</blockquote>
<p>汇总参数数量如下图，其中前馈全联接子层占比66%，自注意力子层占比33%，词汇表不足1%。<br><img src="/2024/08/05/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%85%AD%EF%BC%9ATransformer/gpt3.png" alt="GPT-3"></p>
<h3 id="1-Word-Embedding-Matrix（）"><a href="#1-Word-Embedding-Matrix（）" class="headerlink" title="1. Word Embedding Matrix（）"></a>1. Word Embedding Matrix（）</h3><h3 id="2-QKV-矩阵"><a href="#2-QKV-矩阵" class="headerlink" title="2. QKV 矩阵"></a>2. QKV 矩阵</h3><h3 id="3-Feed-Forward"><a href="#3-Feed-Forward" class="headerlink" title="3. Feed Forward"></a>3. Feed Forward</h3><p>输入数据为：</p>
<ul>
<li>$T_1$：基准输入数据，形状为 $(length_{ctx1}, d_{model})$</li>
<li>$T_2$：对照输入数据，形状为 $(length_{ctx2}, d_{model})$</li>
<li>如果是自注意力机制，则 $T_2&#x3D;T_1$</li>
</ul>
<p>注意力机制的层数是 $n_{layers}$，如果是单头注意力机制：</p>
<ul>
<li>1 个 $W_q$：Query 权重矩阵，形状为$(length_{ctx1}, d_{model})$</li>
<li>1 个 $W_k$：Key 权重矩阵，形状为$(length_{ctx2},  d_{model})$</li>
<li>1 个 $W_v$：Value 权重矩阵，形状为$(length_{ctx2}, d_{model})$</li>
<li>中间结果 $A$ 的形状为 $(length_{ctx1}, length_{ctx2})$</li>
</ul>
<blockquote>
<p>TODO: 3Blue1Brown 视频视频中说 Value 是 12288 * 12288 的矩阵，分解为 12288 * 128 乘以 128 * 12288 的矩阵乘法，参数分别是 value 和 output，与我的理解有差异！！！</p>
</blockquote>
<p>如果是多头注意力机制，则有$d_{head} &#x3D; d_{model} \div n_{heads}$（也称为 d_query），相应的：</p>
<ul>
<li>$n_{heads}$ 个 $W_q$：Query 权重矩阵，形状为$(length_{ctx1}, d_{head})$</li>
<li>$n_{heads}$ 个 $W_k$：Key 权重矩阵，形状为$(length_{ctx2},  d_{head})$</li>
<li>$n_{heads}$ 个 $W_v$：Value 权重矩阵，形状为$(length_{ctx2}, d_{head})$</li>
</ul>
<p>输出数据的形状为 $(length_{ctx1}, d_{model})$，也就是与输入数据的形状完全系统。</p>
<p>GPT-3 的前馈全联接子层包含 2 个串联的线性组件，分别是 Up-projection 和 Down—projection，主要参数是：</p>
<ul>
<li>Up-projection：输出数据的形状为 $(length_{ctx1}, d_{model})$，包含 $n_{neurons}$ 个神经元，输出数据的形状为 $(length_{ctx1}, n_{neurons})$</li>
<li>Down—projection：输入就是 Up-projection 的输出，包含 $d_{model}$ 个神经元，输出数据的形状为 $(length_{ctx1}, d_{model})$</li>
</ul>
<hr>
<h2 id="附录一：残差网络（ResNet）"><a href="#附录一：残差网络（ResNet）" class="headerlink" title="附录一：残差网络（ResNet）"></a>附录一：残差网络（ResNet）</h2><p>Residual Network（残差网络，ResNet）是一种深度卷积神经网络（CNN）架构，由 Kaiming He（何凯明）在 2015 年提出，核心思想是通过引入“残差学习”（residual learning）来解决深度神经网络训练中的退化问题（degradation problem）。</p>
<p>在传统的深度神经网络中，随着网络层数的增加，理论上网络的表示能力应该更强，但实际上，过深的网络往往难以训练，性能反而不如层数较少的网络。这种现象被称为“退化问题”，即随着网络深度的增加，网络的准确率不再提升，甚至下降。<br><img src="/2024/08/05/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%85%AD%EF%BC%9ATransformer/resnet0.png" alt="error"></p>
<p>ResNet通过引入“跳跃连接”（skip connections）或“捷径连接”（shortcut connections）来解决这个问题。在ResNet中，输入不仅传递给当前层，还直接传递到后面的层，跳过一些中间层。这样，后面的层可以直接学习到输入与输出之间的残差（即差异），而不是学习到未处理的输入。这种设计允许网络学习到恒等映射（identity mapping），即输出与输入相同，从而使得网络可以通过更简单的路径来学习到正确的映射关系。</p>
<p><img src="/2024/08/05/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%85%AD%EF%BC%9ATransformer/resnet.png" alt="res"></p>
<p>在 Transformer 模型中，残差网络的使用主要是为了解决自注意力机制（self-attention）带来的问题。Transformer模型完全基于注意力机制，没有卷积层，但其结构本质上也是深度网络。在 Transformer 中，每个编码器（encoder）和解码器（decoder）层都包含自注意力和前馈网络，这些层的参数量非常大，网络深度也很容易变得很深。使用残差连接可以帮助Transformer模型更有效地训练深层网络。在 Transformer 的自注意力层中，输入通过自注意力和前馈网络后，与原始输入相加，形成残差连接。这种设计使得网络即使在增加更多层数时，也能保持较好的性能，避免了退化问题。</p>
<p>参考<a target="_blank" rel="noopener" href="https://zh.d2l.ai/chapter_convolutional-modern/resnet.html">https://zh.d2l.ai/chapter_convolutional-modern&#x2F;resnet.html</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> torch <span class="keyword">import</span> nn</span><br><span class="line"><span class="keyword">from</span> torch.nn <span class="keyword">import</span> functional <span class="keyword">as</span> F</span><br><span class="line"><span class="keyword">from</span> d2l <span class="keyword">import</span> torch <span class="keyword">as</span> d2l</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Residual</span>(nn.Module):  <span class="comment">#@save</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, input_channels, num_channels,</span></span><br><span class="line"><span class="params">                 use_1x1conv=<span class="literal">False</span>, strides=<span class="number">1</span></span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="variable language_">self</span>.conv1 = nn.Conv2d(input_channels, num_channels,</span><br><span class="line">                               kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>, stride=strides)</span><br><span class="line">        <span class="variable language_">self</span>.conv2 = nn.Conv2d(num_channels, num_channels,</span><br><span class="line">                               kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> use_1x1conv:</span><br><span class="line">            <span class="variable language_">self</span>.conv3 = nn.Conv2d(input_channels, num_channels,</span><br><span class="line">                                   kernel_size=<span class="number">1</span>, stride=strides)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="variable language_">self</span>.conv3 = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.bn1 = nn.BatchNorm2d(num_channels)</span><br><span class="line">        <span class="variable language_">self</span>.bn2 = nn.BatchNorm2d(num_channels)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, X</span>):</span><br><span class="line">        Y = F.relu(<span class="variable language_">self</span>.bn1(<span class="variable language_">self</span>.conv1(X)))</span><br><span class="line">        Y = <span class="variable language_">self</span>.bn2(<span class="variable language_">self</span>.conv2(Y))</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.conv3:</span><br><span class="line">            X = <span class="variable language_">self</span>.conv3(X)</span><br><span class="line">        Y += X</span><br><span class="line">        <span class="keyword">return</span> F.relu(Y)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><ul>
<li><a target="_blank" rel="noopener" href="https://arxiv.org/pdf/1706.03762">Attention Is All You Need</a></li>
</ul>
<h3 id="视频教材"><a href="#视频教材" class="headerlink" title="视频教材"></a>视频教材</h3><ul>
<li><a target="_blank" rel="noopener" href="https://space.bilibili.com/88461692/channel/seriesdetail?sid=1528929">Deep Learning 合集 - 3Blue1Brown</a></li>
<li><a target="_blank" rel="noopener" href="https://space.bilibili.com/504715181/channel/collectiondetail?sid=643185">踏踏实实理解神经网络 - 王木头学科学</a></li>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1sW4y1J7cL/?spm_id_from=333.999.0.0&vd_source=735a6376f6214c7b974a1074096ba0fa">认识Transformer架构和代码实现（合集）- 浙大教授</a></li>
</ul>
<h3 id="技术解读"><a href="#技术解读" class="headerlink" title="技术解读"></a>技术解读</h3><ul>
<li><a target="_blank" rel="noopener" href="https://jalammar.github.io/illustrated-transformer/">Transformer 高级讲解 - Jay Alammar</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/7243435843145924667">想要更好地理解大模型架构？从计算参数量快速入手</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/hbuwyg/p/16978264.html">Self-Attention：Learning QKV step by step</a></li>
<li><a target="_blank" rel="noopener" href="https://ziuch.com/article/Positional-Encoding-in-Transform">Transformer中的位置编码</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_56192771/article/details/118087175">Transformer架构解析</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/huaweiyun/p/17881295.html">深入解析 LLaMA 如何改进 Transformer 的底层结构</a></li>
</ul>
<hr>
<h3 id="官方文档"><a href="#官方文档" class="headerlink" title="官方文档"></a>官方文档</h3><ul>
<li><a href="gemma-report.pdf">Gemma: Open Models Based on Gemini Research and Technology</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/google/gemma_pytorch">Gemma Pytorch - Github</a></li>
</ul>
<h3 id="技术解读2"><a href="#技术解读2" class="headerlink" title="技术解读2"></a>技术解读2</h3><ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qinduohao333/article/details/136264993">Gemma模型论文详解</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/7310061802464264242">LLM常见问题（Attention 优化部分）</a></li>
</ul>
<h3 id="LLAMA-解读"><a href="#LLAMA-解读" class="headerlink" title="LLAMA 解读"></a>LLAMA 解读</h3><ul>
<li><a href="2302.13971v1.pdf">LLaMA: Open and Efficient Foundation Language Models</a></li>
<li><a target="_blank" rel="noopener" href="https://arthurchiao.art/blog/llama-paper-zh/">上面论文的中文翻译</a></li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2024/08/04/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E4%BA%94%EF%BC%9A%E6%B3%A8%E6%84%8F%E5%8A%9B%E6%9C%BA%E5%88%B6/" rel="prev" title="大模型学习笔记之五：注意力机制">
                  <i class="fa fa-angle-left"></i> 大模型学习笔记之五：注意力机制
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2024/08/18/%E5%8C%97%E6%96%97%E5%8D%AB%E6%98%9F%E5%AF%BC%E8%88%AA%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0/" rel="next" title="北斗卫星导航系统概述">
                  北斗卫星导航系统概述 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2026</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Alex Sun</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">278k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">16:51</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/nokiam9/nokiam9.github.io.git" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
